"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var React=require("react"),imul=Math.imul,pageSize=1024,numPages=256,timeoutMessage="timeout";function murmur3_core(e){for(var t=798746316,r=516138696,n=0;n<e.length;n+=4){var a=pxt.HF2.read32(e,n)>>>0;a=imul(a,3432918353),r=(r^=a=imul(a=a<<15|a>>>17,461845907))<<13|r>>>19,t=imul(t=(t^=a)<<13|t>>>19,5)+3864292196>>>0,r=imul(r,5)+3864292196>>>0}return[t,r]}var packetIoPromise,previousDapWrapper,DAPWrapper=function(){function e(e){var t=this;this.flashing=!0,this.pbuf=new pxt.U.PromiseBuffer,this.useSerial=!0,(this.packetIo=e).onData=function(e){t.pbuf.push(e)},this.allocDAP();var a=function(){t.useSerial&&(t.flashing?setTimeout(a,300):t.cmsisdap.cmdNums(131,[]).then(function(e){for(var t=e[1],r="",n=2;n<t+2;++n)r+=String.fromCharCode(e[n]);0<r.length?(pxt.U.nextTick(a),window.postMessage({type:"serial",id:"n/a",data:r},"*")):setTimeout(a,50)},function(e){setTimeout(a,1e3)}))};a()}return e.prototype.allocDAP=function(){var e=new DapJS.DAP({write:function(e){return t.sendPacketAsync(new Uint8Array(e))},close:this.disconnectAsync,read:function(){return r.shiftAsync()}});this.cmsisdap=e.dap,this.cortexM=new DapJS.CortexM(e);var t=this.packetIo,r=this.pbuf},e.prototype.reconnectAsync=function(e){var t=this,r=Promise.resolve();return e||(r=this.packetIo.reconnectAsync().then(function(){return t.allocDAP()})),r.then(function(){return t.cortexM.init()}).then(function(){return t.cmsisdap.cmdNums(130,[0,194,1,0]).then(function(){t.useSerial=!0},function(e){t.useSerial=!1})})},e.prototype.disconnectAsync=function(){return this.packetIo.disconnectAsync()},e}();function initPacketIOAsync(){var t;return packetIoPromise?packetIoPromise.then(function(e){return(t=e).reconnectAsync()}).then(function(){return t}):packetIoPromise=pxt.HF2.mkPacketIOAsync().catch(function(e){return packetIoPromise=null,Promise.reject(e)})}function dapAsync(){return previousDapWrapper?previousDapWrapper.reconnectAsync(!1).then(function(){return previousDapWrapper}):Promise.resolve().then(function(){return previousDapWrapper?previousDapWrapper.disconnectAsync().finally(function(){previousDapWrapper=null}):Promise.resolve()}).then(function(){return initPacketIOAsync()}).then(function(e){var t=new DAPWrapper(e);return(previousDapWrapper=t).reconnectAsync(!0).then(function(){return t})})}function canHID(){var e=!1;if(pxt.usb.isEnabled)e=!0;else if(pxt.U.isNodeJS)e=!0;else{var t=/forceHexDownload/i.test(window.location.href),r=!!window.Windows;(pxt.BrowserUtils.isLocalHost()&&pxt.Cloud.localToken&&!t||r)&&(e=!0)}return e}function initAsync(){return canHID()?dapAsync():Promise.reject(new Error("no HID"))}function pageAlignBlocks(e,t){pxt.U.assert(t%256==0);for(var r=[],n=0;n<e.length;){for(var a=e[n],o=new Uint8Array(t),i=a.targetAddr&t-1,c=a.targetAddr-i;n<e.length;++n){var l=e[n];if(l.targetAddr+l.payloadSize>c+t)break;pxt.U.memcpy(o,l.targetAddr-c,l.data,0,l.payloadSize)}var s=pxt.U.flatClone(a);s.data=o,s.targetAddr=c,s.payloadSize=t,r.push(s)}return r}var flashPageBINquick=new Uint32Array([3187719680,612414960,14951168,1489852610,3506651818,1117991684,3186676216,1259742466,1352485398,754997533,614584572,1360527588,1023360009,1495138341,3506187776,1352410112,738220380,604098812,1352410496,1499201773,3506187264,15541632,3023872,1359436047,788552031,872730876,3522642604,1352212736,704666010,3889221884,1073864704,1284]),flashPageBIN=new Uint32Array([3187719680,604157424,1243040534,612389020,2425060,771774750,614584572,1360527588,738220380,604033276,612389020,2425060,771774750,604098812,1499222172,3506187264,15541632,3023872,1359436047,788552031,872730876,3522642604,1352212736,704666010,3186675964,1073864704,1284]),computeChecksums2=new Uint32Array([1277670896,1151673984,570462721,2432716581,7770883,604504083,620822553,1089159209,3489671424,1006715003,3522505728,1183580305,2835629669,1349202433,3521856178,144415489,588485378,2600683164,3506717340,536919594,1151159061,2667625968,1293196802,1226131988,1040305928,554779467,1225998795,1079657291,1180909661,587547098,1259357018,1180899538,587547101,1259160413,771758317,1610797543,2583730945,416505925,2466263048,3889312769,4294966252,3988292384,1044,516138696,798746316,3432918353,461845907,3864292196]),startTime=0;function log(e){var t=Date.now();startTime||(startTime=t);var r=("00000"+(t-=startTime)).slice(-5);pxt.log("HID "+r+": "+e)}var membase=536870912,loadAddr=membase,dataAddr=536879104,stackAddr=536875008;function fullVendorCommandFlashAsync(r,o){var i=!1;return Promise.resolve().then(function(){return o.cmsisdap.cmdNums(138,[1])}).then(function(e){var t=pxt.U.stringToUint8Array(r.outfiles[pxtc.BINARY_HEX]),n=Array.prototype.slice.call(t),a=function(e){void 0===e&&(e=0);var t=Math.min(n.length,e+62),r=n.slice(e,t);return r.unshift(r.length),o.cmsisdap.cmdNums(140,r).then(function(){return!i&&t<n.length?a(t):Promise.resolve()})};return a()}).then(function(e){return o.cmsisdap.cmdNums(139,[])}).timeout(6e4,timeoutMessage).catch(function(e){return i=!0,o.cmsisdap.cmdNums(137,[]).catch(function(e){}).then(function(){return Promise.reject(e)})})}function quickHidFlashAsync(r,l){var n,s=!1;return getFlashChecksumsAsync(l).then(function(e){return n=e,log("write code"),l.cortexM.memory.writeBlock(loadAddr,flashPageBIN)}).then(function(){log("convert");var e=ts.pxtc.UF2.newBlockFile();ts.pxtc.UF2.writeHex(e,r.outfiles[pxtc.BINARY_HEX].split(/\r?\n/));var t=pxt.U.stringToUint8Array(ts.pxtc.UF2.serializeFile(e)),c=pageAlignBlocks(ts.pxtc.UF2.parseFile(t),pageSize);return log("initial: "+c.length+" pages"),log("incremental: "+(c=onlyChanged(c,n)).length+" pages"),Promise.mapSeries(pxt.U.range(c.length),function(r){if(s)return Promise.resolve();var n=c[r];if(268435456<=n.targetAddr)return Promise.resolve();n.targetAddr.toString(16);var e=Promise.resolve(),a=1&r?dataAddr:dataAddr+pageSize,o=1&r?dataAddr+pageSize:dataAddr;if(0==r){for(var t=new Uint32Array(n.data.length/4),i=0;i<n.data.length;i+=4)t[i>>2]=pxt.HF2.read32(n.data,i);e=l.cortexM.memory.writeBlock(a,t)}return e.then(function(){return e=n,t=a,(r=l.cortexM.prepareCommand()).halt(),r.writeCoreRegister(15,loadAddr+4+1),r.writeCoreRegister(14,loadAddr+1),r.writeCoreRegister(13,stackAddr),r.writeCoreRegister(0,e.targetAddr),r.writeCoreRegister(1,t),Promise.resolve().then(function(){return r.go()}).then(function(){return l.cortexM.debug.enable()});var e,t,r}).then(function(){var e=c[r+1];if(!e)return Promise.resolve();var t=new Uint32Array(e.data.buffer);return l.cortexM.memory.writeBlock(o,t)}).then(function(){return l.cortexM.waitForHalt(500)}).then(function(){})}).then(function(){return log("flash done"),pxt.tickEvent("hid.flash.done"),l.cortexM.reset(!1)}).then(function(){l.flashing=!1})}).timeout(25e3,timeoutMessage).catch(function(e){return s=!0,Promise.reject(e)})}function flashAsync(t,r){var n;return void 0===r&&(r={}),startTime=0,log("init"),r.showNotification(pxt.U.lf("Downloading...")),pxt.tickEvent("hid.flash.start"),Promise.resolve().then(function(){return previousDapWrapper?(previousDapWrapper.flashing=!0,Promise.delay(100)):Promise.resolve()}).then(initAsync).then(function(e){return n=e,log("reset"),n.cortexM.init().then(function(){return n.cortexM.reset(!0)}).catch(function(e){return log("trying re-connect"),n.reconnectAsync(!1).then(function(){return n.cortexM.reset(!0)})})}).then(function(){return n.cortexM.memory.readBlock(268439572,1,pageSize)}).then(function(e){return 245760!=pxt.HF2.read32(e,0)?(pxt.tickEvent("hid.flash.uicrfail"),fullVendorCommandFlashAsync(t,n)):quickHidFlashAsync(t,n)}).catch(function(e){return pxt.log("flash error: "+e.type),"devicenotfound"===e.type&&r.reportDeviceNotFoundAsync?(pxt.tickEvent("hid.flash.devicenotfound"),r.reportDeviceNotFoundAsync("/device/windows-app/troubleshoot",t)):e.message===timeoutMessage?(pxt.tickEvent("hid.flash.timeout"),previousDapWrapper.reconnectAsync(!0).catch(function(e){}).then(function(){return pxt.reportException(e),t.confirmAsync({header:lf("Something went wrong..."),body:lf("One-click download took too long. Please disconnect your {0} from your computer and reconnect it, then manually download your program using drag and drop.",pxt.appTarget.appTheme.boardName||lf("device")),agreeLbl:lf("Ok"),hideCancel:!0})}).then(function(){return pxt.commands.saveOnlyAsync(t)})):e.isUserError?(r.reportError(e.message),Promise.resolve()):(pxt.tickEvent("hid.flash.unknownerror"),pxt.reportException(e),t.confirmAsync({header:pxt.U.lf("Something went wrong..."),body:pxt.U.lf("Please manually download your program to your device using drag and drop. One-click download might work afterwards."),agreeLbl:lf("Ok"),hideCancel:!0}).then(function(){return pxt.commands.saveOnlyAsync(t)}))})}function getFlashChecksumsAsync(e){log("getting existing flash checksums");var t=numPages;return e.cortexM.runCode(computeChecksums2,loadAddr,loadAddr+1,4294967295,stackAddr,!0,dataAddr,0,pageSize,t).then(function(){return e.cortexM.memory.readBlock(dataAddr,2*t,pageSize)})}function onlyChanged(e,o){return e.filter(function(e){var t=e.targetAddr/pageSize;if(pxt.U.assert((0|t)==t),pxt.U.assert(e.data.length==pageSize),8*t+8>o.length)return!0;var r=pxt.HF2.read32(o,8*t),n=pxt.HF2.read32(o,8*t+4),a=murmur3_core(e.data);return r!=a[0]||n!=a[1]})}function uwpDeployCoreAsync(e,t){return void 0===t&&(t={}),flashAsync(e,t)}function deployCoreAsync(t,r){return void 0===r&&(r={}),pxt.usb.isPairedAsync().then(function(e){return e?flashAsync(t,r):pxt.webBluetooth.isPaired()?pxt.webBluetooth.flashAsync(t,r).catch(function(e){return pxt.commands.saveOnlyAsync(t)}):pxt.commands.saveOnlyAsync(t)})}function patchBlocks(e,t){if(!(0<=pxt.semver.majorCmp(e||"0.0.0","1.0.0"))){pxt.U.toArray(t.querySelectorAll("block[type=device_show_leds]")).concat(pxt.U.toArray(t.querySelectorAll("block[type=device_build_image]"))).concat(pxt.U.toArray(t.querySelectorAll("shadow[type=device_build_image]"))).concat(pxt.U.toArray(t.querySelectorAll("block[type=device_build_big_image]"))).concat(pxt.U.toArray(t.querySelectorAll("shadow[type=device_build_big_image]"))).forEach(function(a){if(!pxt.U.toArray(a.children).filter(function(e){return"field"==e.tagName&&"LEDS"==e.getAttribute("name")})[0]){var o=[[],[],[],[],[]];pxt.U.toArray(a.children).filter(function(e){return"field"==e.tagName&&/^LED\d+$/.test(e.getAttribute("name"))}).forEach(function(e){var t=e.getAttribute("name"),r=parseInt(t[3]),n=parseInt(t[4]);o[n][r]="TRUE"==e.innerHTML?"#":".",a.removeChild(e)});var e=a.ownerDocument.createElement("field");e.setAttribute("name","LEDS");var t="`\n"+o.map(function(e){return e.join("")}).join("\n")+"\n`";e.appendChild(a.ownerDocument.createTextNode(t)),a.insertBefore(e,null)}});var a={};pxt.U.toArray(t.querySelectorAll("variable")).forEach(function(e){return a[e.innerHTML]=e.getAttribute("id")}),pxt.U.toArray(t.querySelectorAll("block[type=radio_on_packet]")).forEach(function(e){var t=e.querySelector("mutation");if(t){var r=JSON.parse(e.getAttribute("renamemap")||"{}"),n=t.getAttribute("callbackproperties");if(n){var a=n.split(",");if(1===a.length){if("receivedNumber"===a[0])e.setAttribute("type","radio_on_number"),e.removeChild(e.querySelector("field[name=receivedNumber]")),o(e,r,"receivedNumber");else{if("receivedString"!==a[0])return;e.setAttribute("type","radio_on_string"),e.removeChild(e.querySelector("field[name=receivedString]")),o(e,r,"receivedString")}e.removeChild(t)}else 2===a.length&&-1!==a.indexOf("receivedNumber")&&-1!==a.indexOf("receivedString")&&(e.setAttribute("type","radio_on_value"),e.removeChild(e.querySelector("field[name=receivedNumber]")),e.removeChild(e.querySelector("field[name=receivedString]")),o(e,r,"name"),o(e,r,"value"),e.removeChild(t))}}}),pxt.U.toArray(t.querySelectorAll("block[type=device_random]")).concat(pxt.U.toArray(t.querySelectorAll("shadow[type=device_random]"))).forEach(function(e){if(!getValue(e,"min")){var t=e.ownerDocument.createElement("value");t.setAttribute("name","min"),addNumberShadow(t),e.appendChild(t)}}),pxt.U.toArray(t.querySelectorAll("block[type=math_arithmetic]")).concat(pxt.U.toArray(t.querySelectorAll("shadow[type=math_arithmetic]"))).forEach(function(e){var t=getField(e,"OP");if(t&&"DIVIDE"===t.textContent.trim()){e.setAttribute("type","math_js_op"),t.textContent="idiv";var r=e.ownerDocument.createElement("mutation");r.setAttribute("op-type","infix"),e.insertBefore(r,e.firstChild);var n=getValue(e,"A");n&&n.setAttribute("name","ARG0");var a=getValue(e,"B");a&&a.setAttribute("name","ARG1")}}),renameField(t,"math_number_minmax","NUM","SLIDER"),renameField(t,"device_note","note","name")}function o(e,t,r){var n=e.ownerDocument.createElement("field");n.setAttribute("name","HANDLER_"+r),n.setAttribute("id",a[t[r]||r]),n.appendChild(e.ownerDocument.createTextNode(r)),e.appendChild(n)}}function renameField(e,t,r,n){pxt.U.toArray(e.querySelectorAll("block[type="+t+"]")).concat(pxt.U.toArray(e.querySelectorAll("shadow[type="+t+"]"))).forEach(function(e){var t=getField(e,r);t&&t.setAttribute("name",n)})}function getField(e,t){return getFieldOrValue(e,t,!0)}function getValue(e,t){return getFieldOrValue(e,t,!1)}function getFieldOrValue(e,t,r){for(var n=r?"field":"value",a=0;a<e.children.length;a++){var o=e.children.item(a);if(o.tagName===n&&o.getAttribute("name")===t)return o}}function addNumberShadow(e){var t=e.ownerDocument.createElement("shadow");t.setAttribute("type","math_number");var r=e.ownerDocument.createElement("field");r.setAttribute("name","NUM"),r.textContent="0",t.appendChild(r),e.appendChild(t)}function webUsbPairDialogAsync(e){var t=pxt.appTarget.appTheme.boardName||"???",r=pxt.appTarget.appTheme.usbDocs,n=React.createElement("div",{className:"ui grid stackable"},React.createElement("div",{className:"column five wide firmware"},React.createElement("div",{className:"ui header"},lf("First time here?")),React.createElement("strong",{className:"ui small"},lf("You must have version 0249 or above of the firmware")),React.createElement("div",{className:"image"},React.createElement("img",{alt:lf("Comic rainbow updating micro:bit firmware"),className:"ui image",src:"./static/download/firmware.png"})),React.createElement("a",{href:r+"/webusb/troubleshoot",target:"_blank"},lf("Check your firmware version here and update if needed"))),React.createElement("div",{className:"column eleven wide instructions"},React.createElement("div",{className:"ui grid"},React.createElement("div",{className:"row"},React.createElement("div",{className:"column"},React.createElement("div",{className:"ui two column grid padded"},React.createElement("div",{className:"column"},React.createElement("div",{className:"ui"},React.createElement("div",{className:"image"},React.createElement("img",{alt:lf("Comic connecting micro:bit to computer"),className:"ui medium rounded image",src:"./static/download/connect.png"})),React.createElement("div",{className:"content"},React.createElement("div",{className:"description"},React.createElement("span",{className:"ui purple circular label"},"1"),React.createElement("strong",null,lf("Connect the {0} to your computer with a USB cable",t)),React.createElement("br",null),React.createElement("span",{className:"ui small"},lf("Use the microUSB port on the top of the {0}",t)))))),React.createElement("div",{className:"column"},React.createElement("div",{className:"ui"},React.createElement("div",{className:"image"},React.createElement("img",{alt:lf("Comic of successful micro:bit connection"),className:"ui medium rounded image",src:"./static/download/pair.png"})),React.createElement("div",{className:"content"},React.createElement("div",{className:"description"},React.createElement("span",{className:"ui purple circular label"},"2"),React.createElement("strong",null,lf("Pair your {0}",t)),React.createElement("br",null),React.createElement("span",{className:"ui small"},lf("Click 'Pair device' below and select BBC micro:bit CMSIS-DAP or DAPLink CMSIS-DAP from the list")))))))))))),a=[];return r&&a.push({label:lf("Help"),icon:"help",className:"lightgrey",url:r+"/webusb"}),e({header:lf("Pair device for one-click downloads"),jsx:n,hasCloseIcon:!0,agreeLbl:lf("Pair device"),agreeIcon:"usb",hideCancel:!0,className:"downloaddialog",buttons:a})}function showUploadInstructionsAsync(e,t,r){var n=pxt.appTarget.appTheme.boardName||"???",a=pxt.appTarget.appTheme.driveDisplayName||pxt.appTarget.compile.driveName||"???",o=pxt.BrowserUtils.isBrowserDownloadWithinUserContext(),i=!pxt.BrowserUtils.isIE()&&!pxt.BrowserUtils.isEdge(),c=pxt.appTarget.appTheme.usbDocs,l=o?lf("Click 'Download' to open the {0} app.",pxt.appTarget.appTheme.boardName||""):void 0,s=o?void 0:React.createElement("div",{className:"ui grid stackable upload"},React.createElement("div",{className:"column sixteen wide instructions"},React.createElement("div",{className:"ui grid"},React.createElement("div",{className:"row"},React.createElement("div",{className:"column"},React.createElement("div",{className:"ui two column grid padded"},React.createElement("div",{className:"column"},React.createElement("div",{className:"ui"},React.createElement("div",{className:"image"},React.createElement("img",{alt:lf("Comic connecting micro:bit to computer"),className:"ui medium rounded image",src:"./static/download/connect.png"})),React.createElement("div",{className:"content"},React.createElement("div",{className:"description"},React.createElement("span",{className:"ui purple circular label"},"1"),React.createElement("strong",null,lf("Connect the {0} to your computer with a USB cable",n)),React.createElement("br",null),React.createElement("span",{className:"ui small"},lf("Use the microUSB port on the top of the {0}",n)))))),React.createElement("div",{className:"column"},React.createElement("div",{className:"ui"},React.createElement("div",{className:"image"},React.createElement("img",{alt:lf("Comic moving hex file to micro:bit"),className:"ui medium rounded image",src:"./static/download/transfer.png"})),React.createElement("div",{className:"content"},React.createElement("div",{className:"description"},React.createElement("span",{className:"ui purple circular label"},"2"),React.createElement("strong",null,lf("Move the .hex file to the {0}",n)),React.createElement("br",null),React.createElement("span",{className:"ui small"},lf("Locate the downloaded .hex file and drag it to the {0} drive",a)))))))))))),u=[];return i&&u.push({label:o?lf("Download"):e,icon:"download",class:o?"primary":"lightgrey",url:t,fileName:e}),c&&u.push({label:lf("Help"),icon:"help",className:"lightgrey",url:c}),r({header:lf("Download to your {0}",pxt.appTarget.appTheme.boardName),body:l,jsx:s,hasCloseIcon:!0,hideCancel:!0,hideAgree:!0,className:"downloaddialog",buttons:u}).then(function(){})}exports.bufferConcat=function(e){for(var t=0,r=0,n=e;r<n.length;r++){t+=(c=n[r]).length}for(var a=new Uint8Array(t),o=t=0,i=e;o<i.length;o++){var c=i[o];a.set(c,t),t+=c.length}return a},pxt.editor.initExtensionsAsync=function(e){function r(e){return e.showModalDialogAsync({header:lf("Can't import microbit.co.uk scripts..."),body:lf("Importing microbit.co.uk programs is not supported in this editor anymore. Please open this script in the https://makecode.microbit.org/v0 editor."),buttons:[{label:lf("Go to the old editor"),url:"https://makecode.microbit.org/v0"}]}).then(function(){return e.openHome()})}pxt.debug("loading microbit target extensions...");var t=Math;t.imul||(t.imul=function(e,t){var r=65535&e,n=65535&t;return r*n+((e>>>16&65535)*n+r*(t>>>16&65535)<<16>>>0)|0});var n={hexFileImporters:[{id:"blockly",canImport:function(e){return"microbit.co.uk"==e.meta.cloudId&&"blockly"==e.meta.editor},importAsync:function(e,t){return pxt.tickEvent("import.legacyblocks.redirect"),r(e)}},{id:"td",canImport:function(e){return"microbit.co.uk"==e.meta.cloudId&&"touchdevelop"==e.meta.editor},importAsync:function(e,t){return pxt.tickEvent("import.legacytd.redirect"),r(e)}}]};return pxt.usb.setFilters([{vendorId:3368,productId:516,classCode:255,subclassCode:3}]),!!window.Windows?pxt.commands.deployCoreAsync=uwpDeployCoreAsync:!canHID()&&!pxt.webBluetooth.hasPartialFlash()||pxt.BrowserUtils.isPxtElectron()||(pxt.commands.deployCoreAsync=deployCoreAsync),n.blocklyPatch=patchBlocks,n.showUploadInstructionsAsync=showUploadInstructionsAsync,n.webUsbPairDialogAsync=webUsbPairDialogAsync,Promise.resolve(n)};