var iface,pxt,__extends=this&&this.__extends||function(){var o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])};return function(t,e){function i(){this.constructor=t}o(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}}();!function(Ct){!function($){function n(t,e){return Ct.worker.getWorker(Ct.webConfig.workerjs).opAsync(t,e)}$.workerOpAsync=n;var a={},J=50;function Q(t,e){t.push.apply(t,e)}function tt(t){if(!t)throw new Error("Assertion failure")}var Z,t,i=function(t,e,i,o,r){this.link=t,this.type=e,this.parentType=i,this.childType=o,this.isArrayType=r};function et(t){return t.link?et(t.link):t}function d(t,e){var i=et(t),o=et(e);if(tt(null==i.link&&null==o.link),i!=o){if(i.childType&&o.childType){var r=i.childType;i.childType=null,d(r,o.childType)}else i.childType&&!o.childType&&(o.childType=i.childType);if(i.parentType&&o.parentType){var n=i.parentType;i.parentType=null,d(n,o.parentType)}else!i.parentType||o.parentType||o.type||(o.parentType=i.parentType);var l=function(t,e){{if(null==t||"Array"===t&&f(e))return e;if(null==e||"Array"===e&&f(t))return t;if(t==e)return t;throw new Error("cannot mix "+t+" with "+e)}}(i.type,o.type);t.link=o,i.link=o,i.isArrayType=o.isArrayType,t.type=null,e.type=l}}function y(t,e){return void 0===e&&(e=!1),new i(null,t,null,null,e)}$.Point=i,(t=Z=$.BlockDeclarationType||($.BlockDeclarationType={}))[t.None=0]="None",t[t.Argument=1]="Argument",t[t.Assigned=2]="Assigned",t[t.Implicit=3]="Implicit";var k=y("number"),it=y("boolean"),ot=y("string"),h=y("void");function m(t){if(!t)return y(t);switch(t.toLowerCase()){case"number":return k;case"boolean":return it;case"string":return ot;case"void":return h;default:return y(t)}}function rt(t,e){if(tt(null!=e),"placeholder"==e.type||e.type===pxtc.TS_OUTPUT_TYPE)return et(e.p);if("variables_get"==e.type)return et(ht(t,e,e.getField("VAR").getText()).type);if(!e.outputConnection)return m(h.type);var i=e.outputConnection.check_&&e.outputConnection.check_.length?e.outputConnection.check_[0]:"T";if("Array"===i){if(1<e.outputConnection.check_.length)return m(e.outputConnection.check_[1]);var o=void 0;if(e.inputList&&e.inputList.length)for(var r=0,n=e.inputList;r<n.length;r++){var l=n[r];if(l.connection&&l.connection.targetBlock()){var a=et(rt(t,l.connection.targetBlock()));if(a){if(a.parentType)return a.parentType;T(o=m(a.type+"[]"),a);break}}}return o&&(o.isArrayType=!0),o||y(null,!0)}if("T"===i){var s=t.stdCallTable[e.type],c="lists_index_get"===e.type;if(c||s&&s.comp.thisParameter){var u=void 0;if((u=c?e.inputList.find(function(t){return"LIST"===t.name}):e.inputList.find(function(t){return t.name===s.comp.thisParameter.definitionName})).connection&&u.connection.targetBlock()){var p=rt(t,u.connection.targetBlock());if(p.childType)return p.childType;var d=f(p.type)?y(p.type.substr(0,p.type.length-2)):y(null);return T(p,d),d}}return y(null)}return m(i)}function f(t){return t&&-1!==t.indexOf("[]")}function g(t,e,i,o){var r,n,l=e.getInputTargetBlock(i);l?l.type!==pxtc.TS_OUTPUT_TYPE||l.p||(l.p=y(null)):(a[e.id]||(a[e.id]={}),a[e.id][i]||(a[e.id][i]=(r=t,n=e,{type:"placeholder",p:y(o||null),workspace:r.workspace,parentBlock_:n})))}function nt(t){return"pxt_controls_for"==t.type||"pxt_controls_for_of"==t.type?lt(t,"VAR"):t}function lt(t,e){var i=t.getInputTargetBlock(e);return i||a[t.id]&&a[t.id][e]}function v(){a={}}function b(t,e,i,o){g(t,e,i);try{d(rt(t,lt(e,i)),o)}catch(t){}}function _(t,c,e){function u(t){return t.name?t.connection&&t.connection.check_&&t.connection.check_.length?t.connection.check_[0]:"T":void 0}function p(t,e){var i=t.inputList.filter(function(t){return"T"===u(t)});if(i.length){var o=lt(t,i[0].name);if(o){var r=rt(c,o),n=r.type?m(rt(c,o).type+"[]"):m(null);return T(n,r),b(c,t,e,n),!0}}return!1}t&&t.filter(function(t){return!t.disabled}).forEach(function(l){try{switch(l.type){case"math_op2":b(c,l,"x",m(k.type)),b(c,l,"y",m(k.type));break;case"math_op3":b(c,l,"x",m(k.type));break;case"math_arithmetic":case"logic_compare":switch(l.getFieldValue("OP")){case"ADD":case"MINUS":case"MULTIPLY":case"DIVIDE":case"LT":case"LTE":case"GT":case"GTE":case"POWER":b(c,l,"A",m(k.type)),b(c,l,"B",m(k.type));break;case"AND":case"OR":g(c,l,"A",it.type),g(c,l,"B",it.type);break;case"EQ":case"NEQ":g(c,l,"A"),g(c,l,"B");var t=rt(c,lt(l,"A")),e=rt(c,lt(l,"B"));try{d(t,e)}catch(t){}}break;case"logic_operation":g(c,l,"A",it.type),g(c,l,"B",it.type);break;case"logic_negate":g(c,l,"BOOL",it.type);break;case"controls_if":for(var i=0;i<=l.elseifCount_;++i)g(c,l,"IF"+i,it.type);break;case"pxt_controls_for":case"controls_simple_for":b(c,l,"TO",m(k.type));break;case"pxt_controls_for_of":case"controls_for_of":T(rt(c,lt(l,"LIST")),ht(c,l,nt(l).getField("VAR").getText()).type);break;case"variables_set":case"variables_change":var o=ht(c,l,l.getField("VAR").getText()).type;g(c,l,"VALUE");var r=lt(l,"VALUE");if(r){var n=rt(c,r);try{d(o,n)}catch(t){}}break;case"controls_repeat_ext":b(c,l,"TIMES",m(k.type));break;case"device_while":g(c,l,"COND",it.type);break;case"lists_index_get":b(c,l,"LIST",m("Array")),b(c,l,"INDEX",m(k.type)),T(rt(c,lt(l,"LIST")),rt(c,l));break;case"lists_index_set":b(c,l,"LIST",m("Array")),g(c,l,"VALUE"),p(l,"LIST"),b(c,l,"INDEX",m(k.type));break;case"function_call":l.getArguments().forEach(function(t){b(c,l,t.id,m(t.type))});break;case pxtc.PAUSE_UNTIL_TYPE:b(c,l,"PREDICATE",it);break;default:if(l.type in c.stdCallTable){var a=c.stdCallTable[l.type];if("ENUM_GET"===a.attrs.shim||"KIND_GET"===a.attrs.shim)return;Bt(a,Et(l)).forEach(function(e,t){var i=a.isExtensionMethod&&0===t;if(e.definitionName&&!l.getFieldValue(e.definitionName)){var o=l.inputList.find(function(t){return t.name==e.definitionName});if(o&&o.connection&&o.connection.check_){if(i&&"Array"===u(o))if(p(l,e.definitionName))return;for(var r=0;r<o.connection.check_.length;r++)try{var n=o.connection.check_[r];b(c,l,e.definitionName,m(n));break}catch(t){}}}})}}}catch(t){var s=t.block||l;s.setWarningText(t+""),c.errors.push(s)}}),c.allVariables.forEach(function(t){null==at(t.type).type&&d(t.type,m(t.type.isArrayType?"number[]":k.type))})}function T(t,e){var i=et(t),o=et(e);i.childType?d(i.childType,o):i.type||(i.childType=o),o.parentType?d(o.parentType,i):o.type||(o.parentType=i),i.isArrayType=!0}function at(t,e){void 0===e&&(e=[]);var i=et(t);if(-1===e.indexOf(i)&&(e.push(i),!i.type||"Array"===i.type)){if(i.parentType){var o=at(i.parentType,e);if(o.type&&"Array"!==o.type)return i.type=o.type.substr(0,o.type.length-2),i}if(i.childType){var r=at(i.childType,e);if(r.type)return i.type=r.type+"[]",i}}return i}function st(t){var e,i,o=t.getFieldValue("math_number_minmax"===t.type?"SLIDER":"NUM"),r=parseFloat(o);return e=r,i=t,isFinite(e)&&!isNaN(e)||function(t,e){var i=new Error(t);throw i.block=e,i}(lf("Number entered is either too large or too small"),i),r}function ct(t,e,i){return $.H.mkNumberLiteral(st(e))}var ut={ADD:"+",MINUS:"-",MULTIPLY:"*",DIVIDE:"/",LT:"<",LTE:"<=",GT:">",GTE:">=",AND:"&&",OR:"||",EQ:"==",NEQ:"!=",POWER:"**"};function x(t){var e=t.getContent();return $.Helpers.mkMultiComment(e.trim())}function pt(t){if(null==t.type&&(d(t,m(k.type)),t=et(t)),f(t.type)||t.isArrayType)return $.mkText("[]");switch(t.type){case"boolean":return $.H.mkBooleanLiteral(!1);case"number":return $.H.mkNumberLiteral(0);case"string":return $.H.mkStringLiteral("");default:return $.mkText("null")}}function dt(e,i,o){var t,r,n,l,a,s,c,u,p,d,h,m,f,g,y,k,v,b,_,T,x,E,B,C,A,I,N,w,S,D,L,O,R,F,M,P,U,V,H,G,W,X,j,K,Y,q,z;if(tt(null!=i),e.stats[i.type]=(e.stats[i.type]||0)+1,xt(i,o),i.disabled||"placeholder"==i.type)if("Array"===et(rt(e,i)).type){var J="lists_index_get"===i.parentBlock_.type;if(!J)J=(Z=e.stdCallTable[i.parentBlock_.type])&&Z.isExpression;var Q=$.mkText("[0]");t=J?Q:Tt(Q)}else t=pt(rt(e,i));else switch(i.type){case"math_number":case"math_integer":case"math_whole_number":case"math_number_minmax":t=ct(0,i);break;case"math_op2":X=e,K=o,Y=(j=i).getFieldValue("op"),q=dt(X,lt(j,"x"),K),z=dt(X,lt(j,"y"),K),t=$.H.mathCall(Y,[q,z]);break;case"math_op3":G=o,W=dt(e,lt(i,"x"),G),t=$.H.mathCall("abs",[W]);break;case"math_arithmetic":case"logic_compare":case"logic_operation":t=function(t,e,i){var o=e.getFieldValue("OP"),r=lt(e,"A"),n=lt(e,"B"),l=[dt(t,r,i),dt(t,n,i)],a=rt(t,r).type;if(a==ot.type){if("EQ"==o)return $.H.mkSimpleCall("==",l);if("NEQ"==o)return $.H.mkSimpleCall("!=",l)}else if(a==it.type)return $.H.mkSimpleCall(ut[o],l);return tt(o in ut),$.H.mkSimpleCall(ut[o],l)}(e,i,o);break;case"math_modulo":F=e,P=o,U=lt(M=i,"DIVIDEND"),V=lt(M,"DIVISOR"),H=[dt(F,U,P),dt(F,V,P)],t=$.H.mkSimpleCall("%",H);break;case"logic_boolean":R=i,t=$.H.mkBooleanLiteral("TRUE"==R.getFieldValue("BOOL"));break;case"logic_negate":L=o,O=dt(e,lt(i,"BOOL"),L),t=$.mkPrefix("!",[$.H.mkParenthesizedExpression(O)]);break;case"variables_get":N=e,S=(w=i).getField("VAR").getText(),t=(D=ht(N,w,S))?(tt(null!=D&&null!=D.type),$.mkText(D.escapedName)):$.mkText(S);break;case"text":I=i,t=$.H.mkStringLiteral(I.getFieldValue("TEXT"));break;case"text_join":t=function(t,e,i){for(var o,r=0;;){var n=lt(e,"ADD"+r);if(r++,!n){if(r<e.inputList.length)continue;break}var l=dt(t,n,i);o=o?$.H.mkSimpleCall("+",[o,l]):0===n.type.indexOf("text")?l:$.H.mkSimpleCall("+",[$.H.mkStringLiteral(""),l])}return o||$.H.mkStringLiteral("")}(e,i,o);break;case"lists_create_with":B=e,C=o,A=i.inputList.map(function(t){return t.connection&&t.connection.targetBlock()?dt(B,t.connection.targetBlock(),C):void 0}).filter(function(t){return!!t}),t=$.H.mkArrayLiteral(A);break;case"lists_index_get":T=o,x=dt(b=e,lt(_=i,"LIST"),T),E=dt(b,lt(_,"INDEX"),T),t=$.mkGroup([x,$.mkText("["),E,$.mkText("]")]);break;case"lists_index_set":d=e,m=o,f=lt(h=i,"LIST"),g=dt(d,f,m),y=dt(d,lt(h,"INDEX"),m),k=dt(d,lt(h,"VALUE"),m),v=$.mkGroup([g,$.mkText("["),y,$.mkText("] = "),k]),t="lists_create_with"===f.type?Tt(v):v;break;case"math_js_op":case"math_js_round":a=e,c=o,u=(s=i).getFieldValue("OP"),p=[dt(a,lt(s,"ARG0"),c)],s.getInput("ARG1")&&p.push(dt(a,lt(s,"ARG1"),c)),t=$.H.mathCall(u,p);break;case pxtc.TS_OUTPUT_TYPE:l=i,t=$.mkText(l.getFieldValue("EXPRESSION").trim());break;case"argument_reporter_boolean":case"argument_reporter_number":case"argument_reporter_string":case"argument_reporter_custom":r=e,n=mt(i.getFieldValue("VALUE"),r),t=$.mkText(n);break;default:var Z;(Z=e.stdCallTable[i.type])?t=Z.imageLiteral?bt(e,i,Z.imageLiteral,Z.imageLiteralColumns,Z.imageLiteralRows,Z.namespace,Z.f,Bt(Z,Et(i)).map(function(t){return gt(e,i,t,o)})):yt(e,i,Z,o):(Ct.reportError("blocks","unable to compile expression",{details:i.type}),t=pt(rt(e,i)))}return t.id=i.id,t}function ht(t,e,i){return function t(e,i){return i&&i.declaredVars[e]?i.declaredVars[e]:i&&i.parent?t(e,i.parent):null}(i,t.idToScope[e.id])}function mt(t,e,i){if(void 0===i&&(i=!1),!t)return"_";if(i){if(e.renames.oldToNewFunctions[t])return e.renames.oldToNewFunctions[t]}else if(e.renames.oldToNew[t])return e.renames.oldToNew[t];var o=ts.pxtc.escapeIdentifier(t);if(e.renames.takenNames[o]){for(var r=2;e.renames.takenNames[o+r];)r++;o+=r}return i?(e.renames.oldToNewFunctions[t]=o,e.renames.takenNames[o]=!0):e.renames.oldToNew[t]=o,o}function r(t,e){return Bt(t,Et(e)).map(function(t){return t.definitionName}).filter(function(t){return!!t})}function ft(e,i,o){var t=e.stdCallTable[i.type];return t.imageLiteral?$.mkStmt(bt(e,i,t.imageLiteral,t.imageLiteralColumns,t.imageLiteralRows,t.namespace,t.f,Bt(t,Et(i)).map(function(t){return gt(e,i,t,o)}))):t.hasHandler?function(e,i,t,o,r,n){var l,a=o.map(function(t){return kt(e,i,t,n)}),s=lt(i,"HANDLER"),c=_t(e,s);Ct.appTarget.compile&&Ct.appTarget.compile.emptyEventHandlerComments&&0===c.children.length&&c.children.unshift($.mkStmt($.mkText("// "+pxtc.HANDLER_COMMENT)));if(B(i)&&i.mutation.getMutationType()===$.MutatorTypes.ObjectDestructuringMutator)l=i.mutation.compileMutation(e,n);else if(t.comp.handlerArgs.length){var u=(d=e,N(p=i,t).map(function(t){return ht(d,p,t[0]).escapedName}));l=$.mkText("function ("+u.join(", ")+")")}var p,d;return E(e,r,t.f,a,c,l,t.isExtensionMethod)}(e,i,t,r(t,i),t.namespace,o):$.mkStmt(yt(e,i,t,o))}function gt(t,e,i,o,r){void 0===r&&(r=!1);var n=e.getFieldValue(i.definitionName);if(null!=n)return e.getField(i.definitionName)instanceof pxtblockly.FieldTextInput?$.H.mkStringLiteral(n):$.mkText(n);g(t,e,i.definitionName);var l=lt(e,i.definitionName);return r&&"lists_create_with"===l.type?Tt(dt(t,l,o)):i.shadowOptions&&i.shadowOptions.toString&&rt(t,l)!==ot?$.H.mkSimpleCall("+",[$.H.mkStringLiteral(""),$.H.mkParenthesizedExpression(dt(t,l,o))]):dt(t,l,o)}function yt(i,o,r,n){var t;if(B(o)&&o.mutation.getMutationType()===$.MutatorTypes.RestParameterMutator)t=o.mutation.compileMutation(i,n).children;else{if("ENUM_GET"===r.attrs.shim){var e=r.attrs.enumName,l=o.getFieldValue("MEMBER").replace(/^\d+/,"");return $.H.mkPropertyAccess(l,$.mkText(e))}if("KIND_GET"===r.attrs.shim){var a=i.kinds.filter(function(t){return t.blockId===r.attrs.blockId})[0];return $.H.mkPropertyAccess(o.getFieldValue("MEMBER"),$.mkText(a.name))}t=Bt(r,Et(o)).map(function(t,e){return gt(i,o,t,n,r.isExtensionMethod&&0===e&&!r.isExpression)})}var s=!o.getInputsInline();if(r.isIdentity)return t[0];if(r.property)return $.H.mkPropertyAccess(r.f,t[0]);if("@get@"==r.f)return $.H.mkPropertyAccess(t[1].op.replace(/.*\./,""),t[0]);if("@set@"==r.f)return $.H.mkAssign($.H.mkPropertyAccess(t[1].op.replace(/.*\./,"").replace(/@set/,""),t[0]),t[2]);if("@change@"==r.f)return $.H.mkSimpleCall("+=",[$.H.mkPropertyAccess(t[1].op.replace(/.*\./,"").replace(/@set/,""),t[0]),t[2]]);if(r.isExtensionMethod){if(r.attrs.defaultInstance){var c=void 0;B(o)&&o.mutation.getMutationType()===$.MutatorTypes.DefaultInstanceMutator&&(c=o.mutation.compileMutation(i,n)),c?t.unshift(c):t.unshift($.mkText(r.attrs.defaultInstance))}return $.H.extensionCall(r.f,t,s)}return r.namespace?$.H.namespaceCall(r.namespace,r.f,t,s):$.H.stdCall(r.f,t,s)}function E(t,e,i,o,r,n,l){var a;return void 0===l&&(l=!1),r.noFinalNewline=!0,a=n?$.mkGroup([n,r]):$.mkGroup([$.mkText("function ()"),r]),l?$.mkStmt($.H.extensionCall(i,o.concat([a]),!1)):e?$.mkStmt($.H.namespaceCall(e,i,o.concat([a]),!1)):$.mkStmt($.H.mkCall(i,o.concat([a]),!1))}function kt(t,e,i,o){var r=lt(e,i);return r?dt(t,r,o):e.getField(i)instanceof pxtblockly.FieldTextInput?$.H.mkStringLiteral(e.getFieldValue(i)):$.mkText(e.getFieldValue(i))}function vt(t,e){var i=_t(t,lt(e,"HANDLER"));return Ct.appTarget.compile&&Ct.appTarget.compile.onStartText&&i&&i.children&&i.children.unshift($.mkStmt($.mkText("// "+pxtc.ON_START_COMMENT+"\n"))),i}function B(t){return!!t.mutation}function bt(t,e,i,o,r,n,l,a){a=void 0===a?[]:a;var s="\n";r=r||5,o=(o||5)*i;var c=e.getFieldValue("LEDS");c=c.replace(/[ `\n]+/g,"");for(var u=0;u<r;++u){for(var p=0;p<o;++p)0<p&&(s+=" "),s+="#"===c[u*o+p]?"#":".";s+="\n"}var d=$.H.mkStringLiteral(s);return d.canIndentInside=!0,$.H.namespaceCall(n,l,[d].concat(a),!1)}function C(t,e){var i,o,r,n,l,a,s,c,u,p,d,h,m,f,g,y,k,v,b,_,T,x,E,B,C,A,I,N,w,S,D,L,O,R,F,M,P,U,V,H,G,W,X,j,K,Y,q=[];switch(t.stats[e.type]=(t.stats[e.type]||0)+1,xt(e,q),e.type){case"controls_if":i=function(t,e,i){for(var o=[],r=0;r<=e.elseifCount_;++r){var n=dt(t,lt(e,"IF"+r),i),l=_t(t,lt(e,"DO"+r)),a=$.mkText("if (");0<r&&((a=$.mkText("else if (")).glueToBlock=$.GlueMode.WithSpace),Q(o,[a,n,$.mkText(")"),l])}if(e.elseCount_){var s=$.mkText("else");s.glueToBlock=$.GlueMode.WithSpace,Q(o,[s,_t(t,lt(e,"ELSE"))])}return o}(t,e,q);break;case"pxt_controls_for":case"controls_for":case"controls_simple_for":U=t,H=q,G=lt(V=e,"TO"),W=lt(V,"DO"),X=lt(V,"BY"),j=lt(V,"FROM"),K=!X||X.type.match(/^math_number/)&&1==st(X),Y=ht(U,V,nt(V).getField("VAR").getText()),i=[$.mkText("for (let "+Y.escapedName+" = "),j?dt(U,j,H):$.mkText("0"),$.mkText("; "),$.mkInfix($.mkText(Y.escapedName),"<=",dt(U,G,H)),$.mkText("; "),K?$.mkText(Y.escapedName+"++"):$.mkInfix($.mkText(Y.escapedName),"+=",dt(U,X,H)),$.mkText(")"),_t(U,W)];break;case"pxt_controls_for_of":case"controls_for_of":L=t,R=q,F=lt(O=e,"LIST"),M=lt(O,"DO"),P=ht(L,O,nt(O).getField("VAR").getText()),i=[$.mkText("for (let "+P.escapedName+" of "),dt(L,F,R),$.mkText(")"),_t(L,M)];break;case"variables_set":i=[function(t,e,i){var o=lt(e,"VALUE"),r=ht(t,e,e.getField("VAR").getText()),n=t.idToScope[e.id],l=n.variables[r.name],a=!r.alreadyDeclared&&n.declaredVars[r.name]===r&&l.firstReferencingBlock===e&&l.isDefinitelyAssigned,s=dt(t,o,i),c=r.escapedName+" = ";if(r.isAssigned=!0,a){r.alreadyDeclared=Z.Assigned;var u=at(r.type);if(c="let "+r.escapedName+" = ",u){var p=at(rt(t,o));u.type!==p.type&&(c="let "+r.escapedName+": "+u.type+" = ")}}return $.mkStmt($.mkText(c),s)}(t,e,q)];break;case"variables_change":i=[(C=t,A=e,I=q,N=lt(A,"VALUE"),w=ht(C,A,A.getField("VAR").getText()),S=dt(C,N,I),D=$.mkText(w.escapedName),$.mkStmt($.mkInfix(D,"+=",S)))];break;case"controls_repeat_ext":i=function(t,e,i){for(var o,r=dt(t,lt(e,"TIMES"),i),n=_t(t,lt(e,"DO")),l="index",a=2;o=l,void 0!==t.idToScope[e.id].variables[o];a++)l="index"+a;return[$.mkText("for (let "+l+" = 0; "),$.mkInfix($.mkText(l),"<",r),$.mkText("; "+l+"++)"),n]}(t,e,q);break;case"device_while":x=q,E=dt(_=t,lt(T=e,"COND"),x),B=_t(_,lt(T,"DO")),i=[$.mkText("while ("),E,$.mkText(")"),B];break;case"procedures_defnoreturn":y=t,v=mt((k=e).getFieldValue("NAME"),y,!0),b=lt(k,"STACK"),i=[$.mkText("function "+v+"() "),_t(y,b)];break;case"function_definition":d=t,m=mt((h=e).getField("function_name").getText(),d,!0),f=lt(h,"STACK"),g=h.getArguments().map(function(t){return mt(t.name,d)+": "+t.type}),i=[$.mkText("function "+m+" ("+g.join(", ")+")"),_t(d,f)];break;case"procedures_callnoreturn":i=[(c=t,u=e,p=mt(u.getFieldValue("NAME"),c,!0),$.mkStmt($.mkText(p+"()")))];break;case"function_call":i=[(o=t,r=e,n=q,l=mt(r.getField("function_name").getText(),o,!0),a=!r.getInputsInline(),s=r.getArguments().map(function(t){return{actualName:t.name,definitionName:t.id}}).map(function(t){return gt(o,r,t,n)}),$.mkStmt($.H.stdCall(l,s,a)))];break;case ts.pxtc.ON_START_TYPE:i=vt(t,e).children;break;case pxtc.TS_STATEMENT_TYPE:i=function(t,e){var i=[],o=0;for(;;){var r=e.getFieldValue("LINE"+o);if(o++,null===r)break;i.push($.mkText(r+"\n"))}return i}(0,e);break;case pxtc.PAUSE_UNTIL_TYPE:i=function(t,e,i){var o=Ct.appTarget.runtime&&Ct.appTarget.runtime.pauseUntilBlock;Ct.Util.assert(!!o,"target has block enabled");var r=o.namespace,n=o.callName||"pauseUntil",l=kt(t,e,"PREDICATE",i),a=[$.mkGroup([$.mkText("() => "),l])];return r?[$.mkStmt($.H.namespaceCall(r,n,a,!1))]:[$.mkStmt($.H.mkCall(n,a,!1,!1))]}(t,e,q);break;case pxtc.TS_DEBUGGER_TYPE:i=function(t,e){if("1"==e.getFieldValue("ON_OFF"))return[$.mkText("debugger;\n")];return[]}(0,e);break;case pxtc.TS_BREAK_TYPE:i=[$.mkText("break;\n")];break;case pxtc.TS_CONTINUE_TYPE:i=[$.mkText("continue;\n")];break;default:i=t.stdCallTable[e.type]?[ft(t,e,q)]:[$.mkStmt(dt(t,e,q))]}var z=i[i.length-1];return z&&(z.id=e.id),q.length&&function(t,e){for(var i=[],o=[],r=0,n=t;r<n.length;r++)for(var l=n[r],a=0,s=l.split("\n");a<s.length;a++){var c=s[a];o.push(c)}for(var u=0;u<o.length;u++){for(var p=o[u].split(/\s/),d=void 0,h=0,m=p;h<m.length;h++){var f=m[h];d?d.length+f.length>J?(i.push($.mkText("// "+d)),i.push($.mkNewLine()),d=f):d+=" "+f:d=f}d&&(i.push($.mkText("// "+d)),i.push($.mkNewLine())),u!==o.length-1&&(i.push($.mkText("//")),i.push($.mkNewLine()))}for(var g=0,y=i.reverse();g<y.length;g++){var k=y[g];e.unshift(k)}}(q,i),i.forEach(function(t){(t.type===$.NT.Block||t.type===$.NT.Prefix&&Ct.Util.startsWith(t.op,"//"))&&(t.id=e.id)}),i}function _t(t,e){for(var i=[];e;e=e.getNextBlock())e.disabled||Q(i,C(t,e));return $.mkBlock(i)}function Tt(t){var e=$.mkStmt($.mkText(";"));return e.glueToBlock=$.GlueMode.NoSpace,$.mkGroup([e,t])}function l(t,i){var o={workspace:t,stdCallTable:{},errors:[],renames:{oldToNew:{},takenNames:{},oldToNewFunctions:{}},stats:{},enums:[],kinds:[],idToScope:{},allVariables:[],blocksInfo:null,generatedVarDeclarations:{}};return(o.blocksInfo=i)&&(Object.keys(i.apis.byQName).forEach(function(t){var e=i.apis.byQName[t];!e.pkg||6!==e.kind&&3!==e.kind&&5!==e.kind||(o.renames.takenNames[e.qName]=!0)}),i.enumsByName&&Object.keys(i.enumsByName).forEach(function(t){return o.enums.push(i.enumsByName[t])}),i.kindsByName&&Object.keys(i.kindsByName).forEach(function(t){return o.kinds.push(i.kindsByName[t])}),i.blocks.forEach(function(t){if(o.stdCallTable[t.attributes.blockId])Ct.reportError("blocks","function already defined",{details:t.attributes.blockId,qualifiedName:t.qName,packageName:t.pkg});else{o.renames.takenNames[t.namespace]=!0;var e=Ct.blocks.compileInfo(t),i=!!e.thisParameter;o.stdCallTable[t.attributes.blockId]={namespace:t.namespace,f:t.name,comp:e,attrs:t.attributes,isExtensionMethod:i,isExpression:t.retType&&"void"!==t.retType,imageLiteral:t.attributes.imageLiteral,imageLiteralColumns:t.attributes.imageLiteralColumns,imageLiteralRows:t.attributes.imageLiteralRows,hasHandler:!!e.handlerArgs.length||t.parameters&&t.parameters.some(function(t){return"() => void"==t.type||"Action"==t.type||!!t.properties}),property:!t.parameters,isIdentity:"TD_ID"==t.attributes.shim}}}),t.getTopBlocks(!1).filter(L).forEach(function(t){mt("procedures_defnoreturn"===t.type?t.getFieldValue("NAME"):t.getField("function_name").getText(),o,!0)})),o}function A(t,e){if(t.type===ts.pxtc.ON_START_TYPE)return 0;var i=e.stdCallTable[t.type],o=I(e,t),r=1+ts.pxtc.Util.codalHash16(o);return i&&i.attrs.afterOnStart?r:-r}function s(i,o){try{var t=o.getAllBlocks(),e=o.getTopBlocks(!0);e=e.sort(function(t,e){return A(t,i)-A(e,i)}),function(r,t,e){t.forEach(function(t){return t.setEnabled(!0)});var o={};function n(t,e){var i=o[t];i?e.setEnabled(!1):(e.setEnabled(!0),o[t]=e)}e.forEach(function(t){var e=r.stdCallTable[t.type];if(t.type==ts.pxtc.ON_START_TYPE)n(ts.pxtc.ON_START_TYPE,t);else{if(L(t)||e&&e.attrs.blockAllowMultiple&&!e.attrs.handlerStatement)return;if(e&&e.hasHandler&&!e.attrs.handlerStatement){var i=e.attrs.blockHandlerKey||I(r,t);n(i,t)}else for(var o=t;o;)o.setEnabled(!1),o=o.getNextBlock()}})}(i,t,e),t=t.filter(function(t){return!t.disabled}),function(t,e){for(var d=0,i={declaredVars:{},children:[],variables:{}},o=0,r=t;o<r.length;o++){var n=r[o];if(n.type===ts.pxtc.ON_START_TYPE){var l=n.getInputTargetBlock("HANDLER");l&&f(l,i,e);break}}t.forEach(function(t){t.type!==ts.pxtc.ON_START_TYPE&&f(t,i,e)});for(var a=0,s=Object.keys(i.declaredVars);a<s.length;a++){var c=s[a],u=i.declaredVars[c];delete i.declaredVars[c];var p=w(u);(p.declaredVars[c]=u).declaringScope=p}return function e(t,i){for(var o=0,r=Object.keys(t.declaredVars);o<r.length;o++){var n=r[o],l=t.declaredVars[n];i.allVariables[l.id]=l}t.children.forEach(function(t){return e(t,i)})}(i,e),function e(o,r){for(var t=0,i=Object.keys(o.declaredVars);t<i.length;t++){var n=i[t],l=o.declaredVars[n];l.escapedName||(l.escapedName=a(n))}function a(t){if(!t)return"_";var e=ts.pxtc.escapeIdentifier(t);if(r.renames.takenNames[e]||s(e,o)){for(var i=2;r.renames.takenNames[e+i]||s(e+i,o);)i++;e+=i}return e}function s(t,e){if(e){for(var i=0,o=Object.keys(e.declaredVars);i<o.length;i++){var r=o[i],n=e.declaredVars[r];if(n.name!==n.escapedName&&n.escapedName===t)return!0}return s(t,e.parent)}return!1}o.children.forEach(function(t){return e(t,r)})}(i,e);function h(t,e){void 0===t.scopes?t.scopes=[e]:-1===t.scopes.indexOf(e)&&t.scopes.push(e)}function m(t,e){for(var i=t.parent;void 0!==i&&void 0===i.variables[e];i=i.parent)i.variables[e]={isFirstReferencedInDescendant:!0}}function f(i,o,r){if(r.idToScope[i.id]=o,"variables_get"===i.type||"variables_change"===i.type||"variables_set"===i.type)l=o,h(g(a=(n=i).getField("VAR").getText(),l),l),void 0===l.variables[a]&&(l.variables[a]={firstReferencingBlock:n,isDefinitelyAssigned:"variables_set"===n.type&&(s=!0,S(n,function(t){s&&"variables_get"===t.type&&t.getField("VAR").getText()===a&&(s=!1)},!0),s)},m(l,a));else if(i.type===pxtc.TS_STATEMENT_TYPE){var t=i.declaredVariables;if(t){var e=t.split(",");e.forEach(function(t){var e=g(t,o);e.alreadyDeclared=Z.Argument,o.variables[t]={firstReferencingBlock:i,isDefinitelyAssigned:!0},m(o,t),h(e,o)})}}var n,l,a,s,c;if(i.inputList.some(function(t){return t.type===Blockly.NEXT_STATEMENT})){var u=function(t,e){switch(t.type){case"pxt_controls_for":case"controls_simple_for":return[[nt(t).getField("VAR").getText(),k]];case"pxt_controls_for_of":case"controls_for_of":return[[nt(t).getField("VAR").getText(),y(null)]];case"function_definition":for(var i=[],o=0,r=t.getArguments();o<r.length;o++){var n=r[o];i.push([n.name,y(n.type)])}return i}if(B(t)){var l=t.mutation.getDeclaredVariables();if(l)return Object.keys(l).map(function(t){return[t,y(l[t])]})}var a=e.stdCallTable[t.type];if(a&&a.comp.handlerArgs.length)return N(t,a);return[]}(i,r).map(function(t){return{name:t[0],type:t[1],id:d++}}),p=o;u.length&&(p={parent:o,declaredVars:{},children:[],variables:{}},u.forEach(function(t){t.alreadyDeclared=Z.Assigned,p.declaredVars[t.name]=t,p.variables[t.name]={firstReferencingBlock:i,isDefinitelyAssigned:!0},h(t,p)}),r.idToScope[i.id]=p),o!==p&&o.children.push(p),S(i,function(t){f(t,p,r)}),c=function(t){var e={parent:p,declaredVars:{},children:[],variables:{}};p.children.push(e),f(t,e,r)},i.inputList.filter(function(t){return t.type===Blockly.NEXT_STATEMENT}).forEach(function(t){t.connection&&t.connection.targetBlock()&&c(t.connection.targetBlock())})}else S(i,function(t){f(t,o,r)});i.nextConnection&&i.nextConnection.targetBlock()&&f(i.nextConnection.targetBlock(),o,r)}function g(t,e){return e.declaredVars[t]?e.declaredVars[t]:e.parent?g(t,e.parent):(e.declaredVars[t]={name:t,type:y(null),id:d++},e.declaredVars[t])}}(e=e.filter(function(t){return!t.disabled}),i),_(t,i);var r=[],n=function(t,e){if(!t.length||t.some(function(t){return!t.rendered}))return{orphans:e,idToComments:{}};for(var i=t.map(function(t){var e=t.getBoundingRectangle(),i=t.getHeightWidth();return{id:t.id,x:e.left,y:e.top,width:i.width,height:i.height}}),o={orphans:[],idToComments:{}},r=0,n=e;r<n.length;r++){for(var l=n[r],a=l.getBoundingRectangle(),s=l.getHeightWidth(),c=a.left,u=a.top,p=void 0,d=0,h=i;d<h.length;d++){var m=h[d];D(c,u,s.width,s.height,m)?p=m:!p&&D(c-20,u-20,s.width+40,s.height+40,m)&&(p=m)}p?(o.idToComments[p.id]||(o.idToComments[p.id]=[]),o.idToComments[p.id].push(l)):o.orphans.push(l)}return o}(e,o.getTopComments(!0));n.orphans.forEach(function(t){return Q(r,x(t).children)}),e.forEach(function(t){if(n.idToComments[t.id]&&n.idToComments[t.id].forEach(function(t){Q(r,x(t).children)}),t.type==ts.pxtc.ON_START_TYPE)Q(r,vt(i,t).children);else{var e=$.mkBlock(C(i,t));e.type==$.NT.Block?Q(r,e.children):r.push(e)}});var l=[];i.enums.forEach(function(a){var t=o.getVariablesOfType(a.name);if(t&&t.length){var e=t.map(function(t){var e=/^(\d+)([^0-9].*)$/.exec(t.name);return e?[e[2],parseInt(e[1])]:[t.name,-1]});e.sort(function(t,e){return t[1]-e[1]});var s=[],c=-1;e.forEach(function(t,e){var i,o=t[0],r=t[1];if(a.isBitMask){var n=Math.log2(r);0<=n&&Math.floor(n)===n&&(i=$.H.mkAssign($.mkText(o),$.H.mkSimpleCall("<<",[$.H.mkNumberLiteral(1),$.H.mkNumberLiteral(n)])))}else if(a.isHash){var l=ts.pxtc.Util.codalHash16(o.toLowerCase());i=$.H.mkAssign($.mkText(o),$.H.mkNumberLiteral(l))}i||(i=r===c+1?$.mkText(o):$.H.mkAssign($.mkText(o),$.H.mkNumberLiteral(r))),s.push(i),c=r});var i=$.mkCommaSep(s,!0);i.glueToBlock=$.GlueMode.NoSpace,l.push($.mkGroup([$.mkText("enum "+a.name),$.mkBlock([i])]))}}),i.kinds.forEach(function(e){var t=o.getVariablesOfType("KIND_"+e.name);if(t&&t.length){var i=t.map(function(t){return t.name}).filter(function(t){return-1===e.initialMembers.indexOf(t)});i.length&&l.push($.mkGroup([$.mkText("namespace "+e.name),$.mkBlock(i.map(function(t){return $.mkStmt($.mkText("export const "+t+" = "+e.name+"."+e.createFunctionName+"()"))}))]))}});var a=pxtblockly.getAllTilesetTiles(o);if(a.length){var s=Ct.appTarget.runtime&&Ct.appTarget.runtime.tilesetFieldEditorIdentity;l.push($.mkGroup([$.mkText("namespace "+Ct.sprite.TILE_NAMESPACE),$.mkBlock(a.map(function(t){return $.mkGroup([$.mkStmt($.mkText(s?"//% blockIdentity="+s:"")),$.mkStmt($.mkText("export const "+Ct.sprite.TILE_PREFIX+t.projectId+" = "+Ct.sprite.bitmapToImageLiteral(Ct.sprite.Bitmap.fromData(t.data),"typescript")))])}))]))}var c=i.allVariables.filter(function(t){return!t.alreadyDeclared}).map(function(t){return function(t,e){var i,o=at(t.type);i="Array"===o.type?$.mkText("[]"):pt(o);var r,n=!1;if("null"==i.op||"[]"==i.op){"Array"!==(r=o.type)&&"null[]"!==r||(r="number[]");var l=e.blocksInfo.apis.byQName[r];l&&l.attributes.autoCreate?i=$.mkText(l.attributes.autoCreate+"()"):n=!0}e.generatedVarDeclarations[t.escapedName]={value:$.flattenNode([i]).output},n&&(e.generatedVarDeclarations[t.escapedName].type=r);return t.alreadyDeclared=Z.Implicit,$.mkStmt($.mkText("let "+t.escapedName+(n?": "+r:"")+" = "),i)}(t,i)}),u=[];return i.allVariables.filter(function(t){return t.alreadyDeclared===Z.Implicit&&!t.isAssigned}).forEach(function(e){var t=at(e.type);"string"===t.type||"number"===t.type||"boolean"===t.type||f(t.type)||u.push({blockId:e.scopes.find(function(t){return void 0!==t.variables[e.name]&&void 0!==t.variables[e.name].firstReferencingBlock}).variables[e.name].firstReferencingBlock.id,message:lf("Variable '{0}' is never assigned",e.name)})}),[l.concat(c.concat(r)),u,i.generatedVarDeclarations]}catch(t){var p=t.block;if(!p)throw t;p.setWarningText(t+""),i.errors.push(p)}finally{v()}return[null,null,null]}function I(e,i){if(i.type==ts.pxtc.ON_START_TYPE)return JSON.stringify({name:ts.pxtc.ON_START_TYPE});if(i.type==ts.pxtc.FUNCTION_DEFINITION_TYPE)return JSON.stringify({type:"function",name:i.getFieldValue("function_name")});var t=e.stdCallTable[i.type];if(t){var o=r(t,i).map(function(t){return kt(e,i,t,[])});return JSON.stringify({name:t.f,ns:t.namespace,compiledArgs:o}).replace(/"id"\s*:\s*"[^"]+"/g,"")}}function c(t,e,i,o){var r=$.flattenNode(e);return n("format",{format:{input:r.output,pos:1}}).then(function(){return{source:r.output,sourceMap:r.sourceMap,stats:t.stats,diagnostics:i||[],generatedVarDeclarations:o}})}function xt(t,e){t.comment&&("string"==typeof t.comment?e.push(t.comment):e.push(t.comment.getText()))}function Et(t){if(t.mutationToDom){var e=t.mutationToDom();if(e.hasAttribute("_expanded")){var i=parseInt(e.getAttribute("_expanded"));return isNaN(i)?0:Math.max(i,0)}}return 0}function Bt(t,e){var i=t.comp,o=[];return i.thisParameter&&o.push(i.thisParameter),i.parameters.forEach(function(t){t.isOptional&&0<e?(o.push(t),--e):t.isOptional||o.push(t)}),o}function N(t,e){var i=[];if(e.attrs.draggableParameters)for(var o=0;o<e.comp.handlerArgs.length;o++){var r=void 0,n=lt(t,"HANDLER_DRAG_PARAM_"+(l=e.comp.handlerArgs[o]).name);if(null===(r="reporter"===e.attrs.draggableParameters?n&&n.getFieldValue("VALUE"):n&&n.getField("VAR").getText()))break;i.push([r,y(l.type)])}else for(o=0;o<e.comp.handlerArgs.length;o++){var l=e.comp.handlerArgs[o],a=t.getField("HANDLER_"+l.name);if(null===(r=a&&a.getText()))break;i.push([r,y(l.type)])}return i}function w(t){if(void 0!==t.scopes&&0!==t.scopes.length){if(1===t.scopes.length){var e=t.scopes[0];return void 0===e.parent||e.variables[t.name].isDefinitelyAssigned?e:u(e)[0]}for(var i=p(t.scopes[0],t.scopes[1]),o=2;o<t.scopes.length;o++)i=p(i,t.scopes[o]);var r=i[i.length-1];return r.variables[t.name].isDefinitelyAssigned?r:i[0]}}function u(t){for(var e=[t],i=t.parent;void 0!==i;i=i.parent)e.unshift(i);return e}function p(t,e){var i=Array.isArray(t)?t:u(t),o=u(e);if(i[0]===o[0]){var r,n;i.length>o.length?(r=i,n=o):(r=o,n=i);for(var l=1;l<n.length;l++)if(n[l]!==r[l])return n.slice(0,l);return n}}function S(t,e,i){void 0===i&&(i=!1),t.inputList.filter(function(t){return t.type===Blockly.INPUT_VALUE}).forEach(function(t){t.connection&&t.connection.targetBlock()&&(e(t.connection.targetBlock()),i&&S(t.connection.targetBlock(),e,i))})}function D(t,e,i,o,r){var n=a(t,r.x,r.x+r.width)||a(r.x,t,t+i),l=a(e,r.y,r.y+r.height)||a(r.y,e,e+o);return n&&l;function a(t,e,i){return e<=t&&t<=i}}function L(t){return"procedures_defnoreturn"===t.type||"function_definition"===t.type}$.compileExpression=dt,$.escapeVarName=mt,$.mkEnv=l,$.compileBlockAsync=function(t,e){var i=t.workspace,o=l(i,e);_(i&&i.getAllBlocks(),o);var r=C(o,t);return v(),c(o,r)},$.callKey=I,$.findBlockId=function(t,e){if(e){for(var i,o,r=0;r<t.length;++r){var n=t[r];n.start<=e.start&&n.end>e.start+e.length&&(!i||o>n.end-n.start)&&(o=(i=n).end-n.start)}return i?i.id:void 0}},$.compileAsync=function(t,e){var i=l(t,e),o=s(i,t);return c(i,o[0],o[1],o[2])}}(Ct.blocks||(Ct.blocks={}))}(pxt||(pxt={})),function(n){!function(t){var r={};function e(t,e,i){null==r[t]&&(r[t]={field:e,validator:i})}t.initFieldEditors=function(){e("text",pxtblockly.FieldTextInput),e("note",pxtblockly.FieldNote),e("gridpicker",pxtblockly.FieldGridPicker),e("textdropdown",pxtblockly.FieldTextDropdown),e("numberdropdown",pxtblockly.FieldNumberDropdown),e("imagedropdown",pxtblockly.FieldImageDropdown),e("colorwheel",pxtblockly.FieldColorWheel),e("toggle",pxtblockly.FieldToggle),e("toggleonoff",pxtblockly.FieldToggleOnOff),e("toggleyesno",pxtblockly.FieldToggleYesNo),e("toggleupdown",pxtblockly.FieldToggleUpDown),e("toggledownup",pxtblockly.FieldToggleDownUp),e("togglehighlow",pxtblockly.FieldToggleHighLow),e("togglewinlose",pxtblockly.FieldToggleWinLose),e("colornumber",pxtblockly.FieldColorNumber),e("images",pxtblockly.FieldImages),e("sprite",pxtblockly.FieldSpriteEditor),e("animation",pxtblockly.FieldAnimationEditor),e("tilemap",pxtblockly.FieldTilemap),e("tileset",pxtblockly.FieldTileset),e("speed",pxtblockly.FieldSpeed),e("turnratio",pxtblockly.FieldTurnRatio),e("protractor",pxtblockly.FieldProtractor),e("position",pxtblockly.FieldPosition),e("melody",pxtblockly.FieldCustomMelody)},t.registerFieldEditor=e,t.createFieldEditor=function(t,e,i){if(null==r[t])return console.error("Field editor "+t+" not registered"),null;i||(i={}),n.Util.assert(null==i.lightMode,"lightMode is a reserved parameter for custom fields"),i.lightMode=n.options.light;var o=r[t];return new o.field(e,i,o.validator)}}(n.blocks||(n.blocks={}))}(pxt||(pxt={})),function(A){!function(E){E.diffXml=function(t,e,i){return function(t,e,i){try{return Blockly.Events.disable(),function(l,e,t){A.tickEvent("blocks.diff",{started:1}),t=t||{};var a=A.options.debug||window&&/diffdbg=1/.test(window.location.href)?console.log:function(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i]};if(!l)return{ws:void 0,message:lf("All blocks are new."),added:0,deleted:0,modified:1};if(!e)return{ws:void 0,message:lf("The current blocks seem corrupted."),added:0,deleted:0,modified:1};var r=A.Util.toDictionary(l.getTopBlocks(!1),function(t){return C(t,!0)});e.getTopBlocks(!1).forEach(function(t){var e=C(t,!0),i=l.getBlockById(t.id)||r[e];if(i){var o=C(i,!0);e==o&&(a("fast unmodified top ",t.id),t.dispose(!1),i.dispose(!1))}});var i=l.getAllBlocks().filter(function(t){return!t.disabled}),o=l.getTopBlocks(!1).filter(function(t){return!t.disabled}),n=e.getAllBlocks().filter(function(t){return!t.disabled});if(a("blocks",n.map(function(t){return t.toDevString()})),a(n),0==i.length&&0==n.length)return A.tickEvent("blocks.diff",{moves:1}),{ws:void 0,message:lf("Some blocks were moved or changed."),added:0,deleted:0,modified:1};var s=o.filter(function(t){return!e.getBlockById(t.id)}),c=i.filter(function(t){return!e.getBlockById(t.id)}),u=n.filter(function(t){return!l.getBlockById(t.id)}),p=A.blocks.initRenderingWorkspace(),d=A.blocks.saveWorkspaceXml(e,!0);A.blocks.domToWorkspaceNoEvents(Blockly.Xml.textToDom(d),p),p.getAllBlocks().filter(function(t){return t.disabled}).forEach(function(t){a("disabled ",t.toDevString()),t.dispose(!1)});var h=A.Util.toDictionary(p.getAllBlocks(),function(t){return t.id});a("todo blocks",h),x("start"),t.hideDeletedTopBlocks||(s.forEach(function(t){a("deleted top "+t.toDevString()),T(t);var e=_(t);T(e),e.setDisabled(!0)}),x("deleted top")),u.map(function(t){return p.getBlockById(t.id)}).filter(function(t){return!!t}).forEach(function(t){a("added "+t.toDevString()),T(t)}),x("added");var m={},f=c.filter(function(t){return!(h[t.id]||b(t)||t.outputConnection&&t.outputConnection.isConnected())});f.forEach(function(t){var e=_(t);m[t.id]=e.id,a("deleted block "+t.toDevString()+"->"+e.toDevString())}),f.forEach(function(t){return function(t){a("stitching "+t.toDevString()+"->"+m[t.id]);var e=p.getBlockById(m[t.id]);e.setDisabled(!0),v(e),T(e);var i=t.getPreviousBlock();if(i){var o=p.getBlockById(m[i.id])||p.getBlockById(i.id);if(a("previous "+t.id+"->"+e.toDevString()+": "+o.toDevString()),o)if(o.nextConnection)e.previousConnection.connect(o.nextConnection);else{var r=o.inputList.slice().reverse().find(function(t){return t.connection&&t.connection.type==Blockly.NEXT_STATEMENT});r&&e.previousConnection.connect(r.connection)}}var n=t.getNextBlock();if(n){var l=p.getBlockById(m[n.id])||p.getBlockById(n.id);l&&(a("next "+t.id+"->"+e.toDevString()+": "+l.toDevString()),e.nextConnection.connect(l.previousConnection))}}(t)});var g=0;if(A.Util.values(h).filter(function(t){return function(t){var e=l.getBlockById(t.id);if(!e)return!1;var i=t.getPreviousBlock();if(i&&!h[i.id])return!1;var o=t.getNextBlock();if(o&&!h[o.id])return!1;var r=e.getPreviousBlock();if(!r&&!i)return!1;if(!!r!=!!i||r.id!=i.id)return!0;var n=e.getNextBlock();return!(!n&&!o||!!n==!!o&&n.id==o.id)}(t)}).forEach(function(t){a("moved "+t.toDevString()),delete h[t.id],v(t),g++}),x("moved"),A.Util.values(h).filter(function(t){return function(t){var e=l.getBlockById(t.id);if(!e)return!1;var i=C(e),o=C(t);return i!=o&&(a("old "+e.toDevString(),i),a("new "+t.toDevString(),o),!0)}(t)}).forEach(function(t){a("changed "+t.toDevString()),delete h[t.id],v(t),g++}),x("changed"),p.getTopBlocks(!1).forEach(function(t){t.getDescendants(!1).find(function(t){return b(t)})||(a("unmodified top "+t.toDevString()),delete h[t.id],t.dispose(!1))}),x("cleaned"),A.Util.values(h).filter(function(t){return!!p.getBlockById(t.id)}).forEach(function(t){var e;t.setColour(B),(e=t).rendered=!1,e.inputList.forEach(function(t){return t.fieldRow.forEach(function(t){t.init(),t.box_&&(t.box_.setAttribute("fill",e.getColour()),t.box_.setAttribute("stroke",e.getColourTertiary()))})})}),!p.getAllBlocks().length)return A.tickEvent("blocks.diff",{missed:1}),{ws:p,message:lf("Some blocks were changed."),deleted:c.length,added:u.length,modified:g};p.resize(),Blockly.svgResize(p);var y=A.blocks.renderWorkspace(t.renderOptions||{emPixels:20,layout:E.BlockLayout.Flow,aspectRatio:.5,useViewWidth:!0}),k={ws:p,svg:y,deleted:c.length,added:u.length,modified:g};return A.tickEvent("blocks.diff",{deleted:k.deleted,added:k.added,modified:k.modified}),k;function v(t){t.__pxt_used=!0}function b(t){return!!t.__pxt_used}function _(t){var e=Blockly.Xml.blockToDom(t,!1),i=Blockly.Xml.domToBlock(e,p);return i.nextConnection&&i.nextConnection.targetConnection&&i.nextConnection.disconnect(),i.previousConnection&&i.previousConnection.targetConnection&&i.previousConnection.disconnect(),i}function T(t){t.getDescendants(!1).forEach(function(t){delete h[t.id],v(t)})}function x(t){a(t+":",A.Util.values(h).map(function(t){return t.toDevString()}))}}(t,e,i)}catch(t){return A.reportException(t),{ws:void 0,message:lf("Oops, we could not diff those blocks."),error:t,deleted:0,added:0,modified:0}}finally{Blockly.Events.enable()}}(A.blocks.loadWorkspaceXml(t,!0),A.blocks.loadWorkspaceXml(e,!0),i)};var B="#d0d0d0";function C(t,e){var i=Blockly.Xml.blockToDom(t,!0);return o(i),function t(e,i){if(!e)return;i(e);for(var o=0,r=A.Util.toArray(e.children);o<r.length;o++){var n=r[o];t(n,i)}}(i,function(t){o(t),e||("next"==t.localName&&t.remove(),"statement"==t.localName&&t.remove())}),Blockly.Xml.domToText(i)}function o(t){t.removeAttribute("id"),t.removeAttribute("x"),t.removeAttribute("y"),t.removeAttribute("deletable"),t.removeAttribute("editable"),t.removeAttribute("movable")}E.mergeXml=function(t,e,i){return t==e?i:i==e?t:void 0}}(A.blocks||(A.blocks={}))}(pxt||(pxt={})),function(f){!function(p){function u(t,e){for(var i=[],o=0;o<t.childNodes.length;o++){var r=t.childNodes.item(o);r.tagName===e&&i.push(r)}return i}function d(t,e){return h(t,"block","type",e).concat(h(t,"shadow","type",e))}function h(t,e,i,o){return f.Util.toArray(t.getElementsByTagName(e)).filter(function(t){return t.getAttribute(i)===o})}function c(t,e,i,o){var r=h(t,e,i,o);return r.length?r[0]:void 0}function m(n,l,a){var t=a.getAttribute("type"),e=Blockly.Blocks[t],i=p.blockSymbol(t);if(i&&e){var s=p.compileInfo(i);i.parameters.forEach(function(t,e){var i=n.apis.byQName[t.type];if(i&&6==i.kind){var o=c(a,"field","name",s.actualNameToParam[t.name].definitionName);if(o){var r=l[i.name+"."+o.textContent];r&&(o.textContent=r)}}})}}p.domToWorkspaceNoEvents=function(t,e){f.tickEvent("blocks.domtow");try{Blockly.Events.disable();var i=Blockly.Xml.domToWorkspace(t,e);return(o=e).getAllBlocks().filter(function(t){return!!t.comment&&t.comment instanceof Blockly.Comment}).forEach(function(t){var e=t.comment.getText();if(/@highlight/.test(e)){var i=e.replace(/@highlight/g,"").trim();t.setCommentText(i||null),o.highlightBlock(t.id)}}),i}finally{Blockly.Events.enable()}var o},p.clearWithoutEvents=function(t){if(f.tickEvent("blocks.clear"),t)try{Blockly.Events.disable(),t.clear(),t.clearUndo()}finally{Blockly.Events.enable()}},p.saveWorkspaceXml=function(t,e){var i=Blockly.Xml.workspaceToDom(t,!e);return Blockly.Xml.domToText(i)},p.getDirectChildren=u,p.getBlocksWithType=d,p.getChildrenWithAttr=h,p.getFirstChildWithAttr=c,p.loadWorkspaceXml=function(t,e){void 0===e&&(e=!1);var i=new Blockly.Workspace;try{var o=Blockly.Xml.textToDom(t);return f.blocks.domToWorkspaceNoEvents(o,i),i}catch(t){return e||f.reportException(t),null}},p.importXml=function(t,e,i,o){void 0===o&&(o=!1);try{f.blocks.initializeAndInject(i);var r=(new DOMParser).parseFromString(e,"application/xml"),n=f.patching.computePatches(t);n&&(n.filter(function(t){return"blockId"==t.type}).forEach(function(i){return Object.keys(i.map).forEach(function(e){d(r,e).forEach(function(t){t.setAttribute("type",i.map[e]),f.debug("patched block "+e+" -> "+i.map[e])})})}),n.filter(function(t){return"blockValue"==t.type}).forEach(function(o){return Object.keys(o.map).forEach(function(e){var t=e.split("."),i=t[0];t[1],d(r,i).reduce(function(t,e){return t.concat(u(e,"value"))},[]).forEach(function(t){t.setAttribute("name",o.map[e]),f.debug("patched block value "+e+" -> "+o.map[e])})})}),n.filter(function(t){return"userenum"==t.type}).forEach(function(i){return Object.keys(i.map).forEach(function(e){h(r,"variable","type",e).forEach(function(t){t.setAttribute("type",i.map[e]),f.debug("patched enum variable type "+e+" -> "+i.map[e])})})}));var l={};Object.keys(i.apis.byQName).forEach(function(t){var e=i.apis.byQName[t];7==e.kind&&(l[e.namespace+"."+(e.attributes.blockImportId||e.attributes.block||e.attributes.blockId||e.name)]=e.namespace+"."+e.name)});for(var a=r.getElementsByTagName("block"),s=0;s<a.length;++s)m(i,l,a[s]);return function(e,t){var i=d(e,ts.pxtc.ON_START_TYPE),o=i.length?i[0]:void 0;if(o)o.removeAttribute("deletable");else{for(var r=[],n=t.blocksById,l=e.firstElementChild,a=void 0;l;){var s=l.nextElementSibling,c=l.getAttribute("type");if(!l.getAttribute("disabled")&&!l.getElementsByTagName("statement").length&&(f.blocks.buildinBlockStatements[c]||n[c]&&"void"==n[c].retType&&!p.hasArrowFunction(n[c])))if(a){var u=e.ownerDocument.createElement("next");u.appendChild(l),a.appendChild(u),l.removeAttribute("x"),l.removeAttribute("y"),a=l}else(a=e.ownerDocument.createElement("statement")).setAttribute("name","HANDLER"),o||((o=e.ownerDocument.createElement("block")).setAttribute("type",ts.pxtc.ON_START_TYPE),r.push(o)),o.appendChild(a),a.appendChild(l),l.removeAttribute("x"),l.removeAttribute("y"),a=l;l=s}r.forEach(function(t){return e.appendChild(t)})}}(r.documentElement,i),c=r.documentElement,f.U.toArray(c.querySelectorAll("block[type=procedures_defnoreturn]")).forEach(function(t){t.setAttribute("type","function_definition"),t.querySelector("field[name=NAME]").setAttribute("name","function_name")}),f.U.toArray(c.querySelectorAll("block[type=procedures_callnoreturn]")).forEach(function(t){t.setAttribute("type","function_call"),t.querySelector("field[name=NAME]").setAttribute("name","function_name")}),f.blocks.extensionBlocklyPatch&&f.blocks.extensionBlocklyPatch(t,r.documentElement),(new XMLSerializer).serializeToString(r)}catch(t){return o||f.reportException(t),e}var c}}(f.blocks||(f.blocks={}))}(pxt||(pxt={})),function(y){var t;(function(t){function i(t,e){return o(t).then(function(t){return t?p(t.width,t.height,0|e||4,t.xml):Promise.resolve(void 0)}).catch(function(t){y.reportException(t)})}t.patchBlocksFromOldWorkspace=function(t,e,i){var r,n,l,a,s,o,c,u,p,d=y.blocks.loadWorkspaceXml(i,!0);return r=t,l=d,(n=e).getTopBlocks(!1).filter(function(t){return!t.disabled}).forEach(function(t){var e=t.xy_;if(e&&0!=e.x&&0!=e.y){a||(a=y.blocks.mkEnv(n,r),s={},l.getTopBlocks(!1).forEach(function(t){var e=y.blocks.callKey(a,t),i=s[e]||[];i.push(t),s[e]=i}));var i=y.blocks.callKey(a,t),o=(s[i]||[]).shift();o&&(o.xy_=e.clone())}}),o=e,c=d,u=Blockly.Xml.workspaceToDom(o,!0),p=Blockly.Xml.workspaceToDom(c,!0),y.Util.toArray(u.childNodes).filter(function(t){return t.nodeType==Node.ELEMENT_NODE&&"block"==t.localName&&"true"==t.getAttribute("disabled")}).forEach(function(t){return p.appendChild(p.ownerDocument.importNode(t,!0))}),Blockly.Xml.domToText(p)},t.splitSvg=function(d,t,h){void 0===h&&(h=18);var e=t.getTopComments(!0),i=t.getTopBlocks(!0);if(e.length+i.length<2)return d;var m=document.createElement("div");function r(t,e,i,o,r){var n=d.cloneNode(!0),l=n.querySelector("g.blocklyWorkspace > g."+t),a=n.querySelector("g.blocklyWorkspace > g."+e),s=y.Util.toArray(l.querySelectorAll("g.blocklyWorkspace > g."+t+" > g")),c=s.splice(i,1)[0];if(c){s.filter(function(t){return t!=c}).forEach(function(t){t.parentNode.removeChild(t)}),l.removeAttribute("transform"),a.parentNode.removeChild(a),c.setAttribute("transform","translate("+r.x+", "+r.y+")");var u=o.width/h+"em",p=o.height/h+"em";n.setAttribute("viewBox","0 0 "+o.width+" "+o.height),n.style.width=u,n.style.height=p,n.setAttribute("width",u),n.setAttribute("height",p),m.appendChild(n)}else y.log("missing block, did block failed to load?")}return m.className="blocks-svg-list",e.forEach(function(t,e){return r("blocklyBubbleCanvas","blocklyBlockCanvas",e,t.getHeightWidth(),{x:0,y:0})}),i.forEach(function(t,e){var i=t.getHeightWidth(),o={x:0,y:0};t.getStartHat()&&(i.height+=h,o.y+=h),r("blocklyBlockCanvas","blocklyBubbleCanvas",e,i,o)}),m},t.verticalAlign=function(t,i){var o=0;t.getTopComments(!0).forEach(function(t){t.moveBy(0,o),o+=t.getHeightWidth().height,o+=i}),t.getTopBlocks(!0).forEach(function(t,e){t.getStartHat()&&(o+=i),t.moveBy(0,o),o+=t.getHeightWidth().height,o+=i})},t.flow=function(t,e){if(e){if(e.useViewWidth){var i=t.getMetrics();if(i.viewHeight>i.viewWidth)return void r(t.getTopComments(!0),t.getTopBlocks(!0),void 0,i.viewWidth)}r(t.getTopComments(!0),t.getTopBlocks(!0),e.ratio)}else r(t.getTopComments(!0),t.getTopBlocks(!0))},t.screenshotEnabled=function(){return!y.BrowserUtils.isIE()&&!y.BrowserUtils.isUwpEdge()},t.screenshotAsync=function(t,e){return i(t,e)},t.toPngAsync=i;var c=1e6;function p(n,l,a,s){return new Promise(function(e,t){var i=document.createElement("canvas"),o=i.getContext("2d"),r=new Image;i.width=n*a,i.height=l*a,r.onload=function(){o.drawImage(r,0,0,n,l,0,0,i.width,i.height);for(var t=i.toDataURL("image/png");t.length>c;)i.width=i.width/2>>0,i.height=i.height/2>>0,y.log("screenshot size "+t.length+"b, shrinking to "+i.width+"x"+i.height),o.drawImage(r,0,0,n,l,0,0,i.width,i.height),t=i.toDataURL("image/png");e(t)},r.onerror=function(t){y.reportError("blocks","blocks screenshot failed"),e(void 0)},r.src=s})}var d,h,m="http://www.w3.org/1999/xlink";function o(t){if(!t)return Promise.resolve(void 0);var e=t.getBlocksBoundingBox(),i=t.getParentSvg().cloneNode(!0);n(i);var o=e.right-e.left,r=e.bottom-e.top;return l(i,e.left,e.top,o,r)}function f(t){return e((new XMLSerializer).serializeToString(t))}function e(t){return t.replace(new RegExp("&nbsp;","g"),"&#160;")}function n(t){y.BrowserUtils.removeClass(t,"blocklySvg"),y.BrowserUtils.addClass(t,"blocklyPreview"),y.U.toArray(t.querySelectorAll(".blocklyMainBackground,.blocklyScrollbarBackground")).forEach(function(t){t&&t.parentNode.removeChild(t)}),t.removeAttribute("width"),t.removeAttribute("height"),y.U.toArray(t.querySelectorAll(".blocklyBlockCanvas,.blocklyBubbleCanvas")).forEach(function(t){return t.removeAttribute("transform")});var i=new DOMParser;return y.U.toArray(t.querySelectorAll(".blocklyCommentTextarea")).forEach(function(t){var e=i.parseFromString("<!doctype html><body>"+y.docs.html2Quote(t.value),"text/html");t.textContent=e.body.textContent}),t}function l(t,e,i,o,r){if(!t.childNodes[0])return Promise.resolve(void 0);t.removeAttribute("width"),t.removeAttribute("height"),t.removeAttribute("transform");var n=f(t).replace(/^\s*<svg[^>]+>/i,"").replace(/<\/svg>\s*$/i,""),l='<svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="'+m+'" width="'+o+'" height="'+r+'" viewBox="'+e+" "+i+" "+o+" "+r+'">'+n+"</svg>",a=(new DOMParser).parseFromString(l,"image/svg+xml"),s=a.createElementNS("http://www.w3.org/1999/xhtml","style"),c=y.Util.isUserLanguageRtl(),u=document.getElementById("style-"+(c?"rtl":"")+"blockly.css").href;return y.BrowserUtils.loadAjaxAsync(u).then(function(t){var e=y.Util.toArray(document.head.querySelectorAll("style")).filter(function(t){return/\.blocklySvg/.test(t.innerText)})[0],i=(e?e.innerText:"")+"\n\n"+t+"\n\n";return s.appendChild(a.createCDATASection(i)),a.documentElement.insertBefore(s,a.documentElement.firstElementChild),function(t){d||(d={});var e=t.getElementsByTagName("image"),i=y.Util.toArray(e).filter(function(t){var e=t.getAttributeNS(m,"href");return e&&!/^data:/.test(e)}).map(function(e){var o=e.getAttributeNS(m,"href"),r=d[o];return(r?Promise.resolve(d[o]):y.BrowserUtils.loadImageAsync(e.getAttributeNS(m,"href")).then(function(t){var e=document.createElement("canvas"),i=e.getContext("2d");return e.width=t.width,e.height=t.height,i.drawImage(t,0,0,t.width,t.height,0,0,e.width,e.height),d[o]=r=e.toDataURL("image/png"),r}).catch(function(t){y.debug("svg render: failed to load "+o)})).then(function(t){e.setAttributeNS(m,"href",t)})});return Promise.all(i).then(function(){})}(a).then(function(){return function(t){if(h||(h={}),!y.BrowserUtils.isEdge())return Promise.resolve();var e=t.getElementsByTagName("image"),i=y.Util.toArray(e).filter(function(t){return/^data:image\/svg\+xml/.test(t.getAttributeNS(m,"href"))}).map(function(e){var i=e.getAttributeNS(m,"href"),t=parseInt(e.getAttribute("width").replace(/[^0-9]/g,"")),o=parseInt(e.getAttribute("height").replace(/[^0-9]/g,"")),r=h[i];return(r?Promise.resolve(r):p(t,o,4,i)).then(function(t){h[i]=t,e.setAttributeNS(m,"href",t)})});return Promise.all(i).then(function(){})}(a)}).then(function(){return{width:o,height:r,svg:f(a).replace('<style xmlns="http://www.w3.org/1999/xhtml">',"<style>"),xml:g(a),css:i}})})}function g(t){var e=(new XMLSerializer).serializeToString(t);return"data:image/svg+xml;base64,"+ts.pxtc.encodeBase64(unescape(encodeURIComponent(e)))}function r(t,e,i,o){void 0===i&&(i=1.62);var a,s=[],c={};t.forEach(function(t){var e=t.data;null!=e?c[e]=t:s.push(b(t))}),e.forEach(function(t){var e=t.data;if(e){for(var i=e.split(";"),o=[],r=0;r<i.length;r++){var n=c[i[r]];n&&(o.push(b(n)),delete c[i[r]])}if(o.length)return void s.push({value:t,width:-1,height:-1,children:o})}var l=b(t);a||t.disabled||t.type!==pxtc.ON_START_TYPE?s.push(l):a=l}),a&&s.unshift(a),Object.keys(c).sort(function(t,e){return t.length===e.length?e<t?-1:1:t.length>e.length?-1:1}).forEach(function(t){c[t]&&(a?(a.children||(a.children=[]),a.children.push(b(c[t]))):s.unshift(b(c[t])))});for(var r,n=0,l=0;l<s.length;l++){if((y=s[l]).children){var u=y.value.getHeightWidth();y.x=0,y.y=0;for(var p=u.width+13,d=0,h=0;h<y.children.length;h++)(k=y.children[h]).x=p,k.y=d,d+=k.height+13,y.width=Math.max(y.width,p+k.width);y.height=Math.max(d-13,u.height)}n+=(y.height+13)*(y.width+13)}r=20<o?o-20:Math.sqrt(n)*i;var m=20,f=20,g=0;for(l=0;l<s.length;l++){var y;if((y=s[l]).children)for(v(y,m+y.x,f+y.y),h=0;h<y.children.length;h++){var k;v(k=y.children[h],m+k.x,f+k.y)}else v(y,m,f);m+=y.width+45,g=Math.max(g,f+y.height+45),r<m&&(m=20,f=g)}function v(t,e,i){var o=t.value.getBoundingRectangle();t.value.moveBy(e-o.left,i-o.top)}}function b(t){var e=t.getHeightWidth();return{value:t,height:e.height,width:e.width}}t.toSvgAsync=o,t.serializeNode=f,t.serializeSvgString=e,t.cleanUpBlocklySvg=n,t.blocklyToSvgAsync=l,t.documentToSvg=g})((t=y.blocks||(y.blocks={})).layout||(t.layout={}))}(pxt||(pxt={})),function(V){!function(R){var y={string:{field:"TEXT",block:"text",defaultValue:""},number:{field:"NUM",block:"math_number",defaultValue:"0"},boolean:{field:"BOOL",block:"logic_boolean",defaultValue:"false"},Array:{field:"VAR",block:"variables_get",defaultValue:"list"}};function k(t){var e=/^(?:Array<(.+)>)|(?:(.+)\[\])|(?:\[.+\])$/.exec(t);return e?e[1]?e[1]:e[2]:void 0}R.optionalDummyInputPrefix="0_optional_dummy",R.optionalInputWithFieldPrefix="0_optional_field",R.isArrayType=k,R.isTupleType=function(t){var e=/^\[(.+)\]$/.exec(t);return e?e[1].split(/,\s*/):void 0};var e,h,o=/^(string|number|boolean)$/;function c(){return e||(e={},Object.keys(Blockly.Blocks).forEach(function(t){return e[t]={block:Blockly.Blocks[t]}})),e}R.builtinBlocks=c,R.buildinBlockStatements={controls_if:!0,controls_for:!0,pxt_controls_for:!0,controls_simple_for:!0,controls_repeat_ext:!0,pxt_controls_for_of:!0,controls_for_of:!0,variables_set:!0,variables_change:!0,device_while:!0};var u={};function r(t,e,i,o){var r;if(o=o||e.defaultValue,!(i=i||e.shadowBlockId)&&e.range&&(i="math_number_minmax"),r=o&&'"'==o.slice(0,1)?JSON.parse(o):o,"number"==e.type&&"value"==i)return(m=document.createElement("field")).setAttribute("name",e.definitionName),m.appendChild(document.createTextNode("0")),m;var n="variables_get"==i,l=document.createElement("value");l.setAttribute("name",e.definitionName);var a=k(e.type),s=document.createElement(n||a?"block":"shadow");l.appendChild(s);var c,u=y[a||e.type];if(s.setAttribute("type",i||(a?"lists_create_with":u&&u.block||e.type)),s.setAttribute("colour",Blockly.Colours.textField),a){if(u&&!i){var p=void 0;switch(a){case"number":p=["1","2","3"];break;case"string":p=["a","b","c"];break;case"boolean":p=["FALSE","FALSE","FALSE"]}return v(s,u.block,u.field,p),l}if(i&&r)return v(s,r),l}if(!u||i&&u.block!==i&&"math_number_minmax"!==i){if(r){if((m=document.createElement("field")).textContent=r,n)m.setAttribute("name","VAR"),s.appendChild(m);else if(i){var d=t.blocksById[i];if(d&&d.attributes._def&&d.attributes._def.parameters.length){var h=d.attributes._def.parameters[0];m.setAttribute("name",h.name),s.appendChild(m)}}else m.setAttribute("name",e.definitionName),s.appendChild(m)}}else{var m=document.createElement("field");s.appendChild(m);var f,g=void 0;switch(i){case"variables_get":g="VAR";break;case"math_number_minmax":g="SLIDER";break;default:g=u.field}m.setAttribute("name",g),f="boolean"==e.type?document.createTextNode((r||u.defaultValue).toUpperCase()):document.createTextNode(r||u.defaultValue),m.appendChild(f)}return e.range&&((c=document.createElement("mutation")).setAttribute("min",e.range.min.toString()),c.setAttribute("max",e.range.max.toString()),c.setAttribute("label",e.actualName.charAt(0).toUpperCase()+e.actualName.slice(1)),e.fieldOptions&&(e.fieldOptions.step&&c.setAttribute("step",e.fieldOptions.step),e.fieldOptions.color&&c.setAttribute("color",e.fieldOptions.color),e.fieldOptions.precision&&c.setAttribute("precision",e.fieldOptions.precision))),e.fieldOptions&&(c||(c=document.createElement("mutation")),c.setAttribute("customfield",JSON.stringify(e.fieldOptions))),c&&s.appendChild(c),l}function v(t,e,i,o){var r=o?o.length:2,n=document.createElement("mutation");n.setAttribute("items",""+r),t.appendChild(n);for(var l=0;l<r;l++){var a=document.createElement("value");a.setAttribute("name","ADD"+l);var s=document.createElement("shadow");if(s.setAttribute("type",e),i){var c=document.createElement("field");c.setAttribute("name",i),o&&c.appendChild(document.createTextNode(o[l])),s.appendChild(c)}a.appendChild(s),t.appendChild(a)}}function f(t,e,i,o){var r=n(t,V.toolbox.convertColor(e),i,o);return r.setAttribute("web-class","blocklyFlyoutHeading"),r}function n(t,e,i,o){var r=Blockly.utils.xml.createElement("label");return r.setAttribute("text",t),e&&r.setAttribute("web-icon-color",V.toolbox.convertColor(e)),i&&(1===i.length?(r.setAttribute("web-icon",i),o&&r.setAttribute("web-icon-class",o)):r.setAttribute("web-icon-class","blocklyFlyoutIcon"+t)),r}function l(e,a,t){var s=document.createElement("block");if(s.setAttribute("type",a.attributes.blockId),a.attributes.blockGap?s.setAttribute("gap",a.attributes.blockGap):V.appTarget.appTheme&&V.appTarget.appTheme.defaultBlockGap&&s.setAttribute("gap",V.appTarget.appTheme.defaultBlockGap.toString()),t.thisParameter){var i=t.thisParameter;s.appendChild(r(e,i,i.shadowBlockId||"variables_get",i.defaultValue||i.definitionName))}return a.parameters&&(t.parameters.filter(function(t){return!t.isOptional&&(o.test(t.type)||o.test(k(t.type))||t.shadowBlockId||t.defaultValue)}).forEach(function(t){s.appendChild(r(e,t))}),a.attributes.draggableParameters?t.handlerArgs.forEach(function(t){var e="reporter"===a.attributes.draggableParameters,i=document.createElement("value");i.setAttribute("name","HANDLER_DRAG_PARAM_"+t.name);var o=e?V.blocks.reporterTypeForArgType(t.type):"variables_get_reporter",r=document.createElement("shadow");if(r.setAttribute("type",o),e&&"argument_reporter_custom"===o){var n=document.createElement("mutation");n.setAttribute("typename",t.type),r.appendChild(n)}var l=document.createElement("field");l.setAttribute("name",e?"VALUE":"VAR"),l.textContent=V.Util.htmlEscape(t.name),r.appendChild(l),i.appendChild(r),s.appendChild(i)}):t.handlerArgs.forEach(function(t){var e=document.createElement("field");e.setAttribute("name","HANDLER_"+t.name),e.textContent=t.name,s.appendChild(e)})),s}function i(o){return h=o,Blockly.pxtBlocklyUtils.whitelistDraggableBlockTypes(o.blocks.filter(function(t){return t.attributes.duplicateShadowOnDrag}).map(function(t){return t.attributes.blockId})),o.blocks.map(function(t){if(t.attributes.blockBuiltin)V.Util.assert(!!c()[t.attributes.blockId]),c()[t.attributes.blockId].symbol=t;else{var e=R.compileInfo(t),i=l(o,t,e);!function(t,e,i,o){var r=e.attributes.blockId;if(c()[r])return V.reportError("blocks","trying to override builtin block",{details:r});var n=JSON.stringify(e);if(u[r]&&u[r].hash==n)return;if(Blockly.Blocks[e.attributes.blockId])return console.error("duplicate block definition: "+r);var l={hash:n,fn:e,block:{codeCard:(a=e,s=o,{name:a.namespace+"."+a.name,shortName:a.name,description:a.attributes.jsDoc,url:a.attributes.help?"reference/"+a.attributes.help.replace(/^\//,""):void 0,blocksXml:'<xml xmlns="http://www.w3.org/1999/xhtml">'+p(s)+"</xml>"}),init:function(){!function(n,w,S,D){var t=(S.attributes.blockNamespace||S.namespace).split(".")[0],L=1==S.kind||2==S.kind,e=w.apis.byQName[t],O=S.attributes.blockNamespace&&e&&e.attributes.color||S.attributes.color||e&&e.attributes.color||V.toolbox.getNamespaceColor(t)||255;if(S.attributes.help)n.setHelpUrl("/reference/"+S.attributes.help.replace(/^\//,""));else if(S.pkg&&!V.appTarget.bundledpkgs[S.pkg]){var i=S.qName.toLowerCase().split(".");i[0]==S.pkg&&i.shift(),n.setHelpUrl("/pkg/"+S.pkg+"#"+encodeURIComponent(i.join("-")))}n.setColour(O,S.attributes.colorSecondary,S.attributes.colorTertiary);var o=Blockly.OUTPUT_SHAPE_ROUND;"boolean"==S.retType&&(o=Blockly.OUTPUT_SHAPE_HEXAGONAL);n.setOutputShape(o),S.attributes.undeletable&&n.setDeletable(!1);d(S.attributes._def);var r=!1;if(S.attributes.mutate)R.addMutation(n,S,S.attributes.mutate);else if(S.attributes.defaultInstance)R.addMutation(n,S,R.MutatorTypes.DefaultInstanceMutator);else if(S.attributes._expandedDef&&"disabled"!==S.attributes.expandableArgumentMode){var l="toggle"===S.attributes.expandableArgumentMode;R.initExpandableBlock(w,n,S.attributes._expandedDef,D,l,function(){return d(S.attributes._expandedDef,!0)})}else if(D.handlerArgs.length)if(r=!0,S.attributes.optionalVariableArgs)R.initVariableArgsBlock(n,D.handlerArgs);else if(S.attributes.draggableParameters)D.handlerArgs.filter(function(t){return!t.inBlockDef}).forEach(function(t){var e=n.appendValueInput("HANDLER_DRAG_PARAM_"+t.name);"reporter"==S.attributes.draggableParameters?e.setCheck(F(t.type,w)):e.setCheck("Variable")});else{var a=n.appendDummyInput();D.handlerArgs.filter(function(t){return!t.inBlockDef}).forEach(function(t){a.appendField(new Blockly.FieldVariable(t.name),"HANDLER_"+t.name)})}if(R.appendMutation(n,{mutationToDom:function(i){return n.inputList.forEach(function(t){t.fieldRow.forEach(function(t){if(t.isFieldCustom_&&t.saveOptions){var e=t.saveOptions();e&&i.setAttribute("customfield",JSON.stringify(e))}})}),i},domToMutation:function(i){n.inputList.forEach(function(t){t.fieldRow.forEach(function(t){if(t.isFieldCustom_&&t.restoreOptions){var e=JSON.parse(i.getAttribute("customfield"));e&&t.restoreOptions(e)}})})}}),S.attributes.imageLiteral){var s=(S.attributes.imageLiteralColumns||5)*S.attributes.imageLiteral,c=S.attributes.imageLiteralRows||5,u=n.appendDummyInput();u.appendField(new pxtblockly.FieldMatrix("",{columns:s,rows:c}),"LEDS")}"external"===S.attributes.inlineInputMode?n.setInputsInline(!1):"inline"===S.attributes.inlineInputMode?n.setInputsInline(!0):n.setInputsInline(!S.parameters||S.parameters.length<4&&!S.attributes.imageLiteral);((S.parameters?S.parameters.filter(function(t){return"() => void"==t.type||"Action"==t.type})[0]:void 0)||r)&&(n.appendStatementInput("HANDLER").setCheck(null),n.setInputsInline(!0));g(n,S.retType,w);var p=m(S);function d(t,o){void 0===o&&(o=!1);var r=0,I=!o&&!!D.thisParameter,e=function(t){var e=[],i=[];return t.parts.forEach(function(t){switch(t.kind){case"break":o();break;case"param":i.push(t),o();break;case"image":case"label":i.push(t)}}),o(),e;function o(){i.length&&(e.push(i),i=[])}}(t),N=new V.ImageConverter;"ENUM_GET"!==S.attributes.shim&&"KIND_GET"!==S.attributes.shim||!(1<D.parameters.length||D.thisParameter)?(e.forEach(function(t){var E,B,e,C=[],A=!1;if(t.forEach(function(t){if("param"!==t.kind){var e=function(t){if("image"===t.kind)return function(t){var e=M[t];if(!e)return void V.log("missing jres icon "+t);return new Blockly.FieldImage(e,40,40,"",null,V.Util.isUserLanguageRtl())}(t.uri);var e=function(t){{if(" "===t)return"";if(1<t.length){var e=" "==t.charAt(0),i=" "==t.charAt(t.length-1);if(e||i)return t.substring(e?1:0,i?t.length-1:t.length)}}return t}(t.text);if(!e)return;return t.cssClass?new Blockly.FieldLabel(e,t.cssClass):t.style.length?new pxtblockly.FieldStyledLabel(e,{bold:-1!==t.style.indexOf("bold"),italics:-1!==t.style.indexOf("italics"),blocksInfo:void 0}):new Blockly.FieldLabel(e,void 0)}(t);e&&C.push({field:e})}else{if("ENUM_GET"===S.attributes.shim)return V.U.assert(!!S.attributes.enumName,"Trying to create an ENUM_GET block without a valid enum name"),void C.push({name:"MEMBER",field:new pxtblockly.FieldUserEnum(w.enumsByName[S.attributes.enumName])});if("KIND_GET"===S.attributes.shim)return void C.push({name:"MEMBER",field:new pxtblockly.FieldKind(w.kindsByName[S.attributes.kindNamespace||S.attributes.blockNamespace||S.namespace])});var i=function(e,t,i){void 0===i&&(i=!1);{if(e.ref){var o,r="this"===e.name?t.thisParameter:t.actualNameToParam[e.name];if(!r)if(t.handlerArgs.forEach(function(t){t.name===e.name&&(o=t)}),o)return o;return r}return i?t.thisParameter:t.definitionNameToParam[e.name]}}(t,D,I);if(I=!1,!i)return void console.error("block "+S.attributes.blockId+": unknown parameter "+t.name+(t.ref?" ("+t.ref+")":""));if(!i.definitionName)return E="HANDLER_DRAG_PARAM_"+i.name,void(B="reporter"===S.attributes.draggableParameters?F(i.type,w):"Variable");var o=V.U.lookup(w.apis.byQName,i.type);A=!0;var r=i.definitionName,n=i.actualName,l=o&&6==o.kind,a=o&&!!o.attributes.fixedInstances&&!i.shadowBlockId,s=!!S.attributes.constantShim,c="@combined@"==i.type,u=i.fieldEditor,p=r.charAt(0).toUpperCase()+r.slice(1),d=i.type;if(l||a||s||c){var h=void 0;l?(T=w.apis,x=i.type,h=V.Util.values(T.byQName).filter(function(t){return t.namespace===x&&!t.attributes.blockHidden})):a?h=U(w.apis,o.qName):c?h=S.combinedProperties.map(function(t){return V.U.lookup(w.apis.byQName,t)}):(b=w.apis,_=S.qName,h=V.Util.values(b.byQName).filter(function(t){return t.attributes.blockIdentity===_})),0==h.length&&console.error("no instances of "+o.qName+" found");var m=h.map(function(t){var e=t.attributes.block||t.attributes.blockId||t.name,i=t.attributes.blockCombine;return t.attributes.jresURL&&!t.attributes.iconURL&&V.U.startsWith(t.attributes.jresURL,"data:image/x-mkcd-f")&&(t.attributes.iconURL=N.convert(t.attributes.jresURL)),i&&(e=e.replace(/@set/,"")),[t.attributes.iconURL||t.attributes.blockImage?{src:t.attributes.iconURL||V.Util.pathJoin(V.webConfig.commitCdnUrl,"blocks/"+t.namespace.toLowerCase()+"/"+t.name.toLowerCase()+".png"),alt:e,width:36,height:36,value:t.name}:e,t.namespace+"."+t.name]});if(i.defaultValue){var f=-1;if(m.some(function(t,e){return t[1]===i.defaultValue&&(f=e,!0)}),-1<f){var g=m.splice(f,1)[0];m.unshift(g)}}if(u){var y=S.attributes.paramDefl[n]||"",k={data:m,colour:O,label:p,type:d,blocksInfo:w};V.Util.jsonMergeFrom(k,S.attributes.paramFieldEditorOptions&&S.attributes.paramFieldEditorOptions[n]||{}),C.push(P(R.createFieldEditor(u,y,k),r))}else C.push(P(new Blockly.FieldDropdown(m),r))}else if(u){var y=S.attributes.paramDefl[i.actualName]||"",v={colour:O,label:p,type:d,blocksInfo:w};V.Util.jsonMergeFrom(v,S.attributes.paramFieldEditorOptions&&S.attributes.paramFieldEditorOptions[i.actualName]||{}),C.push(P(R.createFieldEditor(u,y,v),i.definitionName))}else E=r,L&&"this"===t.name?B=i.type:"number"==i.type&&i.shadowBlockId&&"value"==i.shadowBlockId?(E=void 0,C.push(P(new Blockly.FieldTextInput("0",Blockly.FieldTextInput.numberValidator),r))):B="string"==i.type&&i.shadowOptions&&i.shadowOptions.toString?null:F(i.type,w)}var b,_,T,x}),E)(e=n.appendValueInput(E)).setAlign(Blockly.ALIGN_LEFT);else if(o){var i=A?R.optionalInputWithFieldPrefix:R.optionalDummyInputPrefix;e=n.appendDummyInput(i+r++)}else e=n.appendDummyInput();B&&e.setCheck(B),C.forEach(function(t){return e.appendField(t.field,t.name)})}),N.logTime()):console.warn("Enum blocks may only have 1 parameter but "+S.attributes.blockId+" has "+D.parameters.length)}n.setPreviousStatement(!(p&&!S.attributes.handlerStatement)&&"void"==S.retType),n.setNextStatement(!(p&&!S.attributes.handlerStatement)&&"void"==S.retType),n.setTooltip(/^__/.test(S.namespace)?"":S.attributes.jsDoc)}(this,t,e,i)}}};var a,s;V.Util.isTranslationMode()&&V.blocks.promptTranslateBlock&&(l.block.customContextMenu=function(t){e.attributes.translationId&&t.push({enabled:!0,text:lf("Translate this block"),callback:function(){V.blocks.promptTranslateBlock(r,[e.attributes.translationId])}})});u[r]=l,Blockly.Blocks[r]=l.block}(o,t,e,i)}return t})}function p(t){return t.outerHTML.replace(/^<\?[^>]*>/,"")}function m(t){return!!(t.parameters?t.parameters.filter(function(t){return"Action"===t.type||/^\([^\)]*\)\s*=>/.test(t.type)})[0]:void 0)}R.blockSymbol=function(t){var e=u[t];return e?e.fn:void 0},R.createShadowValue=r,R.createFlyoutHeadingLabel=f,R.createFlyoutGroupLabel=function(t,e,i,o){var r=n(t,void 0,e);return r.setAttribute("web-class","blocklyFlyoutGroup"),r.setAttribute("web-line","1.5"),i&&r.setAttribute("web-line-width",i),o&&(r.setAttribute("web-help-button","true"),r.setAttribute("callbackKey",o)),r},R.createFlyoutButton=function(t,e){var i=Blockly.utils.xml.createElement("button");return i.setAttribute("text",e),i.setAttribute("callbackKey",t),i},R.createToolboxBlock=l,R.injectBlocks=i,R.hasArrowFunction=m,R.cleanBlocks=function(){for(var t in V.debug("removing all custom blocks"),u)s(u[t].fn)},R.initializeAndInject=function(t){a(),i(t)};var t=!(R.initialize=function(t){a(),function(t){M={};var i=t.apis.jres;i&&Object.keys(i).forEach(function(t){var e=i[t];e&&e.icon&&(M[t]=e.icon)})}(t)});function a(){var m,a;t||(t=!0,goog.provide("Blockly.Blocks.device"),goog.require("Blockly.Blocks"),Blockly.FieldCheckbox.CHECK_CHAR="■",Blockly.BlockSvg.START_HAT=!!V.appTarget.appTheme.blockHats,R.initFieldEditors(),(m=Blockly.Msg).DUPLICATE_BLOCK=lf("{id:block}Duplicate"),m.REMOVE_COMMENT=lf("Remove Comment"),m.ADD_COMMENT=lf("Add Comment"),m.EXTERNAL_INPUTS=lf("External Inputs"),m.INLINE_INPUTS=lf("Inline Inputs"),m.EXPAND_BLOCK=lf("Expand Block"),m.COLLAPSE_BLOCK=lf("Collapse Block"),m.ENABLE_BLOCK=lf("Enable Block"),m.DISABLE_BLOCK=lf("Disable Block"),m.DELETE_BLOCK=lf("Delete Block"),m.DELETE_X_BLOCKS=lf("Delete Blocks"),m.DELETE_ALL_BLOCKS=lf("Delete All Blocks"),m.HELP=lf("Help"),Blockly.BlockSvg.prototype.showHelp_=function(){var t=goog.isFunction(this.helpUrl)?this.helpUrl():this.helpUrl;t&&(V.blocks.openHelpUrl||window.open)(t)},Blockly.WorkspaceSvg.prototype.showContextMenu_=function(t){var e=this;if(!this.options.readOnly&&!this.isFlyout){var i=[],o=this.getTopBlocks(),r=this.getTopComments(),n=Blockly.utils.genUid();this.options.comments&&!V.BrowserUtils.isIE()&&i.push(Blockly.ContextMenu.workspaceCommentOption(this,t));for(var l=10,a=Blockly.WorkspaceSvg.buildDeleteList_(o),s=0,c=0;c<a.length;c++)a[c].isShadow()||s++;var u={text:1==s?m.DELETE_BLOCK:m.DELETE_ALL_BLOCKS,enabled:0<s,callback:function(){V.tickEvent("blocks.context.delete",void 0,{interactiveConsent:!0}),s<2?h():Blockly.confirm(lf("Delete all {0} blocks?",s),function(t){t&&h()})}};i.push(u);var p={text:lf("Format Code"),enabled:!0,callback:function(){V.tickEvent("blocks.context.format",void 0,{interactiveConsent:!0}),V.blocks.layout.flow(e,{useViewWidth:!0})}};if(i.push(p),V.blocks.layout.screenshotEnabled()){var d={text:lf("Snapshot"),enabled:0<o.length||0<r.length,callback:function(){V.tickEvent("blocks.context.screenshot",void 0,{interactiveConsent:!0}),V.blocks.layout.screenshotAsync(e).done(function(t){V.BrowserUtils.isSafari()&&(t=t.replace(/^data:image\/[^;]/,"data:application/octet-stream")),V.BrowserUtils.browserDownloadDataUri(t,(V.appTarget.nickname||V.appTarget.id)+"-"+lf("screenshot")+".png")})}};i.push(d)}R.onShowContextMenu&&R.onShowContextMenu(this,i),Blockly.ContextMenu.show(t,i,this.RTL)}function h(){Blockly.Events.setGroup(n);var t=a.shift();t&&(t.workspace?(t.dispose(!1,!0),setTimeout(h,l)):h()),Blockly.Events.setGroup(!1)}},Blockly.Constants.Logic.LOGIC_COMPARE_ONCHANGE_MIXIN.onchange=function(){},function(){var t=V.blocks.getBlockDefinition(ts.pxtc.ON_START_TYPE);if(Blockly.Blocks[ts.pxtc.ON_START_TYPE]={init:function(){this.jsonInit({message0:t.block.message0,args0:[{type:"input_dummy"},{type:"input_statement",name:"HANDLER"}],colour:(V.appTarget.runtime?V.appTarget.runtime.onStartColor:"")||V.toolbox.getNamespaceColor("loops")}),_(this,ts.pxtc.ON_START_TYPE,t.name,t.tooltip,t.url,String((V.appTarget.runtime?V.appTarget.runtime.onStartColor:"")||V.toolbox.getNamespaceColor("loops")),void 0,void 0,!!V.appTarget.runtime&&V.appTarget.runtime.onStartUnDeletable)}},Blockly.Blocks[pxtc.TS_STATEMENT_TYPE]={init:function(){var r=this,n=this;n.setColour("#717171"),n.setPreviousStatement(!0),n.setNextStatement(!0),n.setInputsInline(!1),this.domToMutation=function(t){var e=parseInt(t.getAttribute("numlines"));r.declaredVariables=t.getAttribute("declaredvars");for(var i=0;i<e;i++){var o=t.getAttribute("line"+i);n.appendDummyInput().appendField(o,"LINE"+i)}},this.mutationToDom=function(){for(var t=document.createElement("mutation"),e=0;;){var i=n.getFieldValue("LINE"+e);if(null===i)break;t.setAttribute("line"+e,i),e++}return t.setAttribute("numlines",e.toString()),r.declaredVariables&&t.setAttribute("declaredvars",r.declaredVariables),t},n.setEditable(!1),_(this,pxtc.TS_STATEMENT_TYPE,lf("JavaScript statement"),lf("A JavaScript statement that could not be converted to blocks"),"/blocks/javascript-blocks","#717171")}},Blockly.Blocks[pxtc.TS_OUTPUT_TYPE]={init:function(){var t=this;t.setColour("#717171"),t.setPreviousStatement(!1),t.setNextStatement(!1),t.setOutput(!0),t.setEditable(!1),t.appendDummyInput().appendField(new pxtblockly.FieldTsExpression(""),"EXPRESSION"),_(t,pxtc.TS_OUTPUT_TYPE,lf("JavaScript expression"),lf("A JavaScript expression that could not be converted to blocks"),"/blocks/javascript-blocks","#717171")}},V.appTarget.runtime&&V.appTarget.runtime.pauseUntilBlock){var e=V.appTarget.runtime.pauseUntilBlock,i=V.blocks.getBlockDefinition(ts.pxtc.PAUSE_UNTIL_TYPE);Blockly.Blocks[pxtc.PAUSE_UNTIL_TYPE]={init:function(){var t=e.color||V.toolbox.getNamespaceColor("loops");this.jsonInit({message0:i.block.message0,args0:[{type:"input_value",name:"PREDICATE",check:"Boolean"}],inputsInline:!0,previousStatement:null,nextStatement:null,colour:t}),_(this,ts.pxtc.PAUSE_UNTIL_TYPE,i.name,i.tooltip,i.url,t,void 0,void 0,!1)}}}var o="pxt_controls_for_of",r=V.blocks.getBlockDefinition(o);Blockly.Blocks[o]={init:function(){this.jsonInit({message0:r.block.message0,args0:[{type:"input_value",name:"VAR",variable:r.block.variable,check:"Variable"},{type:"input_value",name:"LIST",check:"Array"}],previousStatement:null,nextStatement:null,colour:V.toolbox.blockColors.loops,inputsInline:!0}),this.appendStatementInput("DO").appendField(r.block.appendField);var t=this;_(this,o,r.name,function(){return V.U.rlf(r.tooltip,t.getInputTargetBlock("VAR")?t.getInputTargetBlock("VAR").getField("VAR").getText():"")},r.url,String(V.toolbox.getNamespaceColor("loops")))}};var n="controls_for_of",l=V.blocks.getBlockDefinition(n);Blockly.Blocks[n]={init:function(){this.jsonInit({message0:l.block.message0,args0:[{type:"field_variable",name:"VAR",variable:l.block.variable},{type:"input_value",name:"LIST",check:"Array"}],previousStatement:null,nextStatement:null,colour:V.toolbox.blockColors.loops,inputsInline:!0}),this.appendStatementInput("DO").appendField(l.block.appendField);var t=this;_(this,n,l.name,function(){return V.U.rlf(l.tooltip,t.getField("VAR").getText())},l.url,String(V.toolbox.getNamespaceColor("loops")))}};var a="lists_index_get",s=V.blocks.getBlockDefinition(a);Blockly.Blocks.lists_index_get={init:function(){this.jsonInit({message0:s.block.message0,args0:[{type:"input_value",name:"LIST",check:"Array"},{type:"input_value",name:"INDEX",check:"Number"}],colour:V.toolbox.blockColors.arrays,outputShape:Blockly.OUTPUT_SHAPE_ROUND,inputsInline:!0}),this.setPreviousStatement(!1),this.setNextStatement(!1),this.setOutput(!0),d(this,a)}};var c="lists_index_set",u=V.blocks.getBlockDefinition(c);Blockly.Blocks[c]={init:function(){this.jsonInit({message0:u.block.message0,args0:[{type:"input_value",name:"LIST",check:"Array"},{type:"input_value",name:"INDEX",check:"Number"},{type:"input_value",name:"VALUE",check:null}],previousStatement:null,nextStatement:null,colour:V.toolbox.blockColors.arrays,inputsInline:!0}),d(this,c)}}}(),function(){var t="math_op2",e=V.blocks.getBlockDefinition(t),i=e.tooltip;Blockly.Blocks[t]={init:function(){this.jsonInit({message0:lf("%1 of %2 and %3"),args0:[{type:"field_dropdown",name:"op",options:[[lf("{id:op}min"),"min"],[lf("{id:op}max"),"max"]]},{type:"input_value",name:"x",check:"Number"},{type:"input_value",name:"y",check:"Number"}],inputsInline:!0,output:"Number",outputShape:Blockly.OUTPUT_SHAPE_ROUND,colour:V.toolbox.getNamespaceColor("math")});_(this,t,e.name,function(t){return i[t.getFieldValue("op")]},e.url,V.toolbox.getNamespaceColor(e.category))}};var o="math_op3",r=V.blocks.getBlockDefinition(o);Blockly.Blocks[o]={init:function(){this.jsonInit({message0:r.block.message0,args0:[{type:"input_value",name:"x",check:"Number"}],inputsInline:!0,output:"Number",outputShape:Blockly.OUTPUT_SHAPE_ROUND,colour:V.toolbox.getNamespaceColor("math")}),d(this,o)}},["math_number","math_integer","math_whole_number","math_number_minmax"].forEach(function(t){var e=V.blocks.getBlockDefinition(t);T(t,e.name,e.tooltip,e.url,Blockly.Colours.textField,Blockly.Colours.textField,Blockly.Colours.textField)});var n=Blockly.Msg,l="math_arithmetic",a=V.blocks.getBlockDefinition(l),s=a.tooltip;n.MATH_ADDITION_SYMBOL=a.block.MATH_ADDITION_SYMBOL,n.MATH_SUBTRACTION_SYMBOL=a.block.MATH_SUBTRACTION_SYMBOL,n.MATH_MULTIPLICATION_SYMBOL=a.block.MATH_MULTIPLICATION_SYMBOL,n.MATH_DIVISION_SYMBOL=a.block.MATH_DIVISION_SYMBOL,n.MATH_POWER_SYMBOL=a.block.MATH_POWER_SYMBOL,T(l,a.name,function(t){return s[t.getFieldValue("OP")]},a.url,V.toolbox.getNamespaceColor(a.category));var c="math_modulo",u=V.blocks.getBlockDefinition(c);n.MATH_MODULO_TITLE=u.block.MATH_MODULO_TITLE,b(c),R.initMathOpBlock(),R.initMathRoundBlock()}(),function(){Blockly.FieldVariable.prototype.getVariableTypes_=function(){return[""]};var t=lf("{id:var}item");Blockly.Variables.flyoutCategory=function(t){var e=[];if(!V.appTarget.appTheme.hideFlyoutHeadings){var i=f(lf("Variables"),V.toolbox.getNamespaceColor("variables"),V.toolbox.getNamespaceIcon("variables"));e.push(i)}var o=document.createElement("button");o.setAttribute("text",lf("Make a Variable...")),o.setAttribute("callbackKey","CREATE_VARIABLE"),t.registerButtonCallback("CREATE_VARIABLE",function(t){Blockly.Variables.createVariable(t.getTargetWorkspace())}),e.push(o);var r=Blockly.Variables.flyoutCategoryBlocks(t);return e=e.concat(r)},Blockly.Variables.flyoutCategoryBlocks=function(t){var e=t.getVariablesOfType(""),i=[];if(0<e.length){var o=e[e.length-1];e.sort(Blockly.VariableModel.compareByName);for(var r=0;r<e.length;r++){var n=e[r];if(Blockly.Blocks.variables_get){var l='<xml><block type="variables_get" gap="8">'+Blockly.Variables.generateVariableFieldXmlString(n)+"</block></xml>",a=Blockly.Xml.textToDom(l).firstChild;i.push(a)}}if(i[i.length-1].setAttribute("gap","24"),Blockly.Blocks.variables_set){var s=Blockly.Blocks.variables_change?8:24,l='<xml><block type="variables_set" gap="'+s+'">'+Blockly.Variables.generateVariableFieldXmlString(o)+"</block></xml>",a=Blockly.Xml.textToDom(l).firstChild,c=goog.dom.createDom("value");c.setAttribute("name","VALUE");var u=goog.dom.createDom("shadow");u.setAttribute("type","math_number"),c.appendChild(u);var p=goog.dom.createDom("field");p.setAttribute("name","NUM"),p.appendChild(document.createTextNode("0")),u.appendChild(p),a.appendChild(c),i.push(a)}if(Blockly.Blocks.variables_change){var s=Blockly.Blocks.variables_get?20:8,l='<xml><block type="variables_change" gap="'+s+'">'+Blockly.Variables.generateVariableFieldXmlString(o)+'<value name="DELTA"><shadow type="math_number"><field name="NUM">1</field></shadow></value></block></xml>',a=Blockly.Xml.textToDom(l).firstChild,c=goog.dom.createDom("value");c.setAttribute("name","VALUE");var u=goog.dom.createDom("shadow");u.setAttribute("type","math_number"),c.appendChild(u);var p=goog.dom.createDom("field");p.setAttribute("name","NUM"),p.appendChild(document.createTextNode("1")),u.appendChild(p),a.appendChild(c),i.push(a)}}return i};var e=Blockly.Msg,i="variables_get",o=V.blocks.getBlockDefinition(i);e.VARIABLES_GET_CREATE_SET=o.block.VARIABLES_GET_CREATE_SET,b(i),b("variables_get_reporter"),e.RENAME_VARIABLE=lf("Rename variable..."),e.DELETE_VARIABLE=lf('Delete the "%1" variable'),e.DELETE_VARIABLE_CONFIRMATION=lf('Delete %1 uses of the "%2" variable?'),e.NEW_VARIABLE_DROPDOWN=lf("New variable...");var r="variables_set",n=V.blocks.getBlockDefinition(r);e.VARIABLES_SET=n.block.VARIABLES_SET,e.VARIABLES_DEFAULT_NAME=t,e.VARIABLES_SET_CREATE_GET=lf("Create 'get %1'"),b(r);var l="variables_change",a=V.blocks.getBlockDefinition(l);Blockly.Blocks[l]={init:function(){this.jsonInit({message0:a.block.message0,args0:[{type:"field_variable",name:"VAR",variable:t},{type:"input_value",name:"VALUE",check:"Number"}],inputsInline:!0,previousStatement:null,nextStatement:null,colour:V.toolbox.getNamespaceColor("variables")}),d(this,l)}},e.NEW_VARIABLE_TITLE=lf("New variable name:"),e.RENAME_VARIABLE_TITLE=lf("Rename all '%1' variables to:")}(),function(){var t=Blockly.Msg;t.FUNCTION_CREATE_NEW=lf("Make a Function..."),t.FUNCTION_WARNING_DUPLICATE_ARG=lf("Functions cannot use the same argument name more than once."),t.FUNCTION_WARNING_ARG_NAME_IS_FUNCTION_NAME=lf("Argument names must not be the same as the function name."),t.FUNCTION_WARNING_EMPTY_NAME=lf("Function and argument names cannot be empty."),t.FUNCTIONS_DEFAULT_FUNCTION_NAME=lf("doSomething"),t.FUNCTIONS_DEFAULT_BOOLEAN_ARG_NAME=lf("bool"),t.FUNCTIONS_DEFAULT_STRING_ARG_NAME=lf("text"),t.FUNCTIONS_DEFAULT_NUMBER_ARG_NAME=lf("num"),t.FUNCTIONS_DEFAULT_CUSTOM_ARG_NAME=lf("arg"),t.PROCEDURES_HUE=V.toolbox.getNamespaceColor("functions"),t.REPORTERS_HUE=V.toolbox.getNamespaceColor("variables");var e="procedures_defnoreturn",i=V.blocks.getBlockDefinition(e);t.PROCEDURES_DEFNORETURN_TITLE=i.block.PROCEDURES_DEFNORETURN_TITLE,t.PROCEDURE_ALREADY_EXISTS=i.block.PROCEDURE_ALREADY_EXISTS,Blockly.Blocks.procedures_defnoreturn.init=function(){var t=new Blockly.FieldTextInput("",Blockly.Procedures.rename);this.appendDummyInput().appendField(Blockly.Msg.PROCEDURES_DEFNORETURN_TITLE).appendField(t,"NAME").appendField("","PARAMS"),this.setColour(V.toolbox.getNamespaceColor("functions")),this.arguments_=[],this.argumentVarModels_=[],this.setStartHat(!0),this.setStatements_(!0),this.statementConnection_=null},b(e);var o="procedures_callnoreturn",r=V.blocks.getBlockDefinition(o);t.PROCEDURES_CALLRETURN_TOOLTIP=i.tooltip,Blockly.Blocks.procedures_callnoreturn={init:function(){var t=new pxtblockly.FieldProcedure("");this.appendDummyInput("TOPROW").appendField(r.block.PROCEDURES_CALLNORETURN_TITLE).appendField(t,"NAME"),this.setPreviousStatement(!0),this.setNextStatement(!0),this.setColour(V.toolbox.getNamespaceColor("functions")),this.arguments_=[],this.quarkConnections_={},this.quarkIds_=null},getProcedureCall:function(){return this.getFieldValue("NAME")},renameProcedure:function(t,e){Blockly.Names.equals(t,this.getProcedureCall())&&this.setFieldValue(e,"NAME")},onchange:function(t){if(this.workspace&&!this.workspace.isFlyout&&!this.isInsertionMarker())if(t.type==Blockly.Events.CREATE&&-1!=t.ids.indexOf(this.id)){var e=this.getProcedureCall(),i=Blockly.Procedures.getDefinition(e,this.workspace);if(!i||i.type==this.defType_&&JSON.stringify(i.arguments_)==JSON.stringify(this.arguments_)||(i=null),!i){Blockly.Events.setGroup(t.group);var o=Blockly.utils.xml.createElement("xml"),r=Blockly.utils.xml.createElement("block");r.setAttribute("type",this.defType_);var n=this.getRelativeToSurfaceXY(),l=n.x+Blockly.SNAP_RADIUS*(this.RTL?-1:1),a=n.y+2*Blockly.SNAP_RADIUS;r.setAttribute("x",l),r.setAttribute("y",a);var s=Blockly.utils.xml.createElement("field");s.setAttribute("name","NAME"),s.appendChild(document.createTextNode(this.getProcedureCall())),r.appendChild(s),o.appendChild(r),V.blocks.domToWorkspaceNoEvents(o,this.workspace),Blockly.Events.setGroup(!1)}}else if(t.type==Blockly.Events.DELETE){var c=this.getProcedureCall(),i=Blockly.Procedures.getDefinition(c,this.workspace);i||(Blockly.Events.setGroup(t.group),this.dispose(!0,!1),Blockly.Events.setGroup(!1))}},mutationToDom:function(){var t=document.createElement("mutation");return t.setAttribute("name",this.getProcedureCall()),t},domToMutation:function(t){var e=t.getAttribute("name");this.renameProcedure(this.getProcedureCall(),e)},customContextMenu:function(t){var e={enabled:!0};e.text=Blockly.Msg.PROCEDURES_HIGHLIGHT_DEF;var i=this.getProcedureCall(),o=this.workspace;e.callback=function(){var t=Blockly.Procedures.getDefinition(i,o);t&&t.select()},t.push(e)},defType_:"procedures_defnoreturn"},b(o);var n="function_definition",l=V.blocks.getBlockDefinition(n);t.FUNCTIONS_EDIT_OPTION=l.block.FUNCTIONS_EDIT_OPTION,b(n);var a="function_call",s=V.blocks.getBlockDefinition(a);t.FUNCTIONS_CALL_TITLE=s.block.FUNCTIONS_CALL_TITLE,b(a),Blockly.Procedures.flyoutCategory=function(u){var l=[];if(!V.appTarget.appTheme.hideFlyoutHeadings){var t=f(lf("Functions"),V.toolbox.getNamespaceColor("functions"),V.toolbox.getNamespaceIcon("functions"),"blocklyFlyoutIconfunctions");l.push(t)}var i=lf("Make a Function..."),o=lf("New function name:"),e=Blockly.utils.xml.createElement("button");e.setAttribute("text",i),e.setAttribute("callbackKey","CREATE_FUNCTION");u.registerButtonCallback("CREATE_FUNCTION",function(t){var e=function(t){Blockly.prompt(o,t,function(t){V.tickEvent("blocks.makeafunction"),t&&(t=t.replace(/[\s\xa0]+/g," ").replace(/^ | $/g,""))==i&&(t=null),t&&(u.getVariable(t)?Blockly.alert(Blockly.Msg.VARIABLE_ALREADY_EXISTS.replace("%1",t.toLowerCase()),function(){e(t)}):Blockly.Procedures.isLegalName_(t,u)?function(t){var e=u.getTopBlocks(!0)[0],i=10,o=10;if(e){var r=e.getRelativeToSurfaceXY();i=r.x+Blockly.SNAP_RADIUS*(e.RTL?-1:1),o=r.y+2*Blockly.SNAP_RADIUS}var n=Blockly.utils.xml.createElement("xml"),l=Blockly.utils.xml.createElement("block");l.setAttribute("type","procedures_defnoreturn"),l.setAttribute("x",String(i)),l.setAttribute("y",String(o));var a=Blockly.utils.xml.createElement("field");a.setAttribute("name","NAME"),a.appendChild(document.createTextNode(t)),l.appendChild(a),n.appendChild(l);var s=V.blocks.domToWorkspaceNoEvents(n,u);Blockly.hideChaff();var c=u.getBlockById(s[0]);c.select(),u.centerOnBlock(c.id)}(t):Blockly.alert(Blockly.Msg.PROCEDURE_ALREADY_EXISTS.replace("%1",t.toLowerCase()),function(){e(t)}))})};e("doSomething")}),l.push(e);var r=Blockly.Procedures.allProcedures(u);return function(t,e){for(var i=0;i<t.length;i++){var o=t[i][0],r=(t[i][1],Blockly.utils.xml.createElement("block"));r.setAttribute("type",e),r.setAttribute("gap","16"),r.setAttribute("colour",V.toolbox.getNamespaceColor("functions"));var n=goog.dom.createDom("field",null,o);n.setAttribute("name","NAME"),r.appendChild(n),l.push(r)}}(r[0],"procedures_callnoreturn"),l};var c=Blockly.Functions.flyoutCategory;Blockly.Functions.flyoutCategory=function(t){var e=c(t),i=f(lf("Functions"),V.toolbox.getNamespaceColor("functions"),V.toolbox.getNamespaceIcon("functions"),"blocklyFlyoutIconfunctions");return e.unshift(i),e};var u={number:V.blocks.defaultIconForArgType("number"),boolean:V.blocks.defaultIconForArgType("boolean"),string:V.blocks.defaultIconForArgType("string")},p={},d=V.appTarget.runtime&&V.appTarget.runtime.functionsOptions;d&&d.extraFunctionEditorTypes&&d.extraFunctionEditorTypes.forEach(function(t){u[t.typeName]=t.icon||V.blocks.defaultIconForArgType(),t.defaultName&&(p[t.typeName]=t.defaultName)});Blockly.PXTBlockly.FunctionUtils.argumentIcons=u,Blockly.PXTBlockly.FunctionUtils.argumentDefaultNames=p,Blockly.Blocks.argument_reporter_custom&&(Blockly.Blocks.argument_reporter_custom.domToMutation=function(t){var e=t.getAttribute("typename");this.typeName_=e,g(this,e,h)})}(),function(){var t=Blockly.Msg,e="lists_create_with",i=V.blocks.getBlockDefinition(e);t.LISTS_CREATE_EMPTY_TITLE=i.block.LISTS_CREATE_EMPTY_TITLE,t.LISTS_CREATE_WITH_INPUT_WITH=i.block.LISTS_CREATE_WITH_INPUT_WITH,t.LISTS_CREATE_WITH_CONTAINER_TITLE_ADD=i.block.LISTS_CREATE_WITH_CONTAINER_TITLE_ADD,t.LISTS_CREATE_WITH_ITEM_TITLE=i.block.LISTS_CREATE_WITH_ITEM_TITLE,b(e);var o="lists_length",r=V.blocks.getBlockDefinition(o);t.LISTS_LENGTH_TITLE=r.block.LISTS_LENGTH_TITLE,Blockly.Blocks[o].init=function(){this.jsonInit({message0:t.LISTS_LENGTH_TITLE,args0:[{type:"input_value",name:"VALUE",check:["Array"]}],output:"Number",outputShape:Blockly.OUTPUT_SHAPE_ROUND})},b(o)}(),function(){var t=Blockly.Msg,e="controls_repeat_ext",i=V.blocks.getBlockDefinition(e);t.CONTROLS_REPEAT_TITLE=i.block.CONTROLS_REPEAT_TITLE,t.CONTROLS_REPEAT_INPUT_DO=i.block.CONTROLS_REPEAT_INPUT_DO,b(e);var o="device_while",r=V.blocks.getBlockDefinition(o);Blockly.Blocks[o]={init:function(){this.jsonInit({message0:r.block.message0,args0:[{type:"input_value",name:"COND",check:"Boolean"}],previousStatement:null,nextStatement:null,colour:V.toolbox.getNamespaceColor("loops")}),this.appendStatementInput("DO").appendField(r.block.appendField),d(this,o)}};var n="pxt_controls_for",l=V.blocks.getBlockDefinition(n);Blockly.Blocks[n]={init:function(){this.jsonInit({message0:l.block.message0,args0:[{type:"input_value",name:"VAR",variable:l.block.variable,check:"Variable"},{type:"input_value",name:"TO",check:"Number"}],previousStatement:null,nextStatement:null,colour:V.toolbox.getNamespaceColor("loops"),inputsInline:!0}),this.appendStatementInput("DO").appendField(l.block.appendField);var t=this;_(this,n,l.name,function(){return V.U.rlf(l.tooltip,t.getInputTargetBlock("VAR")?t.getInputTargetBlock("VAR").getField("VAR").getText():"")},l.url,String(V.toolbox.getNamespaceColor("loops")))},getVars:function(){return[this.getField("VAR").getText()]},renameVar:function(t,e){var i=this.getField("VAR");Blockly.Names.equals(t,i.getText())&&(i.setText(e),i.setValue(e))},customContextMenu:function(t){if(!this.isCollapsed()){var e={enabled:!0};e.text=lf("Create 'get {0}'",name);var i=goog.dom.createDom("field",null,name);i.setAttribute("name","VAR");var o=goog.dom.createDom("block",null,i);o.setAttribute("type","variables_get"),e.callback=Blockly.ContextMenu.callbackFactory(this,o),t.push(e)}}};var a="controls_simple_for",s=V.blocks.getBlockDefinition(a);Blockly.Blocks[a]={init:function(){this.jsonInit({message0:s.block.message0,args0:[{type:"field_variable",name:"VAR",variable:s.block.variable},{type:"input_value",name:"TO",check:"Number"}],previousStatement:null,nextStatement:null,colour:V.toolbox.getNamespaceColor("loops"),inputsInline:!0}),this.appendStatementInput("DO").appendField(s.block.appendField);var t=this;_(this,a,s.name,function(){return V.U.rlf(s.tooltip,t.getField("VAR").getText())},s.url,String(V.toolbox.getNamespaceColor("loops")))},getVars:function(){return[this.getField("VAR").getText()]},renameVar:function(t,e){var i=this.getField("VAR");Blockly.Names.equals(t,i.getText())&&(i.setText(e),i.setValue(e))},customContextMenu:function(t){if(!this.isCollapsed()){var e={enabled:!0},i=this.getField("VAR").getText();e.text=lf("Create 'get {0}'",i);var o=goog.dom.createDom("field",null,i);o.setAttribute("name","VAR");var r=goog.dom.createDom("block",null,o);r.setAttribute("type","variables_get"),e.callback=Blockly.ContextMenu.callbackFactory(this,r),t.push(e)}}};var c=V.blocks.getBlockDefinition(ts.pxtc.TS_BREAK_TYPE);Blockly.Blocks[pxtc.TS_BREAK_TYPE]={init:function(){var t=V.toolbox.getNamespaceColor("loops");this.jsonInit({message0:c.block.message0,inputsInline:!0,previousStatement:null,nextStatement:null,colour:t}),_(this,ts.pxtc.TS_BREAK_TYPE,c.name,c.tooltip,c.url,t,void 0,void 0,!1)}};var u=V.blocks.getBlockDefinition(ts.pxtc.TS_CONTINUE_TYPE);Blockly.Blocks[pxtc.TS_CONTINUE_TYPE]={init:function(){var t=V.toolbox.getNamespaceColor("loops");this.jsonInit({message0:u.block.message0,inputsInline:!0,previousStatement:null,nextStatement:null,colour:t}),_(this,ts.pxtc.TS_CONTINUE_TYPE,u.name,u.tooltip,u.url,t,void 0,void 0,!1)}};var p="#cccccc";Blockly.Blocks[pxtc.COLLAPSED_BLOCK]={init:function(){this.jsonInit({message0:"...",inputsInline:!0,previousStatement:null,nextStatement:null,colour:p}),_(this,ts.pxtc.COLLAPSED_BLOCK,"...",lf("a few blocks"),void 0,p,void 0,void 0,!1)}}}(),function(){var t=Blockly.Msg,e="controls_if",i=V.blocks.getBlockDefinition(e),o=i.tooltip;t.CONTROLS_IF_MSG_IF=i.block.CONTROLS_IF_MSG_IF,t.CONTROLS_IF_MSG_THEN=i.block.CONTROLS_IF_MSG_THEN,t.CONTROLS_IF_MSG_ELSE=i.block.CONTROLS_IF_MSG_ELSE,t.CONTROLS_IF_MSG_ELSEIF=i.block.CONTROLS_IF_MSG_ELSEIF,t.CONTROLS_IF_TOOLTIP_1=o.CONTROLS_IF_TOOLTIP_1,t.CONTROLS_IF_TOOLTIP_2=o.CONTROLS_IF_TOOLTIP_2,t.CONTROLS_IF_TOOLTIP_3=o.CONTROLS_IF_TOOLTIP_3,t.CONTROLS_IF_TOOLTIP_4=o.CONTROLS_IF_TOOLTIP_4,b(e);var r="logic_compare",n=V.blocks.getBlockDefinition(r).tooltip;t.LOGIC_COMPARE_TOOLTIP_EQ=n.LOGIC_COMPARE_TOOLTIP_EQ,t.LOGIC_COMPARE_TOOLTIP_NEQ=n.LOGIC_COMPARE_TOOLTIP_NEQ,t.LOGIC_COMPARE_TOOLTIP_LT=n.LOGIC_COMPARE_TOOLTIP_LT,t.LOGIC_COMPARE_TOOLTIP_LTE=n.LOGIC_COMPARE_TOOLTIP_LTE,t.LOGIC_COMPARE_TOOLTIP_GT=n.LOGIC_COMPARE_TOOLTIP_GT,t.LOGIC_COMPARE_TOOLTIP_GTE=n.LOGIC_COMPARE_TOOLTIP_GTE,b(r);var l="logic_operation",a=V.blocks.getBlockDefinition(l),s=a.tooltip;t.LOGIC_OPERATION_AND=a.block.LOGIC_OPERATION_AND,t.LOGIC_OPERATION_OR=a.block.LOGIC_OPERATION_OR,t.LOGIC_OPERATION_TOOLTIP_AND=s.LOGIC_OPERATION_TOOLTIP_AND,t.LOGIC_OPERATION_TOOLTIP_OR=s.LOGIC_OPERATION_TOOLTIP_OR,b(l);var c="logic_negate",u=V.blocks.getBlockDefinition(c);t.LOGIC_NEGATE_TITLE=u.block.LOGIC_NEGATE_TITLE,b(c);var p="logic_boolean",d=V.blocks.getBlockDefinition(p);t.LOGIC_BOOLEAN_TRUE=d.block.LOGIC_BOOLEAN_TRUE,t.LOGIC_BOOLEAN_FALSE=d.block.LOGIC_BOOLEAN_FALSE,b(p)}(),function(){var t=V.blocks.getBlockDefinition("text");T("text",t.name,t.tooltip,t.url,Blockly.Colours.textField,Blockly.Colours.textField,Blockly.Colours.textField);var e=Blockly.Msg,i="text_length",o=V.blocks.getBlockDefinition(i);e.TEXT_LENGTH_TITLE=o.block.TEXT_LENGTH_TITLE,Blockly.Blocks[i].init=function(){this.jsonInit({message0:e.TEXT_LENGTH_TITLE,args0:[{type:"input_value",name:"VALUE",check:["String"]}],output:"Number",outputShape:Blockly.OUTPUT_SHAPE_ROUND})},b(i);var r="text_join",n=V.blocks.getBlockDefinition(r);e.TEXT_JOIN_TITLE_CREATEWITH=n.block.TEXT_JOIN_TITLE_CREATEWITH,b(r)}(),function(){var c=Blockly.BlockDragger.prototype.dragBlock;Blockly.BlockDragger.prototype.dragBlock=function(t,e){var i,o,r=document.getElementsByClassName("blocklyToolboxDiv")[0],n=document.getElementsByClassName("blocklyTreeRoot")[0]||document.getElementsByClassName("blocklyFlyout")[0],l=document.getElementById("blocklyTrashIcon");if(n&&l){var a=(i=n.getBoundingClientRect(),o=t.clientX,Math.abs(o-(i.left+i.width/2)));if(a<200){var s=a/200;l.style.opacity=""+(1-s),l.style.display="block",r&&(n.style.opacity=""+s,a<50&&V.BrowserUtils.addClass(r,"blocklyToolboxDeleting"))}else l.style.display="none",n.style.opacity="1",r&&V.BrowserUtils.removeClass(r,"blocklyToolboxDeleting")}return c.call(this,t,e)};var n=Blockly.BlockDragger.prototype.endBlockDrag;Blockly.BlockDragger.prototype.endBlockDrag=function(t,e){n.call(this,t,e);var i=document.getElementsByClassName("blocklyToolboxDiv")[0],o=document.getElementsByClassName("blocklyTreeRoot")[0]||document.getElementsByClassName("blocklyFlyout")[0],r=document.getElementById("blocklyTrashIcon");r&&o&&(r.style.display="none",o.style.opacity="1",i&&V.BrowserUtils.removeClass(i,"blocklyToolboxDeleting"))}}(),Blockly.Blocks[pxtc.TS_DEBUGGER_TYPE]={init:function(){var t=this;t.setColour(V.toolbox.getNamespaceColor("debug")),t.setPreviousStatement(!0),t.setNextStatement(!0),t.setInputsInline(!1),t.appendDummyInput("ON_OFF").appendField(new Blockly.FieldLabel(lf("breakpoint"),void 0),"DEBUGGER").appendField(new pxtblockly.FieldBreakpoint("1",{type:"number"}),"ON_OFF"),_(this,pxtc.TS_DEBUGGER_TYPE,lf("Debugger statement"),lf("A debugger statement invokes any available debugging functionality"),"/javascript/debugger",V.toolbox.getNamespaceColor("debug"))}},Blockly.Msg.WORKSPACE_COMMENT_DEFAULT_TEXT="",a=function(t){if(t.disabled)return lf("This block is disabled and will not run. Attach this block to an event to enable it.");for(var e=t.tooltip;goog.isFunction(e);)e=e(t);return e},Blockly.Tooltip.show_=function(){if(Blockly.Tooltip.poisonedElement_=Blockly.Tooltip.element_,Blockly.Tooltip.DIV){goog.dom.removeChildren(Blockly.Tooltip.DIV);var t=Blockly.Tooltip.element_.codeCard;if(t){var e=V.docs.codeCard.render({header:a(Blockly.Tooltip.element_)});Blockly.Tooltip.DIV.appendChild(e),l()}else{for(var i=a(Blockly.Tooltip.element_),o=(i=Blockly.utils._string.wrap(i,Blockly.Tooltip.LIMIT)).split("\n"),r=0;r<o.length;r++){var n=document.createElement("div");n.appendChild(document.createTextNode(o[r])),Blockly.Tooltip.DIV.appendChild(n)}l()}}function l(){var t=Blockly.Tooltip.element_.RTL,e=goog.dom.getViewportSize(),i=Blockly.Tooltip.DIV;i.style.direction=t?"rtl":"ltr",i.style.display="block",Blockly.Tooltip.visible=!0;var o=Blockly.Tooltip.lastX_;t?o-=Blockly.Tooltip.OFFSET_X+i.offsetWidth:o+=Blockly.Tooltip.OFFSET_X;var r=Blockly.Tooltip.lastY_+Blockly.Tooltip.OFFSET_Y;r+i.offsetHeight>e.height+window.scrollY&&(r-=i.offsetHeight+2*Blockly.Tooltip.OFFSET_Y),t?o=Math.max(Blockly.Tooltip.MARGINS-window.scrollX,o):o+i.offsetWidth>e.width+window.scrollX-2*Blockly.Tooltip.MARGINS&&(o=e.width-i.offsetWidth-2*Blockly.Tooltip.MARGINS),i.style.top=r+"px",i.style.left=o+"px"}},Blockly.Block.prototype.setEnabled=function(t){if(this.disabled==t){var e=Blockly.Events.recordUndo;Blockly.Events.recordUndo=!1,Blockly.Events.fire(new Blockly.Events.BlockChange(this,"disabled",null,this.disabled,!t)),Blockly.Events.recordUndo=e,this.disabled=!t}})}function F(t,e){for(var i=t.split(/\s*\|\s*/),o=[],r=0,n=i;r<n.length;r++){var l=n[r];switch(l){case"number":o.push("Number");break;case"string":o.push("String");break;case"boolean":o.push("Boolean");break;case"T":case"any":return null;case"void":return;default:if(k(l)){if(1<i.length)return null;o.push("Array")}var a=e.apis.byQName[l];a&&a.extendsTypes&&0<a.extendsTypes.length?o.push.apply(o,a.extendsTypes):o.push(l)}}return o}function g(t,e,i){var o=F(e,i);(o||null===o)&&t.setOutput(!0,o)}function d(t,e){var i=V.blocks.getBlockDefinition(e);_(t,e,i.name,i.tooltip,i.url,V.toolbox.getNamespaceColor(i.category))}function b(t){var e=V.blocks.getBlockDefinition(t);T(t,e.name,e.tooltip,e.url,V.toolbox.getNamespaceColor(e.category))}function _(i,o,t,e,r,n,l,a,s){!e||"string"!=typeof e&&"function"!=typeof e||i.setTooltip(e),r&&i.setHelpUrl(r),n&&i.setColour(n,l,a),s&&i.setDeletable(!1);var c=document.getElementById("blocklyToolboxDefinition"),u=c?R.getFirstChildWithAttr(c,"block","type",o):void 0;i.codeCard={header:t,name:t,software:1,description:goog.isFunction(e)?e(i):e,blocksXml:u?'<xml xmlns="http://www.w3.org/1999/xhtml">'+(p(u)||'<block type="'+o+'"></block>')+"</xml>":void 0,url:r},V.Util.isTranslationMode()&&V.blocks.promptTranslateBlock&&(i.customContextMenu=function(t){var e=V.blocks.getBlockDefinition(i.type);e&&e.translationIds&&t.push({enabled:!0,text:lf("Translate this block"),callback:function(){V.blocks.promptTranslateBlock(o,e.translationIds)}})})}function T(t,e,i,o,r,n,l){var a=Blockly.Blocks[t],s=a.init;s&&(a.init=function(){s.call(this);_(this,t,e,i,o,r,n,l)})}function s(t){delete Blockly.Blocks[t.attributes.blockId],delete u[t.attributes.blockId]}function x(t,e,i,o){var r=document.createElement(o?"shadow":"block");r.setAttribute("type",V.Util.htmlEscape(t));var n=document.createElement("field");return n.setAttribute("name",V.Util.htmlEscape(e)),n.textContent=V.Util.htmlEscape(i),r.appendChild(n),r}R.installHelpResources=T,R.onShowContextMenu=void 0,R.mkPredicateBlock=function(t){var e=document.createElement("block");e.setAttribute("type",t);var i=document.createElement("value");i.setAttribute("name","PREDICATE"),e.appendChild(i);var o=x("logic_boolean","BOOL","TRUE",!0);return i.appendChild(o),e},R.mkFieldBlock=x;var M={};function P(t,e){return{field:t,name:e}}function U(e,i){return V.Util.values(e.byQName).filter(function(t){return 4===t.kind&&t.attributes.fixedInstance&&function(t,e,i){if(e==i)return!0;var o=t.byQName[e];return!(!o||!o.extendsTypes)&&0<=o.extendsTypes.indexOf(i)}(e,t.retType,i)})}R.getFixedInstanceDropdownValues=U,R.generateIcons=function(t){var e=new V.ImageConverter;t.forEach(function(t){t.attributes.jresURL&&!t.attributes.iconURL&&V.U.startsWith(t.attributes.jresURL,"data:image/x-mkcd-f")&&(t.attributes.iconURL=e.convert(t.attributes.jresURL))})},R.setVarFieldValue=function(t,e,i){var o=t.getField(e),r=t.workspace.getAllVariables(),n=!1;if(r&&r.length)for(var l=0;l<r.length;l++){var a;(a=r[l]).name===i&&(o.setValue(a.getId()),n=!0)}n||(o.initModel(),(a=o.getVariable()).name=i,o.setText(i),o.setValue(a.getId()))}}(V.blocks||(V.blocks={}))}(pxt||(pxt={})),function(a){!function(l){var s,t;(t=s=l.MutatorTypes||(l.MutatorTypes={})).ObjectDestructuringMutator="objectdestructuring",t.RestParameterMutator="restparameter",t.DefaultInstanceMutator="defaultinstance",l.addMutation=function(t,e,i){var o;switch(i){case s.ObjectDestructuringMutator:if(!e.parameters||e.parameters.length<1)console.error("Destructuring mutations require at least one parameter");else{for(var r=!1,n=0,l=e.parameters;n<l.length;n++){var a=l[n];if(-1!==a.type.indexOf("=>")){if(!a.properties||0===a.properties.length)return void console.error("Destructuring mutations only supported for functions with an event parameter that has multiple properties");r=!0}}if(!r)return void console.error("Destructuring mutations must have an event parameter")}o=new c(t,e);break;case s.RestParameterMutator:o=new u(t,e);break;case s.DefaultInstanceMutator:o=new p(t,e);break;default:return void console.warn("Ignoring unknown mutation type: "+i)}t.mutationToDom=o.mutationToDom.bind(o),t.domToMutation=o.domToMutation.bind(o),t.compose=o.compose.bind(o),t.decompose=o.decompose.bind(o),t.mutation=o},l.mutateToolboxBlock=function(t,e,i){var o=document.createElement("mutation");switch(e){case s.ObjectDestructuringMutator:o.setAttribute(c.propertiesAttributeName,i);break;case s.RestParameterMutator:o.setAttribute(u.countAttributeName,i);break;case s.DefaultInstanceMutator:o.setAttribute(p.attributeName,i);default:return void console.warn("Ignoring unknown mutation type: "+e)}t.appendChild(o)};var r=function(){function l(t,e){this.info=e,this.block=t,this.topBlockType=this.block.type+"_mutator";var i=this.getSubBlockNames();this.initializeMutatorTopBlock(),this.initializeMutatorSubBlocks(i);var o=i.map(function(t){return t.type});this.block.setMutator(new Blockly.Mutator(o))}return l.prototype.compose=function(t){var e=t.getDescendants(!1).map(function(t){return{type:t.type,name:t.inputList[0].name}});e.shift(),this.updateBlock(e)},l.prototype.decompose=function(o){var t=o.newBlock(this.topBlockType);t.initSvg();for(var e=function(t){if(t.name===l.mutatorStatmentInput){var i=t.connection;return r.getVisibleBlockTypes().forEach(function(t){var e=o.newBlock(t);e.initSvg(),i.connect(e.previousConnection),i=e.nextConnection}),"break"}},r=this,i=0,n=t.inputList;i<n.length;i++){if("break"===e(n[i]))break}return t},l.prototype.compileMutation=function(t,e){},l.prototype.getDeclaredVariables=function(){},l.prototype.isDeclaredByMutation=function(t){return!1},l.prototype.initializeMutatorSubBlock=function(t,e,i){t.appendDummyInput(e).appendField(e),t.setColour(i),t.setNextStatement(!0),t.setPreviousStatement(!0)},l.prototype.initializeMutatorTopBlock=function(){var t=this.info.attributes.mutateText,e=this.block.getColour();Blockly.Blocks[this.topBlockType]=Blockly.Blocks[this.topBlockType]||{init:function(){this.appendDummyInput().appendField(t),this.setColour(e),this.appendStatementInput(l.mutatorStatmentInput)}}},l.prototype.initializeMutatorSubBlocks=function(t){var e=this.block.getColour(),i=this.initializeMutatorSubBlock.bind(this);t.forEach(function(t){Blockly.Blocks[t.type]=Blockly.Blocks[t.type]||{init:function(){i(this,t.name,e)}}})},l.mutatorStatmentInput="PROPERTIES",l.mutatedVariableInputName="properties",l}(),c=function(o){function n(t,e){var i=o.call(this,t,e)||this;return i.currentlyVisible=[],i.parameterRenames={},i.prefix=i.info.attributes.mutatePrefix,i.block.appendDummyInput(r.mutatedVariableInputName),i.block.appendStatementInput("HANDLER").setCheck("null"),i}return __extends(n,o),n.prototype.getMutationType=function(){return s.ObjectDestructuringMutator},n.prototype.compileMutation=function(r,t){var n=this;if(this.info.attributes.mutatePropertyEnum||this.parameters.length){var e="function ({ "+this.parameters.map(function(t){var e=n.block.getField(t),i=e&&e.getText(),o=l.escapeVarName(t,r);return i!==t?(n.parameterRenames[t]=i,t+": "+l.escapeVarName(i,r)):o}).join(", ")+" })";return this.info.attributes.mutatePropertyEnum?l.mkText(" ["+this.parameters.map(function(t){return n.info.attributes.mutatePropertyEnum+"."+t}).join(", ")+"],"+e):l.mkText(e)}},n.prototype.getDeclaredVariables=function(){var e=this,i={};return this.parameters.forEach(function(t){i[e.getVarFieldValue(t)]=e.parameterTypes[t]}),i},n.prototype.isDeclaredByMutation=function(e){var i=this;return this.parameters.some(function(t){return i.getVarFieldValue(t)===e})},n.prototype.mutationToDom=function(){var i=this,t=document.createElement("mutation"),e=this.parameters.map(function(t){var e=i.getVarFieldValue(t);return e!==t&&(i.parameterRenames[t]=a.Util.htmlEscape(e)),a.Util.htmlEscape(t)}).join(",");for(var o in t.setAttribute(n.propertiesAttributeName,e),this.parameterRenames)o===this.parameterRenames[o]&&delete this.parameterRenames[o];return t.setAttribute(n.renameAttributeName,JSON.stringify(this.parameterRenames)),t},n.prototype.domToMutation=function(t){var i=this,e=t.getAttribute(n.propertiesAttributeName);if(e){var o=e.split(","),r=[];if(void 0===this.paramIndex&&(this.paramIndex=this.getParameterIndex()),o.forEach(function(t){var e=t.split(":");i.info.parameters[i.paramIndex].properties.some(function(t){return t.name===e[0]})&&r.push({property:e[0],newName:e[1]})}),this.parameterRenames=void 0,t.hasAttribute(n.renameAttributeName))try{this.parameterRenames=JSON.parse(t.getAttribute(n.renameAttributeName))}catch(t){console.warn("Ignoring invalid rename map in saved block mutation")}this.parameterRenames=this.parameterRenames||{},this.parameters=[],r.forEach(function(t){i.parameters.push(t.property),t.newName&&t.newName!==t.property&&(i.parameterRenames[t.property]=t.newName)}),this.updateVisibleProperties(),r.filter(function(t){return!!t.newName}).forEach(function(t){return i.setVarFieldValue(t.property,t.newName)})}},n.prototype.getVarFieldValue=function(t){var e=this.block.getField(t);return e&&e.getText()},n.prototype.setVarFieldValue=function(t,e){this.block.getField(t);this.block.getField(t)&&l.setVarFieldValue(this.block,t,e)},n.prototype.updateBlock=function(t){var e=this;this.parameters=[],t.forEach(function(t){-1===e.parameters.indexOf(t.name)&&e.parameters.push(t.name)}),this.updateVisibleProperties()},n.prototype.getSubBlockNames=function(){var e=this;return this.parameters=[],this.parameterTypes={},void 0===this.paramIndex&&(this.paramIndex=this.getParameterIndex()),this.info.parameters[this.paramIndex].properties.map(function(t){return e.parameterTypes[t.name]=t.type,{type:e.propertyId(t.name),name:t.name}})},n.prototype.getVisibleBlockTypes=function(){var e=this;return this.currentlyVisible.map(function(t){return e.propertyId(t)})},n.prototype.updateVisibleProperties=function(){var i=this;if(!a.Util.listsEqual(this.currentlyVisible,this.parameters)){var o=this.block.inputList.find(function(t){return t.name===r.mutatedVariableInputName});this.prefix&&0===this.currentlyVisible.length&&o.appendField(this.prefix,n.prefixLabel),this.currentlyVisible.forEach(function(t){if(-1===i.parameters.indexOf(t)){var e=i.getVarFieldValue(t);e!==t&&(i.parameterRenames[t]=e),o.removeField(t)}}),this.parameters.forEach(function(t){if(-1===i.currentlyVisible.indexOf(t)){var e=i.parameterRenames[t]||t;o.appendField(new Blockly.FieldVariable(e),t)}}),this.prefix&&0===this.parameters.length&&o.removeField(n.prefixLabel),this.currentlyVisible=this.parameters}},n.prototype.propertyId=function(t){return this.block.type+"_"+t},n.prototype.getParameterIndex=function(){for(var t=0;t<this.info.parameters.length;t++)if(-1!==this.info.parameters[t].type.indexOf("=>"))return t},n.propertiesAttributeName="callbackproperties",n.renameAttributeName="renamemap",n.prefixLabel="0prefix_label_",n}(r),u=function(e){function r(){var t=null!==e&&e.apply(this,arguments)||this;return t.count=0,t}return __extends(r,e),r.prototype.getMutationType=function(){return s.RestParameterMutator},r.prototype.compileMutation=function(e,i){var o=[];return this.forEachInput(function(t){return o.push(l.compileExpression(e,t,i))}),l.mkGroup(o)},r.prototype.mutationToDom=function(){var t=document.createElement("mutation");return t.setAttribute(r.countAttributeName,this.count.toString()),t},r.prototype.domToMutation=function(t){var e=t.getAttribute(r.countAttributeName);if(e){try{this.count=parseInt(e)}catch(t){return}for(var i=0;i<this.count;i++)this.addNumberField(!1,i)}},r.prototype.updateBlock=function(t){if(t){var e=Math.abs(this.count-t.length);if(this.count<t.length)for(var i=0;i<e;i++)this.addNumberField(!0,this.count);else if(this.count>t.length)for(i=0;i<e;i++)this.removeNumberField()}},r.prototype.getSubBlockNames=function(){return[{name:"Value",type:r.entryTypeName}]},r.prototype.getVisibleBlockTypes=function(){var t=[];return this.forEachInput(function(){return t.push(r.entryTypeName)}),t},r.prototype.addNumberField=function(t,e){var i=this.block.appendValueInput(r.valueInputPrefix+e).setCheck("Number");if(t){var o=this.block.workspace.newBlock("math_number");o.initSvg(),o.setShadow(!0),i.connection.connect(o.outputConnection),this.block.workspace.render(),this.count++}},r.prototype.removeNumberField=function(){0<this.count&&this.block.removeInput(r.valueInputPrefix+(this.count-1)),this.count--},r.prototype.forEachInput=function(t){for(var e=0;e<this.count;e++)t(this.block.getInputTargetBlock(r.valueInputPrefix+e),e)},r.countAttributeName="count",r.entryTypeName="entry",r.valueInputPrefix="value_input_",r}(r),p=function(e){function o(){var t=null!==e&&e.apply(this,arguments)||this;return t.showing=!1,t}return __extends(o,e),o.prototype.getMutationType=function(){return s.DefaultInstanceMutator},o.prototype.compileMutation=function(t,e){if(this.showing){var i=this.block.getInputTargetBlock(o.instanceInputName);if(i)return l.compileExpression(t,i,e)}},o.prototype.mutationToDom=function(){var t=document.createElement("mutation");return t.setAttribute(o.attributeName,this.showing?"true":"false"),t},o.prototype.domToMutation=function(t){var e=t.getAttribute(o.attributeName);e?this.updateShape("true"===e):this.updateShape(!1)},o.prototype.updateBlock=function(t){this.updateShape(!(!t||!t.length))},o.prototype.getSubBlockNames=function(){return[{name:"Instance",type:o.instanceSubBlockType}]},o.prototype.getVisibleBlockTypes=function(){var t=[];return this.showing&&t.push(o.instanceSubBlockType),t},o.prototype.updateShape=function(t){this.showing!==t&&(t&&!this.block.getInputTargetBlock(o.instanceInputName)?this.block.appendValueInput(o.instanceInputName):this.block.removeInput(o.instanceInputName),this.showing=t)},o.attributeName="showing",o.instanceInputName="__instance__",o.instanceSubBlockType="instance",o}(r)}(a.blocks||(a.blocks={}))}(pxt||(pxt={})),function(c){!function(t){var r,o,n,e;function l(){return r||((o=document.createElement("div")).style.position="absolute",o.style.top="0",o.style.left="0",o.style.width="1px",o.style.height="1px",document.body.appendChild(o),r=Blockly.inject(o,{scrollbars:!1,readOnly:!0,sound:!1,media:c.webConfig.commitCdnUrl+"blockly/media/",rtl:c.Util.isUserLanguageRtl()})),c.blocks.clearWithoutEvents(r),r}function a(){r&&r.dispose(),r=void 0}function s(t){switch(void 0===t&&(t={emPixels:18,layout:n.Align}),t.splitSvg?n.Align:t.layout||n.Flow){case n.Align:c.blocks.layout.verticalAlign(r,t.emPixels||18);break;case n.Flow:c.blocks.layout.flow(r,{ratio:t.aspectRatio,useViewWidth:t.useViewWidth});break;case n.Clean:r.cleanUp_&&r.cleanUp_()}var e=r.getMetrics(),i=o.querySelectorAll("svg")[0].cloneNode(!0);return c.blocks.layout.cleanUpBlocklySvg(i),c.U.toArray(i.querySelectorAll(".blocklyBlockCanvas,.blocklyBubbleCanvas")).forEach(function(t){return t.setAttribute("transform","translate("+-e.contentLeft+", "+-e.contentTop+") scale(1)")}),i.setAttribute("viewBox","0 0 "+e.contentWidth+" "+e.contentHeight),t.emPixels&&(i.style.width=e.contentWidth/t.emPixels+"em",i.style.height=e.contentHeight/t.emPixels+"em"),t.splitSvg?c.blocks.layout.splitSvg(i,r,t.emPixels):i}(e=n=t.BlockLayout||(t.BlockLayout={}))[e.None=0]="None",e[e.Align=1]="Align",e[e.Clean=3]="Clean",e[e.Flow=4]="Flow",t.initRenderingWorkspace=l,t.cleanRenderingWorkspace=a,t.renderWorkspace=s,t.render=function(t,e){void 0===e&&(e={emPixels:18,layout:n.Align}),l();try{var i=t||'<xml xmlns="http://www.w3.org/1999/xhtml"></xml>',o=Blockly.Xml.textToDom(i);return c.blocks.domToWorkspaceNoEvents(o,r),s(e)}catch(t){return c.reportException(t),void a()}},t.blocksMetrics=function(t){var e=t.getTopBlocks(!1);if(!e.length)return{width:0,height:0};var i=void 0;return e.forEach(function(t){var e=t.getBoundingRectangle();i?(i.l=Math.min(i.l,e.left),i.r=Math.max(i.r,e.right),i.t=Math.min(i.t,e.top),i.b=Math.min(i.b,e.bottom)):i={l:e.left,r:e.right,t:e.top,b:e.bottom}}),{width:i.r-i.l,height:i.b-i.t}}}(c.blocks||(c.blocks={}))}(pxt||(pxt={})),function(t){!function(t){function o(t,e){var i=[];for(var o in t.children){var r=t.children[o];if("block"===r.tagName)if(e){var n=r.getAttribute("type");n&&n===e&&i.push(r)}else i.push(r);else{var l=a(r);l&&(i=i.concat(l))}}return i}function a(t,e){var i=o(t,e);return i.length?i[0]:null}t.findRootBlocks=o,t.findRootBlock=a}(t.blocks||(t.blocks={}))}(pxt||(pxt={})),function(I){var t,e;e=I.docs||(I.docs={}),t=e.codeCard||(e.codeCard={}),I.Util.repeatMap,t.render=function(t,e){void 0===e&&(e={});var i=I.Util.repeatMap,o=t.color||"";o||(t.hardware&&!t.software?o="black":t.software&&!t.hardware&&(o="teal"));var r=t.url?/^[^:]+:\/\//.test(t.url)?t.url:"/"+t.url.replace(/^\.?\/?/,""):t.youTubeId?"https://youtu.be/"+t.youTubeId:void 0,n=!!r,l=function(t,e,i,o){void 0===i&&(i="div"),void 0===o&&(o="");var r=document.createElement(i);return e&&(r.className=e),t&&t.appendChild(r),o&&r.appendChild(document.createTextNode(o+"")),r},a=l(null,"ui card "+(t.color||"")+(n?" link":""),n?"a":"div");if(a.setAttribute("role","option"),a.setAttribute("aria-selected","true"),r&&(a.href=r),!e.hideHeader&&(t.header||t.blocks||t.javascript||t.hardware||t.software||t.any)){var s=l(a,"ui content "+(t.responsive?" tall desktop only":"")),c=l(s,"right floated meta");t.any&&l(c,"ui grey circular label tiny","i",0<t.any?t.any:""),i(t.blocks,function(t){return l(c,"puzzle orange icon","i")}),i(t.javascript,function(t){return l(c,"align left blue icon","i")}),i(t.hardware,function(t){return l(c,"certificate black icon","i")}),i(t.software,function(t){return l(c,"square teal icon","i")}),t.header&&l(s,"description","span",t.header)}var u,p,d,h,m,f=(e.shortName?t.shortName:"")||t.name,g=l(a,"ui image"+(t.responsive?" tall landscape only":""));if(t.label){var y=document.createElement("label");y.className="ui "+(t.labelClass?t.labelClass:"orange right ribbon")+" label",y.textContent=t.label,g.appendChild(y)}if(t.blocksXml){var k=I.blocks.render(t.blocksXml);if(k){var v=l(g,"");v.setAttribute("style","width:100%; min-height:10em"),v.appendChild(k)}else console.error("failed to render blocks"),I.debug(t.blocksXml)}if(t.typeScript){var b=document.createElement("pre");b.appendChild(document.createTextNode(t.typeScript)),g.appendChild(b)}if(t.imageUrl||t.youTubeId&&(t.youTubeId,1)){var _=document.createElement("div");_.className="ui imagewrapper";var T=document.createElement("div");T.className="ui cardimage",T.style.backgroundImage='url("'+t.imageUrl+'")',T.title=f,T.setAttribute("role","presentation"),_.appendChild(T),g.appendChild(_)}if("file"==t.cardType){var x=l(a,"ui fileimage");g.appendChild(x)}if(f||t.description){var E=l(a,"ui content");if(f&&(a.setAttribute("aria-label",f),r&&!n?(u=E,p=r,d=f,h="header",(m=document.createElement("a")).className=h,m.href=p,m.appendChild(document.createTextNode(d)),m.target="_blank",u.appendChild(m)):l(E,"header","div",f)),t.description){var B=l(E,"ui description"),C=t.description.split(".")[0]+".";B.appendChild(document.createTextNode(C))}}if(t.time){var A=l(a,"meta");t.time&&l(A,"date","span").appendChild(document.createTextNode(I.Util.timeSince(t.time)))}return t.extracontent&&l(a,"extra content","div").appendChild(document.createTextNode(t.extracontent)),a}}(pxt||(pxt={})),function(A){!function(B){function p(t,e){var i=t,o=i.mutationToDom,r=i.domToMutation;i.mutationToDom=function(){var t=o?o():document.createElement("mutation");return e.mutationToDom(t)},i.domToMutation=function(t){r&&r(t),e.domToMutation(t)}}B.appendMutation=p,B.initVariableArgsBlock=function(n,l){var a=0,o=0,r=n.appendDummyInput(),s=function(){if(a!==o){if(o<a)for(var t=a-o,e=0;e<t;e++){var i=l[o+e];r.insertFieldAt(r.fieldRow.length-1,new Blockly.FieldVariable(i.name),"HANDLER_"+i.name)}else for(t=o-a,e=0;e<t;e++)i=l[o-e-1],r.removeField("HANDLER_"+i.name);a>=l.length?r.removeField("_HANDLER_ADD"):o>=l.length&&c(),o=a}};function c(){r.appendField(new Blockly.FieldImage(n.ADD_IMAGE_DATAURI,24,24,lf("Add argument"),function(){a=Math.min(a+1,l.length),s()},!1),"_HANDLER_ADD")}Blockly.Extensions.apply("inline-svgs",n,!1),c(),p(n,{mutationToDom:function(t){t.setAttribute("numArgs",a.toString());for(var e=0;e<a;e++){var i=n.getField("HANDLER_"+l[e].name),o=i&&i.getText();t.setAttribute("arg"+e,o)}return t},domToMutation:function(t){var e=parseInt(t.getAttribute("numargs"));a=Math.min(isNaN(e)?0:e,l.length),s();for(var i=0;i<a;i++){var o=t.getAttribute("arg"+i),r="HANDLER_"+l[i].name;n.getField(r)&&B.setVarFieldValue(n,r,o)}}})},B.initExpandableBlock=function(d,h,m,f,t,e){var o="0_add_button",r="0_rem_button",g="_expanded",y="_input_init",k=m.parameters.map(function(t){return t.name}),v=m.parameters.length,i=t?v:1,b=new C(h);b.setEventsEnabled(!1),b.setValue(g,0),b.setValue(y,!1),b.setEventsEnabled(!0);var n=!1,l=!1;function a(t,e,i){void 0===e&&(e=!1),void 0===i&&(i=!1);var o=x(t);if(i||e||o!==b.getNumber(g)){b.setValue(g,o);var r=o;if(b.getBoolean(y)||!(0<r)||(T(),h.rendered)){for(var n=0,l=0;l<h.inputList.length;l++){var a=h.inputList[l];if(A.Util.startsWith(a.name,B.optionalDummyInputPrefix))E(a,n<r||r===v);else if(A.Util.startsWith(a.name,B.optionalInputWithFieldPrefix)||-1!==k.indexOf(a.name)){var s=n<r;if(E(a,s),s&&a.connection&&!a.connection.isConnected()&&!h.isInsertionMarker()){var c=f.definitionNameToParam[m.parameters[n].name],u=B.createShadowValue(d,c);"value"===u.tagName.toLowerCase()&&(u=u.firstElementChild),Blockly.Events.disable();var p=Blockly.Xml.domToBlock(u,h.workspace);p&&a.connection.connect(p.outputConnection),Blockly.Events.enable()}++n}}_(),e||h.render()}}}function s(t,e,i,o){h.appendDummyInput(t).appendField(new Blockly.FieldImage(e,24,24,i,function(){return a(o)},!1))}function _(){var t=b.getNumber(g),e=t!==v,i=0!==t;e||(n=!1,h.removeInput(o,!0)),i||(l=!1,h.removeInput(r,!0)),i&&!l&&(n?(h.removeInput(o,!0),u(),c()):u()),e&&!n&&c()}function c(){n=!0,s(o,h.ADD_IMAGE_DATAURI,lf("Reveal optional arguments"),i)}function u(){l=!0,s(r,h.REMOVE_IMAGE_DATAURI,lf("Hide optional arguments"),-1*i)}function T(){b.setValue(y,!0),e(),_()}function x(t){return Math.min(Math.max(b.getNumber(g)+t,0),v)}function E(t,e){h.rendered&&t.setVisible(e).forEach(function(t){t.render()})}Blockly.Extensions.apply("inline-svgs",h,!1),c(),p(h,{mutationToDom:function(t){return t.setAttribute(g,b.getString(g)),t.setAttribute(y,b.getString(y)),t},domToMutation:function(t){if(b.setEventsEnabled(!1),t.hasAttribute(y)&&"true"==t.getAttribute(y)&&!b.getBoolean(y)&&(b.setValue(y,!0),T()),t.hasAttribute(g)){var e=parseInt(t.getAttribute(g));if(!isNaN(e)){var i=e-(b.getNumber(g)||0);b.getBoolean(y)?h.rendered?a(i,!0):b.setValue(g,x(i)):a(i,!0)}}b.setEventsEnabled(!0)}}),setTimeout(function(){h.rendered&&!h.workspace.isDragging()&&(a(0,void 0,!0),_())},1)};var C=function(){function t(t,e){this.block=t,this.fireEvents=!0,this.state=e||{}}return t.prototype.setValue=function(t,e){var i=this;if(this.fireEvents&&this.block.mutationToDom){var o=this.block.mutationToDom();this.state[t]=e.toString();var r=this.block.mutationToDom();Object.keys(this.state).forEach(function(t){o.getAttribute(t)!==i.state[t]&&r.setAttribute(t,i.state[t])});var n=Blockly.Xml.domToText(o),l=Blockly.Xml.domToText(r);n!=l&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.block,"mutation",null,n,l))}else this.state[t]=e.toString()},t.prototype.getNumber=function(t){return parseInt(this.state[t])},t.prototype.getBoolean=function(t){return"false"!=this.state[t]},t.prototype.getString=function(t){return this.state[t]},t.prototype.setEventsEnabled=function(t){this.fireEvents=t},t}()}(A.blocks||(A.blocks={}))}(pxt||(pxt={})),function(s){var i,o,r;i=s.blocks||(s.blocks={}),r=s.blocks.MATH_FUNCTIONS.unary.concat(s.blocks.MATH_FUNCTIONS.binary).concat(s.blocks.MATH_FUNCTIONS.infix),i.initMathOpBlock=function(){var t="math_js_op",e=s.blocks.getBlockDefinition(t);function l(t,e){var i=t.appendValueInput("ARG"+(e?1:0));i.setCheck("Number"),e&&(i.connection.setShadowDom(function(){if(!o){(o=document.createElement("shadow")).setAttribute("type","math_number");var t=document.createElement("field");t.setAttribute("name","NUM"),t.textContent="0",o.appendChild(t)}return o}()),i.connection.respawnShadow_())}function a(t,e){var i=!!t.getInput("ARG1");e?(i&&t.moveInputBefore("op_dropdown","ARG1"),t.moveInputBefore("ARG0","op_dropdown")):(i&&t.moveInputBefore("ARG0","ARG1"),t.moveInputBefore("op_dropdown","ARG0"))}Blockly.Blocks[t]={init:function(){var n=this;n.setPreviousStatement(!1),n.setNextStatement(!1),n.setOutput(!0,"Number"),n.setOutputShape(Blockly.OUTPUT_SHAPE_ROUND),n.setInputsInline(!0),n.appendDummyInput("op_dropdown").appendField(new Blockly.FieldDropdown(r.map(function(t){return[e.block[t],t]}),function(t){return e=n,o=i=t,-1!==s.blocks.MATH_FUNCTIONS.unary.indexOf(o)?e.removeInput("ARG1",!0):e.getInput("ARG1")||l(e,!0),void a(e,(r=i,-1!==s.blocks.MATH_FUNCTIONS.infix.indexOf(r)));var e,i,o,r}),"OP"),l(n,!1),i.appendMutation(n,{mutationToDom:function(t){for(var e,i=0;i<n.inputList.length;i++){var o=n.inputList[i];if("op_dropdown"===o.name){e=!1;break}if("ARG0"===o.name){e=!0;break}}return t.setAttribute("op-type",(n.getInput("ARG1")?e?"infix":"binary":"unary").toString()),t},domToMutation:function(t){if(t.hasAttribute("op-type")){var e=t.getAttribute("op-type");"unary"!=e&&l(n,!0),a(n,"infix"===e)}}})}},i.installHelpResources(t,e.name,function(t){return e.tooltip[t.getFieldValue("OP")]},e.url,s.toolbox.getNamespaceColor(e.category))}}(pxt||(pxt={})),function(i){var o,r;o=i.blocks||(i.blocks={}),r=i.blocks.ROUNDING_FUNCTIONS,o.initMathRoundBlock=function(){var t="math_js_round",e=i.blocks.getBlockDefinition(t);Blockly.Blocks[t]={init:function(){var t=this;t.setPreviousStatement(!1),t.setNextStatement(!1),t.setOutput(!0,"Number"),t.setOutputShape(Blockly.OUTPUT_SHAPE_ROUND),t.setInputsInline(!0),t.appendDummyInput("round_dropdown").appendField(new Blockly.FieldDropdown(r.map(function(t){return[e.block[t],t]}),function(t){}),"OP"),t.appendValueInput("ARG0").setCheck("Number")}},o.installHelpResources(t,e.name,function(t){return e.tooltip[t.getFieldValue("OP")]},e.url,i.toolbox.getNamespaceColor(e.category))}}(pxt||(pxt={})),function(o){var n=pxt.svgUtil,t=function(r){function t(t,e,i){var o=r.call(this,t,i)||this;return o.isFieldCustom_=!0,o.SERIALIZABLE=!0,o.onMouseEnter=function(){if(!o.animateRef){var t=50<o.state.interval?o.state.interval:50,e=0;o.animateRef=setInterval(function(){o.preview&&o.frames[e]&&o.preview.src(o.frames[e]),e=(e+1)%o.frames.length},t)}},o.onMouseLeave=function(){o.animateRef&&clearInterval(o.animateRef),o.animateRef=void 0,o.preview&&o.frames[0]&&o.preview.src(o.frames[0])},o.lightMode=e.lightMode,o.params=function(t){var e={initWidth:16,initHeight:16};if(!t)return e;t.filter&&(e.filter=t.filter);return e.initWidth=i(t.initWidth,e.initWidth),e.initHeight=i(t.initHeight,e.initHeight),e;function i(t,e){var i=parseInt(t);return isNaN(i)?e:i}}(e),o.blocksInfo=e.blocksInfo,o.initState(),o}return __extends(t,r),t.prototype.init=function(){this.fieldGroup_||(this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null),this.visible_||(this.fieldGroup_.style.display="none"),this.initState(),this.redrawPreview(),this.sourceBlock_.getSvgRoot().addEventListener("mouseenter",this.onMouseEnter),this.sourceBlock_.getSvgRoot().addEventListener("mouseleave",this.onMouseLeave),this.updateEditable(),this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_),this.render_(),this.mouseDownWrapper_=Blockly.bindEventWithChecks_(this.getClickTarget_(),"mousedown",this,this.onMouseDown_),this.state.interval=this.getParentInterval())},t.prototype.showEditor_=function(){var i=this;this.params.blocksInfo=this.blocksInfo,this.initState();var t=this.getParentInterval();isNaN(t)||(this.state.interval=t);var o=pxt.react.getFieldEditorView("animation-editor",this.state,this.params);this.undoRedoState&&o.restorePersistentData(this.undoRedoState),o.onHide(function(){var t=o.getResult();if(t){var e=i.getValue();i.state=t,isNaN(i.state.interval)||i.setParentInterval(i.state.interval),i.redrawPreview(),i.undoRedoState=o.getPersistentData(),i.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.BlockChange(i.sourceBlock_,"field",i.name,e,i.getValue()))}}),o.show()},t.prototype.render_=function(){r.prototype.render_.call(this),this.size_.height=50,this.size_.width=80},t.prototype.getValue=function(){return this.state?"["+this.state.frames.map(function(t){return pxt.sprite.bitmapToImageLiteral(pxt.sprite.Bitmap.fromData(t),"typescript")}).join(",")+"]":"[]"},t.prototype.doValueUpdate_=function(t){if(null!=t){this.value_=t;var e=t.replace(/[\[\]]/gm,"").split(",").map(function(t){return pxt.sprite.imageLiteralToBitmap(t).data()}).filter(function(t){return t.height&&t.width});e&&e.length&&(this.initState(),this.state.frames=e),this.redrawPreview(),r.prototype.doValueUpdate_.call(this,t)}},t.prototype.redrawPreview=function(){var e=this;if(this.fieldGroup_){pxsim.U.clear(this.fieldGroup_);var t=(new n.Rect).at(35,5).size(40,40).fill("#dedede").stroke("#898989",1).corner(4);this.fieldGroup_.appendChild(t.el);var i=new n.Text("").at(5,30).fill(this.sourceBlock_.getColourSecondary()).setClass("semanticIcon");this.fieldGroup_.appendChild(i.el),this.state&&(this.frames=this.state.frames.map(function(t){return o.bitmapToImageURI(pxt.sprite.Bitmap.fromData(t),32,e.lightMode)}),this.preview=(new n.Image).src(this.frames[0]).at(39,9).size(32,32),this.fieldGroup_.appendChild(this.preview.el))}},t.prototype.getParentIntervalBlock=function(){var t=this.sourceBlock_;if(t.parentBlock_)for(var e=0,i=t.parentBlock_.inputList;e<i.length;e++){var o=i[e];if("frameInterval"===o.name)return o.connection.targetBlock()}},t.prototype.setParentInterval=function(t){var e=this.getParentIntervalBlock();if(e){var i=l(e);i&&e.setFieldValue(String(t),i)}},t.prototype.getParentInterval=function(){var t=this.getParentIntervalBlock();if(t){var e=l(t);if(e)return Number(t.getFieldValue(e))}return 100},t.prototype.initState=function(){this.state||(this.params?this.state={frames:[new pxt.sprite.Bitmap(this.params.initWidth,this.params.initHeight).data()],interval:100}:this.state={frames:[],interval:100})},t}(Blockly.Field);function l(t){return"math_number_minmax"===t.type?"SLIDER":"math_number"===(e=t.type)||"math_integer"===e||"math_whole_number"===e?"NUM":"timePicker"===t.type?"ms":null;var e}o.FieldAnimationEditor=t}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,void 0,void 0,void 0,i)||this;return o.isFieldCustom_=!0,o.CURSOR="pointer",o.params=e,o.setValue(t),o.addArgType("toggle"),o.type_=e.type,o}return __extends(t,r),t.prototype.init=function(){if(!this.fieldGroup_){this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null),this.visible_||(this.fieldGroup_.style.display="none"),null!==this.getArgTypes()&&(this.sourceBlock_.isShadow()?this.sourceBlock_.svgGroup_.setAttribute("data-argument-type",this.getArgTypes()):this.fieldGroup_.setAttribute("data-argument-type",this.getArgTypes()));var t=this.getSize();this.checkElement_=Blockly.utils.dom.createSvgElement("g",{class:"blocklyToggle "+(this.state_?"blocklyToggleOnBreakpoint":"blocklyToggleOffBreakpoint"),transform:"translate(8, "+t.height/2+")"},this.fieldGroup_),this.toggleThumb_=Blockly.utils.dom.createSvgElement("polygon",{class:"blocklyToggleRect",points:"50,5 100,5 125,30 125,80 100,105 50,105 25,80 25,30"},this.checkElement_);var e=this.sourceBlock_.RTL?-t.width/2:t.width/2;this.textElement_=Blockly.utils.dom.createSvgElement("text",{class:"blocklyText",x:e,dy:"0.6ex",y:t.height/2},this.fieldGroup_),this.updateEditable(),this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_),this.switchToggle(this.state_),this.setValue(this.getValue()),this.render_(),this.size_.width=0,this.mouseDownWrapper_=Blockly.bindEventWithChecks_(this.getClickTarget_(),"mousedown",this,this.onMouseDown_)}},t.prototype.updateSize_=function(){this.size_.width=30,this.arrowWidth_=0},t.prototype.getValue=function(){return this.toVal(this.state_)},t.prototype.setValue=function(t){var e=this.fromVal(t);this.state_!==e&&(this.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.sourceBlock_,"field",this.name,this.state_,e)),this.state_=e,this.switchToggle(this.state_))},t.prototype.switchToggle=function(t){this.checkElement_&&(this.updateSize_(),t?(pxt.BrowserUtils.addClass(this.checkElement_,"blocklyToggleOnBreakpoint"),pxt.BrowserUtils.removeClass(this.checkElement_,"blocklyToggleOffBreakpoint")):(pxt.BrowserUtils.removeClass(this.checkElement_,"blocklyToggleOnBreakpoint"),pxt.BrowserUtils.addClass(this.checkElement_,"blocklyToggleOffBreakpoint")),this.checkElement_.setAttribute("transform","translate(-7, -1) scale(0.3)"))},t.prototype.updateTextNode_=function(){r.prototype.updateTextNode_.call(this),this.textElement_&&pxt.BrowserUtils.addClass(this.textElement_,"blocklyToggleText")},t.prototype.render_=function(){this.visible_&&this.textElement_&&(goog.dom.removeChildren(this.textElement_),this.updateSize_())},t.prototype.showEditor_=function(){var t=!this.state_;null!==t&&this.setValue(this.toVal(t))},t.prototype.toVal=function(t){return"number"==this.type_?String(t?"1":"0"):String(t?"true":"false")},t.prototype.fromVal=function(t){return"string"==typeof t?"1"==t||"TRUE"==t.toUpperCase():!!t},t}(Blockly.FieldNumber);t.FieldBreakpoint=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,String(t),"0","255","1","10","Color",i)||this;return o.isFieldCustom_=!0,o.params=e,o.params.min&&(o.min_=parseFloat(o.params.min)),o.params.max&&(o.max_=parseFloat(o.params.max)),o.params.label&&(o.labelText_=o.params.label),o.params.channel&&(o.channel_=o.params.channel),o}return __extends(t,r),t.prototype.setBackground_=function(t){var e=this.createColourStops_().join(",");goog.style.setStyle(t,"background","-moz-linear-gradient(left, "+e+")"),goog.style.setStyle(t,"background","-webkit-linear-gradient(left, "+e+")"),goog.style.setStyle(t,"background","-o-linear-gradient(left, "+e+")"),goog.style.setStyle(t,"background","-ms-linear-gradient(left, "+e+")"),goog.style.setStyle(t,"background","linear-gradient(left, "+e+")"),this.params.sliderWidth&&goog.style.setStyle(t,"width",this.params.sliderWidth+"px")},t.prototype.setReadout_=function(t,e){var i=this.colorWheel(parseInt(e),this.channel_),o=document.createElement("span");o.className="blocklyColorReadout",o.style.backgroundColor=""+i,pxsim.U.clear(t),t.appendChild(o)},t.prototype.createColourStops_=function(){for(var t=[],e=0;e<=255;e+=20)t.push(this.colorWheel(e,this.channel_));return t},t.prototype.colorWheel=function(t,e){return"hsvfast"==e?this.hsvFast(t,255,255):(t=255-t)<85?this.hex(3*t,255,255-3*t):t<170?(t-=85,this.hex(255,255-3*t,3*t)):(t-=170,this.hex(255-3*t,3*t,255))},t.prototype.hsvFast=function(t,e,i){var o=t%255>>0;o<0&&(o+=255);var r,n,l,a=i*(255-e)/255>>0,s=i-a,c=(o=192*o/255>>0)/64>>0,u=o%64>>0,p=(u*s/63.75>>0)+a,d=((63-u)*s/63.75>>0)+a;return c?1==c?(r=a,n=d,l=p):(r=p,n=a,l=d):(r=d,n=p,l=a),this.hex(r,n,l)},t.prototype.hex=function(t,e,i){return"#"+this.componentToHex(255&t)+this.componentToHex(255&e)+this.componentToHex(255&i)},t.prototype.componentToHex=function(t){var e=t.toString(16);return 1==e.length?"0"+e:e},t}(Blockly.FieldSlider);t.FieldColorWheel=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(l){function t(t,e,i){var o=l.call(this,t,i)||this;if(o.isFieldCustom_=!0,o.valueMode_="rgb",e.colours)o.setColours(JSON.parse(e.colours));else if(pxt.appTarget.runtime&&pxt.appTarget.runtime.palette){var r=pxt.Util.clone(pxt.appTarget.runtime.palette);r[0]="#dedede";var n=void 0;pxt.appTarget.runtime.paletteNames&&((n=pxt.Util.clone(pxt.appTarget.runtime.paletteNames))[0]=lf("transparent")),o.setColours(r,n)}return e.columns&&o.setColumns(parseInt(e.columns)),e.className&&(o.className_=e.className),e.valueMode&&(o.valueMode_=e.valueMode),o}return __extends(t,l),t.prototype.getValue=function(t){if(t)return this.value_;switch(this.valueMode_){case"hex":return'"'+this.value_+'"';case"rgb":return-1<this.value_.indexOf("#")?"0x"+this.value_.replace(/^#/,""):this.value_;case"index":if(!this.value_)return"-1";for(var e=this.getColours_(),i=0;i<e.length;i++)if(this.value_.toUpperCase()===e[i].toUpperCase())return i+""}return this.value_},t.prototype.setValue=function(t){(t=function(t,e){if(t){var i=/Colors\.([a-zA-Z]+)/.exec(t),o=/(0x|#)([0-9a-fA-F]+)/.exec(t);if(i)switch(i[1].toLocaleLowerCase()){case"red":return"#FF0000";case"orange":return"#FF7F00";case"yellow":return"#FFFF00";case"green":return"#00FF00";case"blue":return"#0000FF";case"indigo":return"#4B0082";case"violet":return"#8A2BE2";case"purple":return"#A033E5";case"pink":return"#FF007F";case"white":return"#FFFFFF";case"black":return"#000000";default:return t}else if(o){var r=o[2];if(3===r.length){for(var n="#",l=0;l<r.length;l++){var a=r.charAt(l);n+=a+a}return n}if(6===r.length)return"#"+r}if(e){var s=parseInt(t);return isNaN(s)||null==e[s]?e[0]:e[s]}}return t}(t,this.getColours_()))&&(this.sourceBlock_&&Blockly.Events.isEnabled()&&this.value_!=t&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.sourceBlock_,"field",this.name,this.value_,t)),this.value_=t,this.sourceBlock_&&this.sourceBlock_.setColour(t,t,t))},t.prototype.showEditor_=function(){l.prototype.showEditor_.call(this),this.className_&&this.colorPicker_&&pxt.BrowserUtils.addClass(this.colorPicker_,this.className_)},t.prototype.getColours_=function(){return this.colours_},t}(Blockly.FieldColour);t.FieldColorNumber=e}(pxtblockly||(pxtblockly={})),function(l){var t=function(n){function f(t,e,i){var o=n.call(this,e.data)||this;o.isFieldCustom_=!0,o.buttonClick_=function(t){var e=t.target.getAttribute("data-value");null!==e&&(this.setValue(e),this.closeModal_&&(this.close(),this.closeModal_=!1))},o.buttonClickAndClose_=function(t){this.closeModal_=!0,this.buttonClick_(t)},o.columns_=parseInt(e.columns)||4,o.maxRows_=parseInt(e.maxRows)||0,o.width_=parseInt(e.width)||200,o.backgroundColour_=l.parseColour(e.colour),o.borderColour_=pxt.toolbox.fadeColor(o.backgroundColour_,.4,!1);var r={xOffset:parseInt(e.tooltipsXOffset)||15,yOffset:parseInt(e.tooltipsYOffset)||-10};return o.tooltipConfig_=r,o.hasSearchBar_=!!e.hasSearchBar||!1,o.hideRect_=!!e.hideRect||!1,o}return __extends(f,n),f.prototype.dispose=function(){n.prototype.dispose.call(this),this.disposeTooltip(),this.disposeIntersectionObserver()},f.prototype.createTooltip_=function(){this.gridTooltip_||(this.gridTooltip_=document.createElement("div"),this.gridTooltip_.className="goog-tooltip blocklyGridPickerTooltip",this.gridTooltip_.style.position="absolute",this.gridTooltip_.style.display="none",this.gridTooltip_.style.visibility="hidden",document.body.appendChild(this.gridTooltip_))},f.prototype.populateTableContainer=function(t,e,i){pxsim.U.removeChildren(e),0==t.length&&(this.firstItem_=void 0);for(var o=0;o<t.length/this.columns_;o++){var r=this.populateRow(o,t,e);e.appendChild(r)}},f.prototype.populateRow=function(t,u,p){var d=this,e=this.columns_,h=document.createElement("div");h.className="blocklyGridPickerRow";for(var i=function(t){var o=u[t][0],r=u[t][1],n=document.createElement("div");n.className="goog-menuitem goog-option",n.setAttribute("id",":"+t),n.setAttribute("role","menuitem"),n.style.userSelect="none",n.title=o.alt||o,n.setAttribute("data-value",r);var e=document.createElement("div");e.setAttribute("class","goog-menuitem-content"),e.title=o.alt||o,e.setAttribute("data-value",r);var l="object"==typeof o,i=m.backgroundColour_;if(r==m.getValue()&&(n.setAttribute("aria-selected","true"),pxt.BrowserUtils.addClass(n,"goog-option-selected"),i=m.sourceBlock_.getColourTertiary(),m.selectedItemDom=n,l&&!m.shouldShowTooltips()&&m.updateSelectedBar_(o,r)),n.style.backgroundColor=i,n.style.borderColor=m.borderColour_,l){var a=new Image(o.width,o.height);a.setAttribute("draggable","false"),"IntersectionObserver"in window?(a.src=f.DEFAULT_IMG,a.setAttribute("data-src",o.src),m.observer.observe(a)):a.src=o.src,a.alt=o.alt||"",a.setAttribute("data-value",r),e.appendChild(a)}else e.textContent=o;if(m.shouldShowTooltips()){Blockly.bindEvent_(n,"click",m,m.buttonClickAndClose_);var s=m.sourceBlock_.RTL?-m.tooltipConfig_.xOffset:m.tooltipConfig_.xOffset,c=m.tooltipConfig_.yOffset;Blockly.bindEvent_(n,"mousemove",m,function(t){if(l){d.gridTooltip_.style.top=t.clientY+c+"px",d.gridTooltip_.style.left=t.clientX+s+"px";var e=document.elementFromPoint(t.clientX,t.clientY),i=e.title||e.alt;d.gridTooltip_.textContent=i,d.gridTooltip_.style.visibility=i?"visible":"hidden",d.gridTooltip_.style.display=i?"":"none"}pxt.BrowserUtils.addClass(n,"goog-menuitem-highlight"),p.setAttribute("aria-activedescendant",n.id)}),Blockly.bindEvent_(n,"mouseout",m,function(t){l&&(d.gridTooltip_.style.visibility="hidden",d.gridTooltip_.style.display="none"),pxt.BrowserUtils.removeClass(n,"goog-menuitem-highlight"),p.removeAttribute("aria-activedescendant")})}else l?(m.selectedBar_.style.display="",Blockly.bindEvent_(n,"click",m,function(t){if(d.closeModal_)d.buttonClick_(t);else{for(var e=p.getElementsByClassName("goog-menuitem-highlight"),i=0;i<e.length;i++)pxt.BrowserUtils.removeClass(e[i],"goog-menuitem-highlight");pxt.BrowserUtils.addClass(n,"goog-menuitem-highlight"),d.updateSelectedBar_(o,r)}})):(Blockly.bindEvent_(n,"click",m,m.buttonClickAndClose_),Blockly.bindEvent_(n,"mouseup",m,m.buttonClickAndClose_));n.appendChild(e),h.appendChild(n),0==t&&(m.firstItem_=n)},m=this,o=e*t;o<Math.min(e*t+e,u.length);o++)i(o);return h},f.prototype.shouldShowRect_=function(){return!this.hideRect_&&!this.sourceBlock_.isShadow()},f.prototype.setValue=function(t){if(null!==t&&t!==this.value_){this.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.sourceBlock_,"field",this.name,this.value_,t)),this.value_=t;for(var e=this.getOptions(),i=0;i<e.length;i++)if(e[i][1]==t){var o=e[i][0];return void("object"==typeof o?(this.imageJson_=o,this.setText(o.alt)):(this.imageJson_=null,this.setText(o)))}this.setText(t)}},f.prototype.close=function(){this.disposeTooltip(),Blockly.WidgetDiv.hideIfOwner(this),Blockly.Events.setGroup(!1)},f.prototype.getFirstItem=function(){return this.firstItem_},f.prototype.highlightFirstItem=function(t){var e=t.childNodes;if(e.length&&e[0].childNodes){for(var i=0;i<e.length;++i)for(var o=e[i].childNodes.length,r=0;r<o;++r){var n=e[i].childNodes[r];pxt.BrowserUtils.removeClass(n,"goog-menuitem-highlight"),pxt.BrowserUtils.removeClass(n,"goog-option-selected")}e[0].childNodes[0].className+=" goog-menuitem-highlight"}},f.prototype.highlightAndScrollSelected=function(t,e){this.selectedItemDom&&goog.style.scrollIntoContainerView(this.selectedItemDom,e,!0)},f.prototype.showEditor_=function(){var t=this;Blockly.WidgetDiv.show(this,this.sourceBlock_.RTL,function(){t.onClose_()}),this.setupIntersectionObserver_(),this.createTooltip_();var e=document.createElement("div");this.positionMenu_(e)},f.prototype.positionMenu_=function(t){var e=Blockly.utils.getViewportBBox(),i=this.getAnchorDimensions_(),o=this.createWidget_(t),r=o.paddingContainer,n=o.scrollContainer,l={width:r.offsetWidth,height:r.offsetHeight},a=goog.dom.getViewportSize();this.width_>a.width&&(this.width_=a.width),t.style.width=this.width_+"px";var s=0;if(this.hasSearchBar_&&(s+=50),this.selectedBar_&&(s+=50),this.maxRows_){var c=t.children[0].offsetHeight*(this.maxRows_+.3);a.height<c+s&&(c=a.height-s),l.height>c&&(n.style.overflowY="auto",goog.style.setHeight(n,c),l.height=c)}l.height+=s,this.sourceBlock_.RTL&&Blockly.utils.uiMenu.adjustBBoxesForRTL(e,i,l),Blockly.WidgetDiv.positionWithAnchor(e,i,l,this.sourceBlock_.RTL),this.highlightAndScrollSelected(t,n)},f.prototype.shouldShowTooltips=function(){return!pxt.BrowserUtils.isMobile()},f.prototype.getAnchorDimensions_=function(){var t=this.getScaledBBox_();return this.sourceBlock_.RTL?t.right+=Blockly.FieldDropdown.CHECKMARK_OVERHANG:t.left-=Blockly.FieldDropdown.CHECKMARK_OVERHANG,t},f.prototype.createWidget_=function(t){var e=Blockly.WidgetDiv.DIV,i=this.getOptions();t.setAttribute("role","menu"),t.setAttribute("aria-haspopup","true");var o=document.createElement("div"),r=document.createElement("div");if(r.style.border="solid 1px "+this.borderColour_,t.style.backgroundColor=this.backgroundColour_,o.style.backgroundColor=this.backgroundColour_,r.style.backgroundColor=this.backgroundColour_,t.className="blocklyGridPickerMenu",o.className="blocklyGridPickerScroller",r.className="blocklyGridPickerPadder",r.appendChild(o),o.appendChild(t),e.appendChild(r),this.hasSearchBar_){var n=this.createSearchBar_(t,o,i);r.insertBefore(n,r.childNodes[0])}return this.shouldShowTooltips()||(this.selectedBar_=this.createSelectedBar_(),r.appendChild(this.selectedBar_)),this.populateTableContainer(i,t,o),{paddingContainer:r,scrollContainer:o}},f.prototype.createSearchBar_=function(r,i,n){var l=this,t=document.createElement("div");t.setAttribute("class","ui fluid icon input");var e=document.createElement("i");e.setAttribute("class","search icon");var a=document.createElement("input");return a.setAttribute("type","search"),a.setAttribute("id","search-bar"),a.setAttribute("class","blocklyGridPickerSearchBar"),a.setAttribute("placeholder",pxt.Util.lf("Search")),a.addEventListener("click",function(){a.focus(),a.setSelectionRange(0,a.value.length)}),a.addEventListener("keyup",pxt.Util.debounce(function(){var t=a.value,o=new RegExp(t,"i"),e=n.filter(function(t){var e=t[0].alt,i=t[1];return e?o.test(e):o.test(i)});l.populateTableContainer.bind(l)(e,r,i),t?l.highlightFirstItem(r):l.highlightAndScrollSelected(r,i),l.gridTooltip_.style.visibility="hidden",l.gridTooltip_.style.display="none"},300,!1)),a.addEventListener("keyup",function(t){if(13==t.which){var e=r.childNodes[0];if(e){var i=e.childNodes[0];i&&(l.closeModal_=!0,i.click())}}}),t.appendChild(a),t.appendChild(e),t},f.prototype.createSelectedBar_=function(){var t=this,e=document.createElement("div");e.setAttribute("class","blocklyGridPickerSelectedBar"),e.style.display="none";var i=document.createElement("div"),o=document.createElement("div");o.className="blocklyGridPickerSelectedImage",i.appendChild(o),this.selectedImg_=document.createElement("img"),this.selectedImg_.setAttribute("width","30px"),this.selectedImg_.setAttribute("height","30px"),this.selectedImg_.setAttribute("draggable","false"),this.selectedImg_.style.display="none",this.selectedImg_.src=f.DEFAULT_IMG,o.appendChild(this.selectedImg_),this.selectedBarText_=document.createElement("span"),this.selectedBarText_.className="blocklyGridPickerTooltip",i.appendChild(this.selectedBarText_);var r=document.createElement("div"),n=document.createElement("div");n.className="ui buttons mini",r.appendChild(n);var l=document.createElement("button");l.className="ui button icon green";var a=document.createElement("i");a.className="icon check",l.appendChild(a),Blockly.bindEvent_(l,"click",this,function(){t.setValue(t.selectedBarValue_),t.close()});var s=document.createElement("button");s.className="ui button icon red";var c=document.createElement("i");return c.className="icon cancel",s.appendChild(c),Blockly.bindEvent_(s,"click",this,function(){t.close()}),n.appendChild(l),n.appendChild(s),e.appendChild(i),e.appendChild(r),e},f.prototype.updateSelectedBar_=function(t,e){t.src&&(this.selectedImg_.src=t.src,this.selectedImg_.style.display=""),this.selectedImg_.alt=t.alt||t,this.selectedBarText_.textContent=t.alt||t,this.selectedBarValue_=e},f.prototype.setupIntersectionObserver_=function(){var o=this;if("IntersectionObserver"in window){this.disposeIntersectionObserver();this.observer=new IntersectionObserver(function(t){t.forEach(function(t){var e,i;0<t.intersectionRatio&&(o.observer.unobserve(t.target),e=t.target,(i=e.getAttribute("data-src"))&&(e.src=i,e.removeAttribute("data-src")))})},{rootMargin:"20px 0px",threshold:.01})}},f.prototype.disposeIntersectionObserver=function(){this.observer&&(this.observer=null)},f.prototype.disposeTooltip=function(){this.gridTooltip_&&(pxsim.U.remove(this.gridTooltip_),this.gridTooltip_=null)},f.prototype.onClose_=function(){this.disposeTooltip()},f.prototype.setText=function(t){if(null!==t&&t!==this.text_){this.text_=t,this.updateTextNode_(),this.imageJson_&&this.textElement_?(this.textElement_.setAttribute("class",this.textElement_.getAttribute("class")+" blocklyHidden"),this.imageElement_.parentNode.appendChild(this.arrow_)):this.textElement_&&(this.textElement_.setAttribute("class",this.textElement_.getAttribute("class")+" blocklyDropdownText"),this.textElement_.parentNode.appendChild(this.arrow_));var e=this.sourceBlock_;e&&e.rendered&&(e.render(),e.bumpNeighbours_())}},f.prototype.updateSize_=function(){var t;this.imageJson_?(t=this.imageJson_.width+5,this.arrowY_=this.imageJson_.height/2):t=Blockly.Field.getCachedWidth(this.textElement_),this.EDITABLE&&(t+=Blockly.BlockSvg.EDITABLE_FIELD_PADDING),this.arrowWidth_=0,this.positionArrow&&(this.arrowWidth_=this.positionArrow(t),t+=this.arrowWidth_),this.box_&&(t+=2*Blockly.BlockSvg.BOX_FIELD_PADDING),this.size_.width=t},f.prototype.updateTextNode_=function(){if(this.textElement_||this.imageElement_){var t=this.text_;if(t.length>this.maxDisplayLength?(t=t.substring(0,this.maxDisplayLength-2)+"…",this.textElement_.setAttribute("class","blocklyText blocklyTextTruncated")):this.textElement_.setAttribute("class","blocklyText"),goog.dom.removeChildren(this.textElement_),goog.dom.removeNode(this.imageElement_),this.imageElement_=null,this.imageJson_)this.imageElement_=Blockly.utils.dom.createSvgElement("image",{y:5,x:8,height:this.imageJson_.height+"px",width:this.imageJson_.width+"px",cursor:"pointer"},null),this.imageElement_.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",this.imageJson_.src),this.size_.height=Number(this.imageJson_.height)+10,this.sourceBlock_.RTL&&this.imageElement_.setAttribute("transform","translate("+this.arrowWidth_+", 0)"),this.textElement_.parentNode.appendChild(this.imageElement_);else{t=t.replace(/\s/g,Blockly.Field.NBSP),this.sourceBlock_.RTL&&t&&(t+="‏"),t||(t=Blockly.Field.NBSP);var e=document.createTextNode(t);this.textElement_.appendChild(e)}this.size_.width=0}},f.DEFAULT_IMG="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==",f}(Blockly.FieldDropdown);l.FieldGridPicker=t}(pxtblockly||(pxtblockly={})),function(n){var t=function(r){function t(t,e,i){var o=r.call(this,e.data)||this;return o.isFieldCustom_=!0,o.buttonClick_=function(t){var e=t.target.getAttribute("data-value");e&&(this.setValue(e),this.setText(e),Blockly.DropDownDiv.hide())},o.columns_=parseInt(e.columns),o.maxRows_=parseInt(e.maxRows)||0,o.width_=parseInt(e.width)||300,o.backgroundColour_=n.parseColour(e.colour),o.borderColour_=pxt.toolbox.fadeColor(o.backgroundColour_,.4,!1),o}return __extends(t,r),t.prototype.showEditor_=function(){if(!Blockly.DropDownDiv.hideIfOwner(this)){Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent();var t=Blockly.DropDownDiv.getContentDiv(),e=document.createElement("div");e.setAttribute("role","menu"),e.setAttribute("aria-haspopup","true");for(var i=this.getOptions(),o=0,r=0;r<i.length;r++){var n=i[r][0],l=i[r][1];if("placeholder"!=n.type){var a=document.createElement("button");a.setAttribute("id",":"+r),a.setAttribute("role","menuitem"),a.setAttribute("class","blocklyDropDownButton"),a.title=n.alt;var s=n.height;this.columns_?(s=this.width_/this.columns_-8,a.style.width=s+"px",a.style.height=s+"px"):(a.style.width=n.width+"px",a.style.height=n.height+"px"),o<s&&(o=s);var c=this.backgroundColour_;l==this.getValue()&&(c=this.sourceBlock_.getColourTertiary(),a.setAttribute("aria-selected","true")),a.style.backgroundColor=c,a.style.borderColor=this.borderColour_,Blockly.bindEvent_(a,"click",this,this.buttonClick_),Blockly.bindEvent_(a,"mouseover",a,function(){this.setAttribute("class","blocklyDropDownButton blocklyDropDownButtonHover"),e.setAttribute("aria-activedescendant",this.id)}),Blockly.bindEvent_(a,"mouseout",a,function(){this.setAttribute("class","blocklyDropDownButton"),e.removeAttribute("aria-activedescendant")});var u=document.createElement("img");u.src=n.src,a.setAttribute("data-value",l),u.setAttribute("data-value",l),a.appendChild(u),e.appendChild(a)}else{var p=document.createElement("span");p.setAttribute("class","blocklyDropDownPlaceholder"),p.style.width=n.width+"px",p.style.height=n.height+"px",e.appendChild(p)}}e.style.width=this.width_+"px",t.appendChild(e),this.maxRows_&&(t.style.maxHeight=(this.maxRows_+.4)*(o+8)+"px"),pxt.BrowserUtils.isFirefox()&&(t.style.paddingRight="20px"),Blockly.DropDownDiv.setColour(this.backgroundColour_,this.borderColour_),Blockly.DropDownDiv.showPositionedByBlock(this,this.sourceBlock_,this.onHide_.bind(this)),this.sourceBlock_.isShadow()?(this.savedPrimary_=this.sourceBlock_.getColour(),this.sourceBlock_.setColour(this.sourceBlock_.getColourTertiary(),this.sourceBlock_.getColourSecondary(),this.sourceBlock_.getColourTertiary())):this.box_&&this.box_.setAttribute("fill",this.sourceBlock_.getColourTertiary())}},t.prototype.onHide_=function(){var t=Blockly.DropDownDiv.getContentDiv();t.removeAttribute("role"),t.removeAttribute("aria-haspopup"),t.removeAttribute("aria-activedescendant"),t.style.width="",t.style.paddingRight="",this.sourceBlock_&&(this.sourceBlock_.isShadow()?this.sourceBlock_.setColour(this.savedPrimary_,this.sourceBlock_.getColourSecondary(),this.sourceBlock_.getColourTertiary()):this.box_&&this.box_.setAttribute("fill",this.sourceBlock_.getColour()))},t.prototype.setText=function(t){if(null!==t&&t!==this.text_){this.text_=t,this.updateTextNode_(),this.imageJson_&&this.textElement_?(this.textElement_.setAttribute("class",this.textElement_.getAttribute("class")+" blocklyHidden"),this.imageElement_.parentNode.appendChild(this.arrow_)):this.textElement_&&(this.textElement_.setAttribute("class",this.textElement_.getAttribute("class")+" blocklyDropdownText"),this.textElement_.parentNode.appendChild(this.arrow_));var e=this.sourceBlock_;e&&e.rendered&&(e.render(),e.bumpNeighbours_())}},t.prototype.updateSize_=function(){var t=this.imageJson_.width+5;this.EDITABLE&&(t+=Blockly.BlockSvg.EDITABLE_FIELD_PADDING),this.arrowY_=this.imageJson_.height/2,this.arrowWidth_=0,this.positionArrow&&(this.arrowWidth_=this.positionArrow(t),t+=this.arrowWidth_),this.box_&&(t+=2*Blockly.BlockSvg.BOX_FIELD_PADDING),this.size_.width=t},t.prototype.updateTextNode_=function(){if(this.textElement_||this.imageElement_){var t=this.text_;if(t.length>this.maxDisplayLength?(t=t.substring(0,this.maxDisplayLength-2)+"…",this.textElement_.setAttribute("class","blocklyText blocklyTextTruncated")):this.textElement_.setAttribute("class","blocklyText"),goog.dom.removeChildren(this.textElement_),goog.dom.removeNode(this.imageElement_),this.imageElement_=null,this.imageJson_)this.imageElement_=Blockly.utils.dom.createSvgElement("image",{y:5,x:8,height:this.imageJson_.height+"px",width:this.imageJson_.width+"px"},null),this.imageElement_.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",this.imageJson_.src),this.size_.height=Number(this.imageJson_.height)+10,this.textElement_.parentNode.appendChild(this.imageElement_);else{t=t.replace(/\s/g,Blockly.Field.NBSP),this.sourceBlock_.RTL&&t&&(t+="‏"),t||(t=Blockly.Field.NBSP);var e=document.createTextNode(t);this.textElement_.appendChild(e)}this.size_.width=0}},t}(Blockly.FieldDropdown);n.FieldImageDropdown=t}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,e,i)||this;return o.isFieldCustom_=!0,o.shouldSort_=e.sort,o.addLabel_=!!e.addLabel,o}return __extends(t,r),t.prototype.showEditor_=function(){if(!Blockly.DropDownDiv.hideIfOwner(this)){Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent();var t=Blockly.DropDownDiv.getContentDiv(),e=document.createElement("div");e.setAttribute("role","menu"),e.setAttribute("aria-haspopup","true");var i=this.getOptions();this.shouldSort_&&i.sort();for(var o=0;o<i.length;o++){var r=i[o][0],n=i[o][1];if("placeholder"!=r.type){var l=document.createElement("button");l.setAttribute("id",":"+o),l.setAttribute("role","menuitem"),l.setAttribute("class","blocklyDropDownButton"),l.title=r.alt,this.columns_?l.style.width=this.width_/this.columns_-8+"px":(l.style.width=r.width+"px",l.style.height=r.height+"px");var a=this.sourceBlock_.getColour();n==this.getValue()&&(a=this.sourceBlock_.getColourTertiary(),l.setAttribute("aria-selected","true")),l.style.backgroundColor=a,l.style.borderColor=this.sourceBlock_.getColourTertiary(),Blockly.bindEvent_(l,"click",this,this.buttonClick_),Blockly.bindEvent_(l,"mouseover",l,function(){this.setAttribute("class","blocklyDropDownButton blocklyDropDownButtonHover"),e.setAttribute("aria-activedescendant",this.id)}),Blockly.bindEvent_(l,"mouseout",l,function(){this.setAttribute("class","blocklyDropDownButton"),e.removeAttribute("aria-activedescendant")});var s=document.createElement("img");if(s.src=r.src,l.setAttribute("data-value",n),s.setAttribute("data-value",n),l.appendChild(s),this.addLabel_){var c=this.createTextNode_(r.alt);c.setAttribute("data-value",n),l.appendChild(c)}e.appendChild(l)}else{var u=document.createElement("span");u.setAttribute("class","blocklyDropDownPlaceholder"),u.style.width=r.width+"px",u.style.height=r.height+"px",e.appendChild(u)}}e.style.width=this.width_+"px",t.appendChild(e),Blockly.DropDownDiv.setColour(this.sourceBlock_.getColour(),this.sourceBlock_.getColourTertiary());var p=this.sourceBlock_.workspace.scale,d={width:this.size_.width,height:this.size_.height};d.width*=p,d.height*=p;var h=this.fieldGroup_.getBoundingClientRect(),m=h.left+d.width/2,f=h.top+d.height,g=m,y=h.top;Blockly.DropDownDiv.setBoundsElement(this.sourceBlock_.workspace.getParentSvg().parentNode),Blockly.DropDownDiv.show(this,m,f,g,y,this.onHide_.bind(this)),this.sourceBlock_.isShadow()?(this.savedPrimary_=this.sourceBlock_.getColour(),this.sourceBlock_.setColour(this.sourceBlock_.getColourTertiary(),this.sourceBlock_.getColourSecondary(),this.sourceBlock_.getColourTertiary())):this.box_&&this.box_.setAttribute("fill",this.sourceBlock_.getColourTertiary())}},t.prototype.createTextNode_=function(t){var e=document.createElement("span");return e.setAttribute("class","blocklyDropdownTextLabel"),e.textContent=t,e},t}(t.FieldImageDropdown);t.FieldImages=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(o){function t(t){var i,e=o.call(this,(i=t,function(){var e=[];if(this.sourceBlock_&&this.sourceBlock_.workspace){var t=this.sourceBlock_.workspace.getVariablesOfType(r(i.name));t.forEach(function(t){e.push([t.name,t.name])})}return e.push([lf("Add a new {0}...",i.memberName),"CREATE"]),e}))||this;return e.opts=t,e}return __extends(t,o),t.prototype.init=function(){o.prototype.init.call(this),this.initVariables()},t.prototype.onItemSelected=function(t,e){var i=this;"CREATE"===e.getValue()?function n(l,a,s,c){Blockly.prompt(s,a.promptHint,function(t){if(t){var e=!1;if(pxtc.isIdentifierStart(t.charCodeAt(0),2)){e=!0;for(var i=1;i<t.length;i++)pxtc.isIdentifierPart(t.charCodeAt(i),2)||(e=!1)}if(!e)return void Blockly.alert(lf("Names must start with a letter and can only contain letters, numbers, '$', and '_'."),function(){return n(l,a,s,c)});for(var o=u(l,a.name),i=0;i<o.length;i++){var r=o[i];if(r===t)return void Blockly.alert(lf("A {0} named '{1}' already exists.",a.memberName,t),function(){return n(l,a,s,c)})}t===a.createFunctionName&&Blockly.alert(lf("'{0}' is a reserved name.",a.createFunctionName),function(){return n(l,a,s,c)}),c(p(l,a,t))}})}(this.sourceBlock_.workspace,this.opts,lf("New {0}:",this.opts.memberName),function(t){return t&&i.setValue(t)}):o.prototype.onItemSelected.call(this,t,e)},t.prototype.initVariables=function(){var e=this;if(this.sourceBlock_&&this.sourceBlock_.workspace)if(this.sourceBlock_.isInFlyout)this.setText(this.opts.initialMembers[0]);else{var i=this.sourceBlock_.workspace,o=u(i,this.opts.name);this.opts.initialMembers.forEach(function(t){-1===o.indexOf(t)&&p(i,e.opts,t)}),"CREATE"===this.getValue()&&this.opts.initialMembers.length&&this.setValue(this.opts.initialMembers[0])}},t}(Blockly.FieldDropdown);function u(t,e){var i=t.getVariablesOfType(r(e));return i&&i.length?i.map(function(t){return t.name}):[]}function p(t,e,i){return Blockly.Variables.getOrCreateVariablePackage(t,null,i,r(e.name)),i}function r(t){return"KIND_"+t}t.FieldKind=e}(pxtblockly||(pxtblockly={}));var LabelMode,pxtblockly,rowRegex=/^.*[\.#].*$/;!function(t){t[t.None=0]="None",t[t.Number=1]="Number",t[t.Letter=2]="Letter"}(LabelMode||(LabelMode={})),function(t){var e=function(r){function a(t,e,i){var l=r.call(this,t,i)||this;if(l.isFieldCustom_=!0,l.SERIALIZABLE=!0,l.onColor="#FFFFFF",l.matrixWidth=5,l.matrixHeight=5,l.yAxisLabel=LabelMode.None,l.xAxisLabel=LabelMode.None,l.cellState=[],l.cells=[],l.dontHandleMouseEvent_=function(t){t.stopPropagation(),t.preventDefault()},l.clearLedDragHandler=function(t){var e=l.sourceBlock_.getSvgRoot();pxsim.pointerEvents.down.forEach(function(t){return e.removeEventListener(t,l.dontHandleMouseEvent_)}),e.removeEventListener(pxsim.pointerEvents.move,l.dontHandleMouseEvent_),document.removeEventListener(pxsim.pointerEvents.up,l.clearLedDragHandler),document.removeEventListener(pxsim.pointerEvents.leave,l.clearLedDragHandler),Blockly.Touch.clearTouchIdentifier(),l.elt.removeEventListener(pxsim.pointerEvents.move,l.handleRootMouseMoveListener),t.stopPropagation(),t.preventDefault()},l.toggleRect=function(t,e){l.cellState[t][e]=l.currentDragState_,l.updateValue()},l.handleRootMouseMoveListener=function(t){var e,i;t.changedTouches&&1==t.changedTouches.length?(e=t.changedTouches[0].clientX,i=t.changedTouches[0].clientY):(e=t.clientX,i=t.clientY);var o=document.elementFromPoint(e,i);if(o){var r=o.getAttribute("data-x"),n=o.getAttribute("data-y");null!=r&&null!=n&&l.toggleRect(parseInt(r),parseInt(n))}},l.params=e,void 0!==l.params.rows){var o=parseInt(l.params.rows);isNaN(o)||(l.matrixHeight=o)}if(void 0!==l.params.columns){o=parseInt(l.params.columns);isNaN(o)||(l.matrixWidth=o)}return void 0!==l.params.onColor&&(l.onColor=l.params.onColor),void 0!==l.params.offColor&&(l.offColor=l.params.offColor),l}return __extends(a,r),a.prototype.showEditor_=function(){},a.prototype.initMatrix=function(){if(!this.sourceBlock_.isInsertionMarker()){this.elt=pxsim.svg.parseString('<svg xmlns="http://www.w3.org/2000/svg" id="field-matrix" />');for(var t=0;t<this.matrixWidth;t++){this.cellState.push([]),this.cells.push([]);for(var e=0;e<this.matrixHeight;e++)this.cellState[t].push(!1)}this.restoreStateFromString();for(t=0;t<this.matrixWidth;t++)for(e=0;e<this.matrixHeight;e++)this.createCell(t,e);if(this.updateValue(),this.xAxisLabel!==LabelMode.None){var i=this.matrixHeight*(a.CELL_WIDTH+a.CELL_VERTICAL_MARGIN)+2*a.CELL_VERTICAL_MARGIN+a.BOTTOM_MARGIN,o=pxsim.svg.child(this.elt,"g",{transform:"translate(0 "+i+")"});for(t=0;t<this.matrixWidth;t++){var r=this.getYAxisWidth()+t*(a.CELL_WIDTH+a.CELL_HORIZONTAL_MARGIN)+a.CELL_WIDTH/2+a.CELL_HORIZONTAL_MARGIN/2;pxsim.svg.child(o,"text",{x:r,class:"blocklyText"}).textContent=this.getLabel(t,this.xAxisLabel)}}if(this.yAxisLabel!==LabelMode.None){var n=pxsim.svg.child(this.elt,"g",{});for(t=0;t<this.matrixHeight;t++){i=t*(a.CELL_WIDTH+a.CELL_VERTICAL_MARGIN)+a.CELL_WIDTH/2+2*a.CELL_VERTICAL_MARGIN;pxsim.svg.child(n,"text",{x:0,y:i,class:"blocklyText"}).textContent=this.getLabel(t,this.yAxisLabel)}}this.fieldGroup_.appendChild(this.elt)}},a.prototype.getLabel=function(t,e){switch(e){case LabelMode.Letter:return String.fromCharCode(t+65);default:return(t+1).toString()}},a.prototype.createCell=function(i,o){var r=this,t=i*(a.CELL_WIDTH+a.CELL_HORIZONTAL_MARGIN)+a.CELL_HORIZONTAL_MARGIN+this.getYAxisWidth(),e=o*(a.CELL_WIDTH+a.CELL_VERTICAL_MARGIN)+a.CELL_VERTICAL_MARGIN,n=pxsim.svg.child(this.elt,"g",{transform:"translate("+t+" "+e+")"}),l=pxsim.svg.child(n,"rect",{class:"blocklyLed"+(this.cellState[i][o]?"On":"Off"),cursor:"pointer",width:a.CELL_WIDTH,height:a.CELL_WIDTH,fill:this.getColor(i,o),"data-x":i,"data-y":o,rx:a.CELL_CORNER_RADIUS});this.cells[i][o]=l,this.sourceBlock_.workspace.isFlyout||pxsim.pointerEvents.down.forEach(function(t){return l.addEventListener(t,function(t){var e=r.sourceBlock_.getSvgRoot();r.currentDragState_=!r.cellState[i][o],Blockly.hideChaff(),r.sourceBlock_.select(),r.toggleRect(i,o),pxsim.pointerEvents.down.forEach(function(t){return e.addEventListener(t,r.dontHandleMouseEvent_)}),e.addEventListener(pxsim.pointerEvents.move,r.dontHandleMouseEvent_),document.addEventListener(pxsim.pointerEvents.up,r.clearLedDragHandler),document.addEventListener(pxsim.pointerEvents.leave,r.clearLedDragHandler),r.elt.addEventListener(pxsim.pointerEvents.move,r.handleRootMouseMoveListener),t.stopPropagation(),t.preventDefault()},!1)})},a.prototype.getColor=function(t,e){return this.cellState[t][e]?this.onColor:this.offColor||a.DEFAULT_OFF_COLOR},a.prototype.getOpacity=function(t,e){return this.cellState[t][e]?"1.0":"0.2"},a.prototype.updateCell=function(t,e){var i=this.cells[t][e];i.setAttribute("fill",this.getColor(t,e)),i.setAttribute("fill-opacity",this.getOpacity(t,e)),i.setAttribute("class","blocklyLed"+(this.cellState[t][e]?"On":"Off"))},a.prototype.setValue=function(t,e){if(void 0===e&&(e=!0),r.prototype.setValue.call(this,String(t)),this.elt){e&&this.restoreStateFromString();for(var i=0;i<this.matrixWidth;i++)for(var o=0;o<this.matrixHeight;o++)this.updateCell(i,o)}},a.prototype.render_=function(){this.visible_?(this.elt||this.initMatrix(),this.size_.height=Number(this.matrixHeight)*(a.CELL_WIDTH+a.CELL_VERTICAL_MARGIN)+2*a.CELL_VERTICAL_MARGIN+a.BOTTOM_MARGIN+this.getXAxisHeight(),this.size_.width=Number(this.matrixWidth)*(a.CELL_WIDTH+a.CELL_HORIZONTAL_MARGIN)+this.getYAxisWidth()):this.size_.width=0},a.prototype.getValue=function(){var t=function(t){var e=(t=t.trim()).charAt(0);if(e===t.charAt(t.length-1)&&-1!==i.indexOf(e))return t.substr(1,t.length-2).trim();return t}(this.getText());return"`\n"+a.TAB+t+"\n"+a.TAB+"`"},a.prototype.restoreStateFromString=function(){var t,e,i=this.getText();if(i)for(var o=i.split("\n").filter(function(t){return rowRegex.test(t)}),r=0;r<o.length&&r<this.matrixHeight;r++)for(var n=0,l=o[r],a=0;a<l.length&&n<this.matrixWidth;a++)"."===(e=l[a])||"_"===e||"0"===e?(this.cellState[n][r]=!1,n++):("#"===(t=l[a])||"*"===t||"1"===t)&&(this.cellState[n][r]=!0,n++)},a.prototype.updateValue=function(){for(var t="",e=0;e<this.matrixHeight;e++){for(var i=0;i<this.matrixWidth;i++)t+=(this.cellState[i][e]?"#":".")+" ";t+="\n"+a.TAB}this.setValue(t,!1)},a.prototype.getYAxisWidth=function(){return this.yAxisLabel===LabelMode.None?0:a.Y_AXIS_WIDTH},a.prototype.getXAxisHeight=function(){return this.xAxisLabel===LabelMode.None?0:a.X_AXIS_HEIGHT},a.CELL_WIDTH=25,a.CELL_HORIZONTAL_MARGIN=7,a.CELL_VERTICAL_MARGIN=5,a.CELL_CORNER_RADIUS=5,a.BOTTOM_MARGIN=9,a.Y_AXIS_WIDTH=9,a.X_AXIS_HEIGHT=10,a.TAB="        ",a.DEFAULT_OFF_COLOR="#000000",a}(Blockly.Field);t.FieldMatrix=e;var i=["'",'"',"`"]}(pxtblockly||(pxtblockly={})),function(n){var l=pxt.svgUtil;n.HEADER_HEIGHT=50,n.TOTAL_WIDTH=300;var t=function(r){function a(t,e,i){var o=r.call(this,t,i)||this;return o.isFieldCustom_=!0,o.SERIALIZABLE=!0,o.soundingKeys=0,o.numRow=8,o.numCol=8,o.tempo=120,o.isPlaying=!1,o.timeouts=[],o.params=e,o.createMelodyIfDoesntExist(),o}return __extends(a,r),a.prototype.init=function(){r.prototype.init.call(this),this.onInit()},a.prototype.showEditor_=function(){var t=this;Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent(),Blockly.DropDownDiv.setColour(this.getDropdownBackgroundColour(),this.getDropdownBorderColour());var e=Blockly.DropDownDiv.getContentDiv();pxt.BrowserUtils.addClass(e,"melody-content-div"),pxt.BrowserUtils.addClass(e.parentElement,"melody-editor-dropdown"),this.gallery=new pxtmelody.MelodyGallery,this.renderEditor(e),this.prevString=this.getValue(),Blockly.Events.fire(new Blockly.Events.Ui(this.sourceBlock_,"melody-editor",!1,!0)),Blockly.DropDownDiv.showPositionedByBlock(this,this.sourceBlock_,function(){t.onEditorClose(),pxt.BrowserUtils.removeClass(e,"melody-content-div"),pxt.BrowserUtils.removeClass(e.parentElement,"melody-editor-dropdown"),Blockly.Events.fire(new Blockly.Events.Ui(t.sourceBlock_,"melody-editor",!0,!1))})},a.prototype.getValue=function(){return this.stringRep=this.getTypeScriptValue(),this.stringRep},a.prototype.doValueUpdate_=function(t){null==t||""==t||'""'==t||this.stringRep&&this.stringRep===t||(this.stringRep=t,this.parseTypeScriptValue(t),r.prototype.doValueUpdate_.call(this,this.getValue()))},a.prototype.onInit=function(){this.render_(),this.createMelodyIfDoesntExist(),this.invalidString?Blockly.FieldLabel.prototype.setText.call(this,pxt.Util.lf("Invalid Input")):(this.fieldGroup_||(this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null)),this.visible_||(this.fieldGroup_.style.display="none"),this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_),this.updateFieldLabel())},a.prototype.render_=function(){r.prototype.render_.call(this),this.invalidString||(this.size_.width=a.MUSIC_ICON_WIDTH+(a.COLOR_BLOCK_WIDTH+a.COLOR_BLOCK_SPACING)*this.numCol),this.sourceBlock_.setColour("#ffffff")},a.prototype.renderEditor=function(t){var e=this,i=this.getDropdownBackgroundColour(),o=this.getDropdownBorderColour();this.topDiv=document.createElement("div"),pxt.BrowserUtils.addClass(this.topDiv,"melody-top-bar-div"),this.root=new l.SVG(this.topDiv).id("melody-editor-header-controls"),this.toggle=new s(this.root,{leftText:lf("Editor"),rightText:lf("Gallery"),baseColor:i}),this.toggle.onStateChange(function(t){t?e.hideGallery():e.showGallery()}),this.toggle.layout(),this.toggle.translate((n.TOTAL_WIDTH-this.toggle.width())/2,0),t.appendChild(this.topDiv),t.appendChild(this.gallery.getElement()),this.editorDiv=document.createElement("div"),pxt.BrowserUtils.addClass(this.editorDiv,"melody-editor-div"),this.editorDiv.style.setProperty("background-color",o),this.gridDiv=this.createGridDisplay(),this.editorDiv.appendChild(this.gridDiv),this.bottomDiv=document.createElement("div"),pxt.BrowserUtils.addClass(this.bottomDiv,"melody-bottom-bar-div"),this.doneButton=document.createElement("button"),pxt.BrowserUtils.addClass(this.doneButton,"melody-confirm-button"),this.doneButton.innerText=lf("Done"),this.doneButton.addEventListener("click",function(){return e.onDone()}),this.doneButton.style.setProperty("background-color",i),this.playButton=document.createElement("button"),this.playButton.id="melody-play-button",this.playButton.addEventListener("click",function(){return e.togglePlay()}),this.playIcon=document.createElement("i"),this.playIcon.id="melody-play-icon",pxt.BrowserUtils.addClass(this.playIcon,"play icon"),this.playButton.appendChild(this.playIcon),this.tempoInput=document.createElement("input"),pxt.BrowserUtils.addClass(this.tempoInput,"ui input"),this.tempoInput.type="number",this.tempoInput.title=lf("tempo"),this.tempoInput.id="melody-tempo-input",this.tempoInput.addEventListener("input",function(){return e.setTempo(+e.tempoInput.value)}),this.syncTempoField(!0),this.bottomDiv.appendChild(this.tempoInput),this.bottomDiv.appendChild(this.playButton),this.bottomDiv.appendChild(this.doneButton),this.editorDiv.appendChild(this.bottomDiv),t.appendChild(this.editorDiv)},a.prototype.onEditorClose=function(){this.stopMelody(),this.gallery&&this.gallery.stopMelody(),this.clearDomReferences(),this.sourceBlock_&&Blockly.Events.isEnabled()&&this.getValue()!==this.prevString&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.sourceBlock_,"field",this.name,this.prevString,this.getValue())),this.prevString=void 0},a.prototype.onDone=function(){Blockly.DropDownDiv.hideIfOwner(this),this.onEditorClose()},a.prototype.clearDomReferences=function(){this.topDiv=null,this.editorDiv=null,this.gridDiv=null,this.bottomDiv=null,this.doneButton=null,this.playButton=null,this.playIcon=null,this.tempoInput=null,this.elt=null,this.cells=null,this.toggle=null,this.root=null,this.gallery.clearDomReferences()},a.prototype.getTypeScriptValue=function(){return this.invalidString?this.invalidString:this.melody?'"'+this.melody.getStringRepresentation()+'"':""},a.prototype.parseTypeScriptValue=function(t){var e=this,i=t;try{t=(t=t.slice(1,-1)).trim(),this.createMelodyIfDoesntExist();var o=t.split(" ");o.forEach(function(t){if(!e.isValidNote(t))throw new Error(lf("Invalid note '{0}'. Notes can be C D E F G A B C5",t))}),this.melody.resetMelody();for(var r=0;r<o.length;r++)if("-"!=o[r]){var n=pxtmelody.noteToRow(o[r]);this.melody.updateMelody(n,r)}this.updateFieldLabel()}catch(t){pxt.log(t),this.invalidString=i}},a.prototype.isValidNote=function(t){switch(t){case"C":case"D":case"E":case"F":case"G":case"A":case"B":case"C5":case"-":return!0}return!1},a.prototype.getPreviewWidth=function(){return this.updateSize_(),this.size_.width},a.prototype.getPreviewHeight=function(){return Blockly.BlockSvg.FIELD_HEIGHT},a.prototype.getDropdownBackgroundColour=function(){return this.sourceBlock_.parentBlock_.getColour()},a.prototype.getDropdownBorderColour=function(){return this.sourceBlock_.parentBlock_.getColourTertiary()},a.prototype.updateFieldLabel=function(){if(this.fieldGroup_){pxsim.U.clear(this.fieldGroup_);var t=c("").appendClass("melody-editor-field-icon").at(6,15);this.fieldGroup_.appendChild(t.el);for(var e=this.melody.getStringRepresentation().trim().split(" "),i=0;i<e.length;i++){var o=pxtmelody.getColorClass(pxtmelody.noteToRow(e[i])),r=(new l.Rect).at((a.COLOR_BLOCK_WIDTH+a.COLOR_BLOCK_SPACING)*i+a.COLOR_BLOCK_X,a.COLOR_BLOCK_Y).size(a.COLOR_BLOCK_WIDTH,a.COLOR_BLOCK_HEIGHT).stroke("#898989",1).corners(3,2);pxt.BrowserUtils.addClass(r.el,o),this.fieldGroup_.appendChild(r.el)}}},a.prototype.setTempo=function(t){(isNaN(t)||t<=0)&&this.tempoInput?this.tempoInput.value=this.tempo+"":this.tempo!=t&&(this.tempo=t,this.melody&&this.melody.setTempo(this.tempo),this.tempoInput&&(this.tempoInput.value=this.tempo+""),this.syncTempoField(!1))},a.prototype.syncTempoField=function(t){var e=this.sourceBlock_;if(e.parentBlock_)for(var i=0,o=e.parentBlock_.inputList;i<o.length;i++){var r=o[i];if("tempo"===r.name){var n=r.connection.targetBlock();n&&(t?n.getFieldValue("SLIDER")?(this.tempoInput.value=n.getFieldValue("SLIDER"),this.tempo=+this.tempoInput.value):this.tempoInput.value=this.tempo+"":"math_number_minmax"===n.type?n.setFieldValue(this.tempoInput.value,"SLIDER"):n.setFieldValue(this.tempoInput.value,"NUM"));break}}},a.prototype.getDuration=function(){return 6e4/this.tempo},a.prototype.createMelodyIfDoesntExist=function(){return!this.melody&&(this.melody=new pxtmelody.MelodyArray,!0)},a.prototype.onNoteSelect=function(t,e){this.invalidString=null,this.melody.updateMelody(t,e),this.melody.getValue(t,e)&&!this.isPlaying&&this.playNote(t,e),this.updateGrid(),this.updateFieldLabel()},a.prototype.updateGrid=function(){for(var t=0;t<this.numRow;t++)for(var e=pxtmelody.getColorClass(t),i=0;i<this.numCol;i++){var o=this.cells[t][i];this.melody.getValue(t,i)?(pxt.BrowserUtils.removeClass(o,"melody-default"),pxt.BrowserUtils.addClass(o,e)):(pxt.BrowserUtils.addClass(o,"melody-default"),pxt.BrowserUtils.removeClass(o,e))}},a.prototype.playNote=function(t,e){var i=this,o=++this.soundingKeys;this.isPlaying?(this.timeouts.push(setTimeout(function(){i.playToneCore(t)},e*this.getDuration())),this.timeouts.push(setTimeout(function(){pxt.AudioContextManager.stop()},(e+1)*this.getDuration()))):(this.playToneCore(t),this.timeouts.push(setTimeout(function(){i.soundingKeys==o&&pxt.AudioContextManager.stop()},this.getDuration())))},a.prototype.queueToneForColumn=function(e,t,i){var o=this,r=setTimeout(function(){++o.soundingKeys,pxt.AudioContextManager.stop();for(var t=0;t<o.numRow;t++)o.melody.getValue(t,e)&&o.playToneCore(t);o.highlightColumn(e,!0),o.timeouts=o.timeouts.filter(function(t){return t!==r})},t),n=setTimeout(function(){o.timeouts=o.timeouts.filter(function(t){return t!==n}),o.highlightColumn(e,!1)},t+i);this.timeouts.push(r),this.timeouts.push(n)},a.prototype.playToneCore=function(t){var e=0;switch(t){case 0:e=523;break;case 1:e=494;break;case 2:e=440;break;case 3:e=392;break;case 4:e=349;break;case 5:e=330;break;case 6:e=294;break;case 7:e=262}pxt.AudioContextManager.tone(e)},a.prototype.highlightColumn=function(e,i){this.cells.map(function(t){return t[e]}).forEach(function(t){i?pxt.BrowserUtils.addClass(t,"playing"):pxt.BrowserUtils.removeClass(t,"playing")})},a.prototype.createGridDisplay=function(){a.VIEWBOX_WIDTH=(a.CELL_WIDTH+a.CELL_VERTICAL_MARGIN)*this.numCol+a.CELL_VERTICAL_MARGIN,pxt.BrowserUtils.isEdge()&&(a.VIEWBOX_WIDTH+=37),a.VIEWBOX_HEIGHT=(a.CELL_WIDTH+a.CELL_HORIZONTAL_MARGIN)*this.numRow+a.CELL_HORIZONTAL_MARGIN,this.elt=pxsim.svg.parseString('<svg xmlns="http://www.w3.org/2000/svg" class="melody-grid-div" viewBox="0 0 '+a.VIEWBOX_WIDTH+" "+a.VIEWBOX_HEIGHT+'"/>'),this.cells=[];for(var t=0;t<this.numRow;t++)this.cells.push([]);for(t=0;t<this.numRow;t++)for(var e=0;e<this.numCol;e++)this.createCell(t,e);return this.elt},a.prototype.createCell=function(e,i){var o=this,t=e*(a.CELL_WIDTH+a.CELL_HORIZONTAL_MARGIN)+a.CELL_HORIZONTAL_MARGIN,r=i*(a.CELL_WIDTH+a.CELL_VERTICAL_MARGIN)+a.CELL_VERTICAL_MARGIN,n=pxsim.svg.child(this.elt,"g",{transform:"translate("+r+" "+t+")"}),l=pxsim.svg.child(n,"rect",{cursor:"pointer",width:a.CELL_WIDTH,height:a.CELL_WIDTH,stroke:"white","data-x":e,"data-y":i,rx:a.CELL_CORNER_RADIUS});this.melody.getValue(e,i)?pxt.BrowserUtils.addClass(l,pxtmelody.getColorClass(e)):pxt.BrowserUtils.addClass(l,"melody-default"),this.sourceBlock_.workspace.isFlyout||(pxsim.pointerEvents.down.forEach(function(t){return l.addEventListener(t,function(t){o.onNoteSelect(e,i),t.stopPropagation(),t.preventDefault()},!1)}),this.cells[e][i]=l)},a.prototype.togglePlay=function(){this.isPlaying?this.stopMelody():(this.isPlaying=!0,this.playMelody()),this.updatePlayButton()},a.prototype.updatePlayButton=function(){this.isPlaying?(pxt.BrowserUtils.removeClass(this.playIcon,"play icon"),pxt.BrowserUtils.addClass(this.playIcon,"stop icon")):(pxt.BrowserUtils.removeClass(this.playIcon,"stop icon"),pxt.BrowserUtils.addClass(this.playIcon,"play icon"))},a.prototype.playMelody=function(){var t=this;if(this.isPlaying){for(var e=0;e<this.numCol;e++)this.queueToneForColumn(e,e*this.getDuration(),this.getDuration());this.timeouts.push(setTimeout(function(){return t.playMelody()},this.numCol*this.getDuration()))}else this.stopMelody()},a.prototype.stopMelody=function(){if(this.isPlaying){for(;this.timeouts.length;)clearTimeout(this.timeouts.shift());pxt.AudioContextManager.stop(),this.isPlaying=!1,this.cells.forEach(function(t){return t.forEach(function(t){return pxt.BrowserUtils.removeClass(t,"playing")})})}},a.prototype.showGallery=function(){var e=this;this.stopMelody(),this.updatePlayButton(),this.gallery.show(function(t){t&&(e.melody.parseNotes(t),e.gallery.hide(),e.toggle.toggle(),e.updateFieldLabel(),e.updateGrid())})},a.prototype.hideGallery=function(){this.gallery.hide()},a.CELL_WIDTH=25,a.CELL_HORIZONTAL_MARGIN=7,a.CELL_VERTICAL_MARGIN=5,a.CELL_CORNER_RADIUS=5,a.COLOR_BLOCK_WIDTH=10,a.COLOR_BLOCK_HEIGHT=20,a.COLOR_BLOCK_X=20,a.COLOR_BLOCK_Y=5,a.COLOR_BLOCK_SPACING=2,a.MUSIC_ICON_WIDTH=20,a}(Blockly.Field);n.FieldCustomMelody=t;var s=function(){function t(t,e){this.props=function(t){t.baseColor||(t.baseColor="#e95153");t.backgroundColor||(t.backgroundColor="rgba(52,73,94,.2)");t.borderColor||(t.borderColor="rgba(52,73,94,.4)");t.selectedTextColor||(t.selectedTextColor=t.baseColor);t.unselectedTextColor||(t.unselectedTextColor="hsla(0,0%,100%,.9)");t.switchColor||(t.switchColor="#ffffff");return t}(e),this.root=t.group(),this.buildDom(),this.isLeft=!0}return t.prototype.buildDom=function(){var t=this;this.root.style().content("\n            .toggle-left {\n                transform: translateX(0px);\n                animation: mvleft 0.2s 0s ease;\n            }\n\n            .toggle-right {\n                transform: translateX(100px);\n                animation: mvright 0.2s 0s ease;\n            }\n\n            @keyframes mvright {\n                0% {\n                    transform: translateX(0px);\n                }\n                100% {\n                    transform: translateX(100px);\n                }\n            }\n\n            @keyframes mvleft {\n                0% {\n                    transform: translateX(100px);\n                }\n                100% {\n                    transform: translateX(0px);\n                }\n            }\n            "),this.root.def().create("clipPath","sprite-editor-toggle-border").clipPathUnits(!0).draw("rect").at(0,0).corners(.02,.1).size(1,1),this.root.draw("rect").size(200,40).fill(this.props.baseColor).stroke(this.props.borderColor,4).corners(4,4).clipPath("url(#sprite-editor-toggle-border)"),this.root.draw("rect").at(2,2).size(196,36).fill(this.props.backgroundColor).corners(4,4),this.switch=this.root.draw("rect").at(2,2).size(98,36).fill(this.props.switchColor).corners(4,4),this.leftElement=this.root.group(),this.leftText=c(this.props.leftText).appendClass("sprite-editor-text").fill(this.props.selectedTextColor),this.leftElement.appendChild(this.leftText),this.rightElement=this.root.group(),this.rightText=c(this.props.rightText).appendClass("sprite-editor-text").fill(this.props.unselectedTextColor),this.rightElement.appendChild(this.rightText),this.root.onClick(function(){return t.toggle()})},t.prototype.toggle=function(t){void 0===t&&(t=!1),this.isLeft?(this.switch.removeClass("toggle-left"),this.switch.appendClass("toggle-right"),this.leftText.fill(this.props.unselectedTextColor),this.rightText.fill(this.props.selectedTextColor)):(this.switch.removeClass("toggle-right"),this.switch.appendClass("toggle-left"),this.leftText.fill(this.props.selectedTextColor),this.rightText.fill(this.props.unselectedTextColor)),this.isLeft=!this.isLeft,!t&&this.changeHandler&&this.changeHandler(this.isLeft)},t.prototype.onStateChange=function(t){this.changeHandler=t},t.prototype.layout=function(){this.leftText.moveTo(51,20),this.rightText.moveTo(149,20)},t.prototype.translate=function(t,e){this.root.translate(t,e)},t.prototype.height=function(){return 40},t.prototype.width=function(){return 200},t}();function c(t){return new l.Text(t).anchor("middle").setAttribute("dominant-baseline","middle").setAttribute("dy",pxt.BrowserUtils.isIE()||pxt.BrowserUtils.isEdge()?"0.3em":"0.1em")}}(pxtblockly||(pxtblockly={})),function(s){var n,t;(t=n||(n={}))[t.C=262]="C",t[t.CSharp=277]="CSharp",t[t.D=294]="D",t[t.Eb=311]="Eb",t[t.E=330]="E",t[t.F=349]="F",t[t.FSharp=370]="FSharp",t[t.G=392]="G",t[t.GSharp=415]="GSharp",t[t.A=440]="A",t[t.Bb=466]="Bb",t[t.B=494]="B",t[t.C3=131]="C3",t[t.CSharp3=139]="CSharp3",t[t.D3=147]="D3",t[t.Eb3=156]="Eb3",t[t.E3=165]="E3",t[t.F3=175]="F3",t[t.FSharp3=185]="FSharp3",t[t.G3=196]="G3",t[t.GSharp3=208]="GSharp3",t[t.A3=220]="A3",t[t.Bb3=233]="Bb3",t[t.B3=247]="B3",t[t.C4=262]="C4",t[t.CSharp4=277]="CSharp4",t[t.D4=294]="D4",t[t.Eb4=311]="Eb4",t[t.E4=330]="E4",t[t.F4=349]="F4",t[t.FSharp4=370]="FSharp4",t[t.G4=392]="G4",t[t.GSharp4=415]="GSharp4",t[t.A4=440]="A4",t[t.Bb4=466]="Bb4",t[t.B4=494]="B4",t[t.C5=523]="C5",t[t.CSharp5=555]="CSharp5",t[t.D5=587]="D5",t[t.Eb5=622]="Eb5",t[t.E5=659]="E5",t[t.F5=698]="F5",t[t.FSharp5=740]="FSharp5",t[t.G5=784]="G5",t[t.GSharp5=831]="GSharp5",t[t.A5=880]="A5",t[t.Bb5=932]="Bb5",t[t.B5=988]="B5",t[t.C6=1047]="C6",t[t.CSharp6=1109]="CSharp6",t[t.D6=1175]="D6",t[t.Eb6=1245]="Eb6",t[t.E6=1319]="E6",t[t.F6=1397]="F6",t[t.FSharp6=1480]="FSharp6",t[t.G6=1568]="G6",t[t.GSharp6=1568]="GSharp6",t[t.A6=1760]="A6",t[t.Bb6=1865]="Bb6",t[t.B6=1976]="B6",t[t.C7=2093]="C7";var e=function(a){function m(t,e,i){var o=a.call(this,null,0,null,null,i)||this;o.isFieldCustom_=!0,o.SERIALIZABLE=!0,o.isTextValid_=!0,o.nKeys_=36,o.minNote_=28,o.maxNote_=63,o.eps=2,o.setSpellcheck(!1),o.prepareNotes(),o.isExpanded=!1,o.currentPage=0,o.totalPlayCount=0,e.editorColour&&(o.primaryColour=s.parseColour(e.editorColour),o.borderColour=Blockly.utils.colour.darken(o.primaryColour,.2));var r=parseInt(e.eps);!Number.isNaN(r)&&0<=r&&(o.eps=r);var n=parseInt(e.minNote)||o.minNote_,l=parseInt(e.maxNote)||o.maxNote_;return 28<=n&&l<=75&&n<l&&(o.minNote_=n,o.maxNote_=l,o.nKeys_=o.maxNote_-o.minNote_+1),o.setValue(t),o}return __extends(m,a),m.prototype.doClassValidation_=function(t){var e=/^Note\.(.+)$/.exec(t),i=e&&1<e.length?e[1]:null;if(null===(t=n[i]?n[i]:String(parseFloat(t||"0"))))return null;var o=parseFloat(t||"0");if(isNaN(o)||o<0)return null;var r=Math.floor(o)!=o;return""+o.toFixed(r?2:0)},m.prototype.getValue=function(){return this.value_+""},m.prototype.doValueUpdate_=function(t){isNaN(Number(t))||Number(t)<0||(this.sourceBlock_&&Blockly.Events.isEnabled()&&this.value_!=t&&Blockly.Events.fire(new Blockly.Events.Change(this.sourceBlock_,"field",this.name,this.value_,t)),this.value_=t,this.refreshText())},m.prototype.getText=function(){if(this.isExpanded)return""+this.value_;for(var t=+this.value_,e=0;e<this.nKeys_;e++)if(Math.abs(this.getKeyFreq(e)-t)<this.eps)return this.getKeyName(e);var i=t.toString();return isNaN(t)||(i+=" Hz"),i},m.prototype.refreshText=function(){this.setText(this.getText()),this.forceRerender()},m.prototype.onHtmlInputChange_=function(t){a.prototype.onHtmlInputChange_.call(this,t),Blockly.DropDownDiv.hideWithoutAnimation()},m.prototype.onFinishEditing_=function(t){this.refreshText()},m.prototype.onHide=function(){this.isExpanded=!1,this.refreshText()},m.prototype.showEditor_=function(t){var e=this;this.isExpanded=!0,this.updateColor(),Blockly.DropDownDiv.hideWithoutAnimation(),Blockly.DropDownDiv.clearContent();var i=pxt.BrowserUtils.isMobile()||pxt.BrowserUtils.isIOS();m.superClass_.showEditor_.call(this,t,i,i),this.refreshText(),Blockly.Events.setGroup(!0),this.piano=[],this.currentSelectedKey=void 0;var o=this.nKeys_-this.nKeys_/m.notesPerOctave*m.blackKeysPerOctave,r=m.notesPerOctave-m.blackKeysPerOctave,n=m.keyWidth*o,l=m.keyHeight+m.labelHeight,a=window.innerWidth<n;a&&(n=r*m.keyWidth,l=m.keyHeight+m.labelHeight+m.prevNextHeight);var s=f("blocklyPianoDiv","width: "+n+"px;\n                height: "+l+"px;");Blockly.DropDownDiv.getContentDiv().appendChild(s),this.noteLabel=f("blocklyNoteLabel","top: "+m.keyHeight+"px;\n                width: "+n+"px;\n                background-color: "+this.primaryColour+";\n                border-color: "+this.primaryColour+";"),s.appendChild(this.noteLabel),this.noteLabel.textContent="-";for(var c=0,u=0;u<this.nKeys_;u++){var p=Math.floor(u/m.notesPerOctave),d=this.getPosition(u);a&&m.notesPerOctave<=u&&(d-=r*p*m.keyWidth);var h=this.getKeyDiv(u,d);this.piano.push(h),s.appendChild(h),Math.abs(this.getKeyFreq(u)-Number(this.getValue()))<this.eps&&(pxt.BrowserUtils.addClass(h,"selected"),this.currentSelectedKey=h,c=p)}a&&(this.setPage(c),s.appendChild(this.getNextPrevDiv(!0,n)),s.appendChild(this.getNextPrevDiv(!1,n))),Blockly.DropDownDiv.setColour(this.primaryColour,this.borderColour),Blockly.DropDownDiv.showPositionedByBlock(this,this.sourceBlock_,function(){return e.onHide()})},m.prototype.playKey=function(t,e){var i=this,o=++this.totalPlayCount;this.currentSelectedKey!==t&&(this.currentSelectedKey&&pxt.BrowserUtils.removeClass(this.currentSelectedKey,"selected"),pxt.BrowserUtils.addClass(t,"selected"),this.setValue(e)),this.currentSelectedKey=t,this.htmlInput_.value=this.getText(),pxt.AudioContextManager.tone(e),setTimeout(function(){i.totalPlayCount==o&&pxt.AudioContextManager.stop()},300)},m.prototype.dispose=function(){Blockly.DropDownDiv.hideIfOwner(this),a.prototype.dispose.call(this)},m.prototype.updateColor=function(){var t;this.sourceBlock_.parentBlock_&&(this.sourceBlock_.isShadow()||1===(t=this.sourceBlock_).inputList.length&&1===t.inputList[0].fieldRow.length)?(this.primaryColour=this.sourceBlock_.parentBlock_.getColour(),this.borderColour=this.sourceBlock_.parentBlock_.getColourTertiary()):(this.primaryColour=this.sourceBlock_.getColourTertiary(),this.borderColour=this.sourceBlock_.getColourTertiary())},m.prototype.setPage=function(t){var e=this.nKeys_/m.notesPerOctave;t=Math.max(Math.min(t,e-1),0),this.noteLabel.textContent="Octave #"+(t+1);for(var i=t*m.notesPerOctave,o=0;o<this.piano.length;++o){var r=i<=o&&o<i+m.notesPerOctave;this.piano[o].style.display=r?"block":"none"}this.currentPage=t},m.prototype.getNextPrevDiv=function(e,t){var i=this,o=f("blocklyNotePrevNext","top: "+(m.keyHeight+m.labelHeight)+"px;\n                left: "+(e?0:t/2)+"px;\n                width: "+Math.ceil(t/2)+"px;\n                "+(e?"border-left-color":"border-right-color")+": "+this.primaryColour+";\n                background-color: "+this.primaryColour+";\n                border-bottom-color: "+this.primaryColour+";");return pxt.BrowserUtils.pointerEvents.down.forEach(function(t){Blockly.bindEventWithChecks_(o,t,i,function(){return i.setPage(e?i.currentPage-1:i.currentPage+1)},!0)}),o.textContent=e?"<":">",o},m.prototype.getKeyDiv=function(e,t){var i=this,o=f("blocklyNote "+(this.isWhite(e)?"":"black"),"width: "+this.getKeyWidth(e)+"px;\n                height: "+this.getKeyHeight(e)+"px;\n                left: "+t+"px;\n                border-color: "+this.primaryColour+";");return pxt.BrowserUtils.pointerEvents.down.forEach(function(t){Blockly.bindEventWithChecks_(o,t,i,function(){return i.playKey(o,i.getKeyFreq(e))},!0)}),Blockly.bindEventWithChecks_(o,"mouseover",this,function(){return i.noteLabel.textContent=i.getKeyName(e)},!0),o},m.prototype.isWhite=function(t){switch(t%12){case 1:case 3:case 6:case 8:case 10:return!1;default:return!0}},m.prototype.getKeyWidth=function(t){return this.isWhite(t)?m.keyWidth:m.keyWidth/2},m.prototype.getKeyHeight=function(t){return this.isWhite(t)?m.keyHeight:m.keyHeight/2},m.prototype.getKeyFreq=function(t){return this.getKeyNoteData(t).freq},m.prototype.getKeyName=function(t){var e=this.getKeyNoteData(t),i=e.prefixedName;return this.nKeys_<=m.notesPerOctave?i=e.name:28<=this.minNote_&&this.maxNote_<=63&&(i=e.altPrefixedName||i),i},m.prototype.getKeyNoteData=function(t){return m.Notes[t+this.minNote_]},m.prototype.getPosition=function(t){var e=(t-Math.floor((t+1)/m.notesPerOctave*m.blackKeysPerOctave))*m.keyWidth;return this.isWhite(t)?e:e-m.keyWidth/4},m.prototype.prepareNotes=function(){m.Notes||(m.Notes={28:{name:lf("C"),prefixedName:lf("Low C"),freq:131},29:{name:lf("C#"),prefixedName:lf("Low C#"),freq:139},30:{name:lf("D"),prefixedName:lf("Low D"),freq:147},31:{name:lf("D#"),prefixedName:lf("Low D#"),freq:156},32:{name:lf("E"),prefixedName:lf("Low E"),freq:165},33:{name:lf("F"),prefixedName:lf("Low F"),freq:175},34:{name:lf("F#"),prefixedName:lf("Low F#"),freq:185},35:{name:lf("G"),prefixedName:lf("Low G"),freq:196},36:{name:lf("G#"),prefixedName:lf("Low G#"),freq:208},37:{name:lf("A"),prefixedName:lf("Low A"),freq:220},38:{name:lf("A#"),prefixedName:lf("Low A#"),freq:233},39:{name:lf("B"),prefixedName:lf("Low B"),freq:247},40:{name:lf("C"),prefixedName:lf("Middle C"),freq:262},41:{name:lf("C#"),prefixedName:lf("Middle C#"),freq:277},42:{name:lf("D"),prefixedName:lf("Middle D"),freq:294},43:{name:lf("D#"),prefixedName:lf("Middle D#"),freq:311},44:{name:lf("E"),prefixedName:lf("Middle E"),freq:330},45:{name:lf("F"),prefixedName:lf("Middle F"),freq:349},46:{name:lf("F#"),prefixedName:lf("Middle F#"),freq:370},47:{name:lf("G"),prefixedName:lf("Middle G"),freq:392},48:{name:lf("G#"),prefixedName:lf("Middle G#"),freq:415},49:{name:lf("A"),prefixedName:lf("Middle A"),freq:440},50:{name:lf("A#"),prefixedName:lf("Middle A#"),freq:466},51:{name:lf("B"),prefixedName:lf("Middle B"),freq:494},52:{name:lf("C"),prefixedName:lf("Tenor C"),altPrefixedName:lf("High C"),freq:523},53:{name:lf("C#"),prefixedName:lf("Tenor C#"),altPrefixedName:lf("High C#"),freq:554},54:{name:lf("D"),prefixedName:lf("Tenor D"),altPrefixedName:lf("High D"),freq:587},55:{name:lf("D#"),prefixedName:lf("Tenor D#"),altPrefixedName:lf("High D#"),freq:622},56:{name:lf("E"),prefixedName:lf("Tenor E"),altPrefixedName:lf("High E"),freq:659},57:{name:lf("F"),prefixedName:lf("Tenor F"),altPrefixedName:lf("High F"),freq:698},58:{name:lf("F#"),prefixedName:lf("Tenor F#"),altPrefixedName:lf("High F#"),freq:740},59:{name:lf("G"),prefixedName:lf("Tenor G"),altPrefixedName:lf("High G"),freq:784},60:{name:lf("G#"),prefixedName:lf("Tenor G#"),altPrefixedName:lf("High G#"),freq:831},61:{name:lf("A"),prefixedName:lf("Tenor A"),altPrefixedName:lf("High A"),freq:880},62:{name:lf("A#"),prefixedName:lf("Tenor A#"),altPrefixedName:lf("High A#"),freq:932},63:{name:lf("B"),prefixedName:lf("Tenor B"),altPrefixedName:lf("High B"),freq:988},64:{name:lf("C"),prefixedName:lf("High C"),freq:1046},65:{name:lf("C#"),prefixedName:lf("High C#"),freq:1109},66:{name:lf("D"),prefixedName:lf("High D"),freq:1175},67:{name:lf("D#"),prefixedName:lf("High D#"),freq:1245},68:{name:lf("E"),prefixedName:lf("High E"),freq:1319},69:{name:lf("F"),prefixedName:lf("High F"),freq:1397},70:{name:lf("F#"),prefixedName:lf("High F#"),freq:1478},71:{name:lf("G"),prefixedName:lf("High G"),freq:1568},72:{name:lf("G#"),prefixedName:lf("High G#"),freq:1661},73:{name:lf("A"),prefixedName:lf("High A"),freq:1760},74:{name:lf("A#"),prefixedName:lf("High A#"),freq:1865},75:{name:lf("B"),prefixedName:lf("High B"),freq:1976}})},m.keyWidth=22,m.keyHeight=90,m.labelHeight=24,m.prevNextHeight=20,m.notesPerOctave=12,m.blackKeysPerOctave=5,m}(Blockly.FieldNumber);function f(t,e){var i=document.createElement("div");return pxt.BrowserUtils.addClass(i,t),i.setAttribute("style",e.replace(/\s+/g," ")),i}s.FieldNote=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,e.data,e.min,e.max,e.precision,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t.prototype.getOptions=function(){var t;return this.menuGenerator_&&(t=JSON.parse(this.menuGenerator_).map(function(t){return"object"==typeof t?t:[String(t),String(t)]})),t},t}(Blockly.FieldNumberDropdown);t.FieldNumberDropdown=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,"0","100","1","100","Value",i)||this;return o.isFieldCustom_=!0,o.params=e,o.params.screenHeight||(o.params.screenHeight=120),o.params.screenWidth||(o.params.screenWidth=160),o.params.xInputName||(o.params.xInputName="x"),o.params.yInputName||(o.params.yInputName="y"),o.params.min&&(o.min_=parseInt(o.params.min)),o.params.max&&(o.max_=parseInt(o.params.max)),o}return __extends(t,r),t.prototype.showEditor_=function(){this.getFieldByName(this.params.xInputName)===this&&(this.max_=this.params.screenWidth,this.labelText_=this.params.xInputName),this.getFieldByName(this.params.yInputName)===this&&(this.max_=this.params.screenHeight,this.labelText_=this.params.yInputName),r.prototype.showEditor_.call(this),this.renderScreenPicker()},t.prototype.setValue=function(t){r.prototype.setValue.call(this,t),this.resetCrosshair&&this.resetCrosshair()},t.prototype.renderScreenPicker=function(){var l=this,t=Blockly.DropDownDiv.getContentDiv();this.selectorDiv_=document.createElement("div"),this.selectorDiv_.className="blocklyCanvasOverlayOuter",t.appendChild(this.selectorDiv_);var a=document.createElement("div");a.className="blocklyCanvasOverlayDiv",this.selectorDiv_.appendChild(a);var o=document.createElement("div");o.className="cross-x",a.appendChild(o);var r=document.createElement("div");r.className="cross-y",a.appendChild(r);var n=document.createElement("div");n.className="label",a.appendChild(n);var s=1.5*this.params.screenWidth,c=1.5*this.params.screenHeight;a.style.height=c+"px",a.style.width=s+"px";var e=t.getElementsByClassName("goog-slider-horizontal")[0];if(e){e.style.width=s+"px";var i=parseFloat(this.getValue());!isNaN(i)&&i>this.getMin()&&(this.setValue(i-1+""),this.setValue(i+""))}var u=function(t,e){t=Math.round(Math.max(0,Math.min(s,t))),e=Math.round(Math.max(0,Math.min(c,e))),o.style.top=e+"px",r.style.left=t+"px",t=Math.round(Math.max(0,Math.min(l.params.screenWidth,t/s*l.params.screenWidth))),e=Math.round(Math.max(0,Math.min(l.params.screenHeight,e/c*l.params.screenHeight))),n.textContent=l.params.xInputName+"="+t+" "+l.params.yInputName+"="+e;var i=n.getBoundingClientRect();t>l.params.screenWidth/2?n.style.left=t*(s/l.params.screenWidth)-i.width-8+"px":n.style.left=t*(s/l.params.screenWidth)+4+"px",e>l.params.screenHeight/2?n.style.top=e*(c/l.params.screenHeight)-i.height-6+"px":n.style.top=e*(c/l.params.screenHeight)+"px"};this.resetCrosshair=function(){var t=l.getXY(),e=t.currentX,i=t.currentY;u(e/l.params.screenWidth*s,i/l.params.screenHeight*c)},this.resetCrosshair(),Blockly.bindEvent_(this.selectorDiv_,"mousemove",this,function(t){var e=a.getBoundingClientRect(),i=t.clientX-e.left,o=t.clientY-e.top;u(i,o)}),Blockly.bindEvent_(this.selectorDiv_,"mouseleave",this,this.resetCrosshair),Blockly.bindEvent_(this.selectorDiv_,"click",this,function(t){var e=a.getBoundingClientRect(),i=t.clientX-e.left,o=t.clientY-e.top,r=Math.round(i/s*l.params.screenWidth),n=Math.round(o/c*l.params.screenHeight);l.close(),l.setXY(r,n)})},t.prototype.resizeHandler=function(){this.close()},t.prototype.setXY=function(t,e){var i=this.getFieldByName(this.params.xInputName);i&&(i.setValue(String(t)),i.setText(String(t)));var o=this.getFieldByName(this.params.yInputName);o&&(o.setValue(String(e)),o.setText(String(e)))},t.prototype.getFieldByName=function(t){var e=this.sourceBlock_.parentBlock_;if(e)for(var i=0;i<e.inputList.length;i++){var o=e.inputList[i];if(o.name===t)return this.getTargetField(o)}},t.prototype.getXY=function(){var t,e,i=this.getFieldByName(this.params.xInputName);i&&(t=i.getValue());var o=this.getFieldByName(this.params.yInputName);return o&&(e=o.getValue()),{currentX:parseInt(t),currentY:parseInt(e)}},t.prototype.getTargetField=function(t){var e=t.connection.targetBlock();if(!e)return null;var i=e.inputList[0];return i?i.fieldRow[0]:null},t.prototype.widgetDispose_=function(){Blockly.FieldNumber.superClass_.widgetDispose_.call(this),this.close(!0)},t.prototype.close=function(t){t||(Blockly.WidgetDiv.hideIfOwner(this),Blockly.DropDownDiv.hideIfOwner(this)),window.removeEventListener("resize",this.resizeHandler),this.resetCrosshair=void 0,this.selectorDiv_&&(goog.dom.removeNode(this.selectorDiv_),this.selectorDiv_=void 0)},t}(Blockly.FieldSlider);t.FieldPosition=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(o){function t(t,e){var i=o.call(this,null,e)||this;return i.setValue(t||""),i}return __extends(t,o),t.prototype.getOptions=function(){return this.dropdownCreate()},t.prototype.init=function(){this.fieldGroup_||o.prototype.init.call(this)},t.prototype.setSourceBlock=function(t){goog.asserts.assert(!t.isShadow(),"Procedure fields are not allowed to exist on shadow blocks."),o.prototype.setSourceBlock.call(this,t)},t.prototype.getValue=function(){return this.getText()},t.prototype.doValueUpdate_=function(t){this.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.Change(this.sourceBlock_,"field",this.name,this.value_,t)),this.value_=t,this.setText(t)},t.prototype.dropdownCreate=function(){var t=[];if(this.sourceBlock_&&this.sourceBlock_.workspace)for(var e=this.sourceBlock_.workspace.getAllBlocks(),i=0;i<e.length;i++)if(e[i].getProcedureDef){var o=e[i].getProcedureDef();t.push(o[0])}var r=this.getText();r&&-1==t.indexOf(r)&&t.push(r),t.sort(goog.string.caseInsensitiveCompare),t.length||t.push("Temp");var n=[];for(i=0;i<t.length;i++)n[i]=[t[i],t[i]];return n},t.prototype.onItemSelected=function(t,e){var i=e.getValue();this.sourceBlock_&&(i=this.callValidator(i)),null!==i&&this.setValue(i)},t}(Blockly.FieldDropdown);t.FieldProcedure=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,String(t),"0","180","1","15",lf("Angle"),i)||this;return o.isFieldCustom_=!0,o.params=e,o}return __extends(t,r),t.prototype.createLabelDom_=function(t){var e=document.createElement("div");this.circleSVG=document.createElementNS("http://www.w3.org/2000/svg","svg"),pxsim.svg.hydrate(this.circleSVG,{viewBox:"0 0 200 100",width:"170"}),e.appendChild(this.circleSVG);pxsim.svg.child(this.circleSVG,"circle",{"stroke-dasharray":"565.48","stroke-dashoffset":"0",cx:100,cy:100,r:"90",style:"fill:transparent; transition: stroke-dashoffset 0.1s linear;",stroke:"#a8aaa8","stroke-width":"1rem"});this.circleBar=pxsim.svg.child(this.circleSVG,"circle",{"stroke-dasharray":"565.48","stroke-dashoffset":"0",cx:100,cy:100,r:"90",style:"fill:transparent; transition: stroke-dashoffset 0.1s linear;",stroke:"#f12a21","stroke-width":"1rem"}),this.reporter=pxsim.svg.child(this.circleSVG,"text",{x:100,y:80,"text-anchor":"middle","dominant-baseline":"middle",style:"font-size: 50px",class:"sim-text inverted number"});var i=document.createElement("span");return i.setAttribute("class","blocklyFieldSliderReadout"),[e,i]},t.prototype.setReadout_=function(t,e){this.updateAngle(parseFloat(e)),this.reporter.textContent=e+"°"},t.prototype.updateAngle=function(t){var e=(180-(t=Math.max(0,Math.min(180,t))))/180*Math.PI*90;this.circleBar.setAttribute("stroke-dashoffset",""+e)},t}(Blockly.FieldSlider);t.FieldProtractor=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,String(t),"-100","100","1","10","Speed",i)||this;return o.isFieldCustom_=!0,o.params=e,o.params.min&&(o.min_=parseFloat(o.params.min)),o.params.max&&(o.max_=parseFloat(o.params.max)),o.params.label&&(o.labelText_=o.params.label),o.params.format||(o.params.format="{0}%"),o}return __extends(t,r),t.prototype.createLabelDom_=function(t){var e=document.createElement("div");this.speedSVG=document.createElementNS("http://www.w3.org/2000/svg","svg"),pxsim.svg.hydrate(this.speedSVG,{viewBox:"0 0 200 100",width:"170"}),e.appendChild(this.speedSVG);pxsim.svg.child(this.speedSVG,"circle",{"stroke-dasharray":"565.48","stroke-dashoffset":"0",cx:100,cy:100,r:"90",style:"fill:transparent; transition: stroke-dashoffset 0.1s linear;",stroke:"#a8aaa8","stroke-width":"1rem"});this.circleBar=pxsim.svg.child(this.speedSVG,"circle",{"stroke-dasharray":"565.48","stroke-dashoffset":"0",cx:100,cy:100,r:"90",style:"fill:transparent; transition: stroke-dashoffset 0.1s linear;",stroke:"#f12a21","stroke-width":"1rem"}),this.reporter=pxsim.svg.child(this.speedSVG,"text",{x:100,y:80,"text-anchor":"middle","dominant-baseline":"middle",style:"font-size: "+Math.max(14,50-5*(this.params.format.length-4))+"px",class:"sim-text inverted number"});var i=document.createElement("span");return i.setAttribute("class","blocklyFieldSliderReadout"),[e,i]},t.prototype.setReadout_=function(t,e){this.updateSpeed(parseFloat(e)),this.reporter.textContent=ts.pxtc.U.rlf(this.params.format,e)},t.prototype.updateSpeed=function(t){var e=this.sign(t);t=Math.abs(t)/100*50+50,-1==e&&(t=50-t);var i=(100-t)/100*(180*Math.PI);this.circleBar.setAttribute("stroke-dashoffset",""+i)},t.prototype.sign=function(t){return t?t<0?-1:1:0},t}(Blockly.FieldSlider);t.FieldSpeed=e}(pxtblockly||(pxtblockly={})),function(o){var n=pxt.svgUtil,t=function(r){function t(t,e,i){var o=r.call(this,t,i)||this;return o.isFieldCustom_=!0,o.SERIALIZABLE=!0,o.lightMode=e.lightMode,o.params=function(t){var e={initColor:1,initWidth:16,initHeight:16};if(!t)return e;if(t.sizes){for(var i=t.sizes.split(";"),o=[],r=0;r<i.length;r++){var n=i[r].split(",");if(2===n.length){var l=parseInt(n[0]),a=parseInt(n[1]);if(!isNaN(l)&&!isNaN(a)){var s=pxt.appTarget.runtime&&pxt.appTarget.runtime.screenSize;l<0&&s&&(l=s.width),a<0&&s&&(a=s.height),o.push([l,a])}}}0<o.length&&(e.initWidth=o[0][0],e.initHeight=o[0][1])}t.filter&&(e.filter=t.filter);return e.initColor=c(t.initColor,e.initColor),e.initWidth=c(t.initWidth,e.initWidth),e.initHeight=c(t.initHeight,e.initHeight),e;function c(t,e){var i=parseInt(t);return isNaN(i)?e:i}}(e),o.blocksInfo=e.blocksInfo,o.state||(o.state=new pxt.sprite.Bitmap(o.params.initWidth,o.params.initHeight)),o}return __extends(t,r),t.prototype.init=function(){this.fieldGroup_||(this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null),this.visible_||(this.fieldGroup_.style.display="none"),this.state||(this.state=new pxt.sprite.Bitmap(this.params.initWidth,this.params.initHeight)),this.redrawPreview(),this.updateEditable(),this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_),this.render_(),this.mouseDownWrapper_=Blockly.bindEventWithChecks_(this.getClickTarget_(),"mousedown",this,this.onMouseDown_))},t.prototype.showEditor_=function(){var i=this;this.params.blocksInfo=this.blocksInfo;var o=pxt.react.getFieldEditorView("image-editor",this.state,this.params);this.undoRedoState&&o.restorePersistentData(this.undoRedoState),o.onHide(function(){var t=o.getResult();if(t){var e=i.getValue();i.state=t,i.redrawPreview(),i.undoRedoState=o.getPersistentData(),i.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.BlockChange(i.sourceBlock_,"field",i.name,e,i.getValue()))}}),o.show()},t.prototype.render_=function(){r.prototype.render_.call(this),this.size_.height=50,this.size_.width=50},t.prototype.getValue=function(){return pxt.sprite.bitmapToImageLiteral(this.state,"typescript")},t.prototype.doValueUpdate_=function(t){null!=t&&(this.value_=t,this.parseBitmap(t),this.redrawPreview(),r.prototype.doValueUpdate_.call(this,t))},t.prototype.redrawPreview=function(){if(this.fieldGroup_){pxsim.U.clear(this.fieldGroup_);var t=(new n.Rect).at(5,5).size(40,40).fill("#dedede").stroke("#898989",1).corner(4);if(this.fieldGroup_.appendChild(t.el),this.state){var e=o.bitmapToImageURI(this.state,32,this.lightMode),i=(new n.Image).src(e).at(9,9).size(32,32);this.fieldGroup_.appendChild(i.el)}}},t.prototype.parseBitmap=function(t){var e=pxt.sprite.imageLiteralToBitmap(t);e&&e.width&&e.height&&(this.state=e)},t}(Blockly.Field);o.FieldSpriteEditor=t}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,function(t){if(t){if(t.bold&&t.italics)return"blocklyBoldItalicizedText";if(t.bold)return"blocklyBoldText";if(t.italics)return"blocklyItalicizedText"}return}(e))||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t}(Blockly.FieldLabel);t.FieldStyledLabel=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,e.values,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t}(Blockly.FieldTextDropdown);t.FieldTextDropdown=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t}(Blockly.FieldTextInput);t.FieldTextInput=e}(pxtblockly||(pxtblockly={})),function(h){var n=pxt.svgUtil,t=function(r){function t(t,e,i){var o=r.call(this,t,i)||this;return o.isFieldCustom_=!0,o.SERIALIZABLE=!0,o.lightMode=e.lightMode,o.params=function(t){var e={initWidth:16,initHeight:16};if(!t)return e;t.filter&&(e.filter=t.filter);return e.initWidth=i(t.initWidth,e.initWidth),e.initHeight=i(t.initHeight,e.initHeight),e;function i(t,e){var i=parseInt(t);return isNaN(i)?e:i}}(e),o.blocksInfo=e.blocksInfo,t&&!o.state&&o.doValueUpdate_(t),o.initState(),o}return __extends(t,r),t.prototype.init=function(){this.fieldGroup_||(this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null),this.visible_||(this.fieldGroup_.style.display="none"),this.initState(),this.redrawPreview(),this.updateEditable(),this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_),this.render_(),this.mouseDownWrapper_=Blockly.bindEventWithChecks_(this.getClickTarget_(),"mousedown",this,this.onMouseDown_))},t.prototype.showEditor_=function(){var n=this;if(!this.isGreyBlock){this.params.blocksInfo=this.blocksInfo,this.restoreTilesFromWorkspace(this.state);var l=pxt.react.getFieldEditorView("tilemap-editor",this.state,this.params);this.undoRedoState&&l.restorePersistentData(this.undoRedoState),l.onHide(function(){var t=l.getResult();if(t){var e=n.getValue();n.state=t,n.updateWorkspaceTiles(n.state.tileset);for(var i=0,o=n.state.tileset.tiles;i<o.length;i++){var r=o[i];r.projectId&&r.data&&delete r.data}n.redrawPreview(),n.undoRedoState=l.getPersistentData(),n.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.BlockChange(n.sourceBlock_,"field",n.name,e,n.getValue()))}}),l.show()}},t.prototype.render_=function(){r.prototype.render_.call(this),this.isGreyBlock||(this.size_.height=50,this.size_.width=50)},t.prototype.getValue=function(){return this.isGreyBlock?pxt.Util.htmlUnescape(this.text_):pxt.sprite.encodeTilemap(this.state,"typescript")},t.prototype.getTileset=function(){return this.state.tileset},t.prototype.doValueUpdate_=function(t){null!=t&&(this.value_=t,this.parseBitmap(t),this.redrawPreview(),r.prototype.doValueUpdate_.call(this,t))},t.prototype.redrawPreview=function(t){if(this.fieldGroup_){if(pxsim.U.clear(this.fieldGroup_),this.isGreyBlock)return this.createTextElement_(),void this.updateEditable();var e=(new n.Rect).at(5,5).size(40,40).fill("#dedede").stroke("#898989",1).corner(4);if(this.fieldGroup_.appendChild(e.el),this.state){this.restoreTilesFromWorkspace(this.state,t);var i=h.tilemapToImageURI(this.state,32,this.lightMode,this.blocksInfo),o=(new n.Image).src(i).at(9,9).size(32,32);this.fieldGroup_.appendChild(o.el)}}},t.prototype.parseBitmap=function(t){if(this.blocksInfo){var e=pxt.sprite.decodeTilemap(t,"typescript");!function(t,i){if(!(t&&t.tilemap&&t.tilemap.width&&t.tilemap.height))return!1;if(!t.layers||t.layers.width!==t.tilemap.width||t.layers.height!==t.tilemap.height)return!1;if(!t.tileset)return!1;for(var e=function(e){return e&&(0<=e.projectId||e.qualifiedName&&i.some(function(t){return t.qName===e.qualifiedName}))?"continue":{value:!1}},o=0,r=t.tileset.tiles;o<r.length;o++){var n=r[o],l=e(n);if("object"==typeof l)return l.value}return!0}(e,pxt.sprite.filterItems(pxt.sprite.getGalleryItems(this.blocksInfo,"Image"),this.params.filter.split(" ")))?t.trim()&&(this.isGreyBlock=!0,this.text_=t):(this.state=e,this.isGreyBlock=!1)}},t.prototype.initState=function(){this.state||(this.state=new pxt.sprite.TilemapData(new pxt.sprite.Tilemap(this.params.initWidth,this.params.initHeight),{tiles:[],tileWidth:16},new pxt.sprite.Bitmap(this.params.initWidth,this.params.initHeight).data()))},t.prototype.updateWorkspaceTiles=function(t){var l=this.sourceBlock_.workspace,e=h.getAllTilesetTiles(l),i=t.tiles,o=[];if(e.filter(function(t){return null!=t.projectId}).forEach(function(e){i.some(function(t){return t.projectId===e.projectId})||o.push(e)}),Blockly.Events.setGroup(!0),o.length){for(var a=h.getAllBlocksWithTilemaps(l),r=function(e){h.deleteTilesetTileIfExists(l,e);for(var t=0,i=a;t<i.length;t++){var o=i[t];if(!o.parsed){var r=o.block.getFieldValue(o.field);o.parsed=pxt.sprite.decodeTilemap(r,"typescript")}var n=o.parsed.tileset.tiles.findIndex(function(t){return t.projectId===e.projectId});-1!=n&&(o.parsed.tileset.tiles.splice(n,1),m(n,o.parsed.tilemap))}},n=0,s=o;n<s.length;n++){r(s[n])}for(var c=0,u=a;c<u.length;c++){var p=u[c];p.parsed&&p.block.setFieldValue(pxt.sprite.encodeTilemap(p.parsed,"typescript"),p.field)}}i.filter(function(t){return void 0!==t.projectId}).forEach(function(t){return h.saveTilesetTile(l,t)}),h.FieldTileset.rebuildTileCache(this.sourceBlock_.workspace,this.blocksInfo);var d=h.getAllTilesetTiles(l);h.getAllBlocksWithTilemaps(l).forEach(function(t){return t.ref.redrawPreview(d)}),Blockly.Events.setGroup(!1)},t.prototype.restoreTilesFromWorkspace=function(t,e){for(var i=e||h.getAllTilesetTiles(this.sourceBlock_.workspace),o=function(e){if(null!=e.projectId){var t=i.find(function(t){return t.projectId===e.projectId});t&&(e.data=t.data)}},r=0,n=t.tileset.tiles;r<n.length;r++){o(n[r])}for(var l=0,a=function(e){l=e.projectId?Math.max(e.projectId,l):l,t.tileset.tiles.some(function(t){return t.projectId===e.projectId})||t.tileset.tiles.push(e)},s=0,c=i;s<c.length;s++){a(c[s])}t.nextId=l+1;var u=pxt.sprite.TILE_NAMESPACE+"."+pxt.sprite.TILE_PREFIX,p=h.getAllBlocksWithTilesets(this.sourceBlock_.workspace);t.projectReferences=p.map(function(t){return t.ref.getValue()}).filter(function(t){return pxt.U.startsWith(t,u)}).map(function(t){return Number(t.substr(u.length))})},t.prototype.getDisplayText_=function(){var t=pxt.Util.htmlUnescape(this.text_);return t.substr(0,t.indexOf("("))+"(...)"},t.prototype.updateEditable=function(){if(this.isGreyBlock&&this.fieldGroup_){var t=this.fieldGroup_;Blockly.utils.dom.removeClass(t,"blocklyNonEditableText"),Blockly.utils.dom.removeClass(t,"blocklyEditableText"),t.style.cursor=""}else r.prototype.updateEditable.call(this)},t}(Blockly.Field);function m(t,e){for(var i=0;i<e.width;i++)for(var o=0;o<e.height;o++){var r=e.get(i,o);r===t?e.set(i,o,0):t<r&&e.set(i,o,r-1)}}h.FieldTilemap=t}(pxtblockly||(pxtblockly={})),function(y){var n=32,t=function(r){function g(t,e,i){var o=r.call(this,t,e,i)||this;return o.isFieldCustom_=!0,o.menuGenerator_=function(){o.transparent||(o.transparent=[{src:function(t){var e=document.createElement("canvas"),i=e.getContext("2d");e.width=t,e.height=t,i.fillStyle="#aeaeae",i.fillRect(0,0,t,t),i.fillStyle="#dedede";for(var o=0;o<t;o+=4)for(var r=0;r<t;r+=4)o+r>>2&1&&i.fillRect(o,r,4,4);return e.toDataURL()}(16),width:n,height:n,alt:pxt.U.lf("transparency")},"myTiles.tile0"]);var t=[o.transparent];if(o.sourceBlock_){var e=y.getAllTilesetTiles(o.sourceBlock_.workspace).filter(function(t){return 0!==t.projectId});t.push.apply(t,e.map(function(t){return[g.getTileImageJSON(t,o.sourceBlock_.workspace,o.blocksInfo),g.getTileKey(t)]}).filter(function(t){return!!t[1]}));var i=g.getGalleryTiles();o.value_&&!t.concat(i).some(function(t){return t[1]===o.value_})&&g.rebuildTileCache(o.sourceBlock_.workspace,o.blocksInfo),t.push.apply(t,g.getGalleryTiles())}return t},o.blocksInfo=e.blocksInfo,t||o.setValue(o.getOptions()[0][1]),o}return __extends(g,r),g.rebuildTileCache=function(t,i){var e=y.getAllTilesetTiles(t);g.tileCache||(g.tileCache={});for(var o=0,r=e;o<r.length;o++){var n=r[o],l=g.getTileKey(n);l&&(g.tileCache[l]=y.bitmapToImageURI(pxt.sprite.Bitmap.fromData(n.data),16,!1))}if(g.galleryTiles=[],i){for(var a=0,s=y.getAllBlocksWithTilemaps(t);a<s.length;a++)for(var c=(n=s[a]).ref.getTileset(),u=function(e){e.qualifiedName&&(g.tileCache[e.qualifiedName]||(g.tileCache[e.qualifiedName]=y.bitmapToImageURI(pxt.sprite.getBitmap(i,e.qualifiedName),c.tileWidth,!1)),g.galleryTiles.some(function(t){return t[1]===e.qualifiedName})||g.galleryTiles.push([g.getTileImageJSON(e,t,i),e.qualifiedName]))},p=0,d=c.tiles;p<d.length;p++){u(d[p])}for(var h=function(e){g.tileCache[e]||(g.tileCache[e]=y.bitmapToImageURI(pxt.sprite.getBitmap(i,e),16,!1)),g.galleryTiles.some(function(t){return t[1]===e})||g.galleryTiles.push([g.getTileImageJSON({qualifiedName:e,data:null},t,i),e])},m=0,f=y.getAllBlocksWithTilesets(t).map(function(t){return t.ref.getValue()}).filter(function(t){return"null"!==t&&!pxt.Util.startsWith(t,pxt.sprite.TILE_NAMESPACE)});m<f.length;m++){h(f[m])}}},g.getTileKey=function(t){return t.qualifiedName?t.qualifiedName:void 0!==t.projectId?pxt.sprite.TILE_NAMESPACE+"."+pxt.sprite.TILE_PREFIX+t.projectId:void 0},g.getTileImage=function(t,e,i){return g.tileCache&&g.tileCache[g.getTileKey(t)]||g.rebuildTileCache(e,i),g.tileCache[g.getTileKey(t)]},g.getTileImageJSON=function(t,e,i){return{src:g.getTileImage(t,e,i),width:n,height:n,alt:g.getTileKey(t).split(".").pop()}},g.getGalleryTiles=function(){return g.galleryTiles||[]},g.prototype.init=function(){(r.prototype.init.call(this),this.sourceBlock_&&this.sourceBlock_.workspace&&!this.sourceBlock_.isInFlyout)&&(y.getAllTilesetTiles(this.sourceBlock_.workspace).some(function(t){return 0===t.projectId})||y.saveTilesetTile(this.sourceBlock_.workspace,{projectId:0,data:new pxt.sprite.Bitmap(16,16).data()}))},g}(y.FieldImages);y.FieldTileset=t}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,void 0,void 0,void 0,i)||this;return o.isFieldCustom_=!0,o.CURSOR="pointer",o.params=e,o.setValue(t),o.addArgType("toggle"),o.type_=e.type,o}return __extends(t,r),t.prototype.init=function(){if(!this.fieldGroup_){this.fieldGroup_=Blockly.utils.dom.createSvgElement("g",{},null),this.visible_||(this.fieldGroup_.style.display="none"),null!==this.getArgTypes()&&(this.sourceBlock_.isShadow()?this.sourceBlock_.svgGroup_.setAttribute("data-argument-type",this.getArgTypes()):this.fieldGroup_.setAttribute("data-argument-type",this.getArgTypes())),!this.sourceBlock_.isShadow()&&this.sourceBlock_.inputList&&1<this.sourceBlock_.inputList.length&&(this.box_=Blockly.utils.dom.createSvgElement("rect",{rx:Blockly.BlockSvg.CORNER_RADIUS,ry:Blockly.BlockSvg.CORNER_RADIUS,x:0,y:0,width:this.size_.width,height:this.size_.height,fill:Blockly.Colours.textField,stroke:this.sourceBlock_.getColourTertiary()},null),this.fieldGroup_.insertBefore(this.box_,this.textElement_));var t=this.getSize();switch(this.checkElement_=Blockly.utils.dom.createSvgElement("g",{class:"blocklyToggle "+(this.state_?"blocklyToggleOn":"blocklyToggleOff"),transform:"translate(8, "+t.height/2+")"},this.fieldGroup_),this.getOutputShape()){case Blockly.OUTPUT_SHAPE_HEXAGONAL:this.toggleThumb_=Blockly.utils.dom.createSvgElement("polygon",{class:"blocklyToggleRect",points:"-7,-14 -21,0 -7,14 7,14 21,0 7,-14",cursor:"pointer"},this.checkElement_);break;case Blockly.OUTPUT_SHAPE_ROUND:this.toggleThumb_=Blockly.utils.dom.createSvgElement("rect",{class:"blocklyToggleCircle",x:-6,y:-14,height:28,width:28,rx:14,ry:14,cursor:"pointer"},this.checkElement_);break;case Blockly.OUTPUT_SHAPE_SQUARE:this.toggleThumb_=Blockly.utils.dom.createSvgElement("rect",{class:"blocklyToggleRect",x:-6,y:-14,height:28,width:28,rx:3,ry:3,cursor:"pointer"},this.checkElement_)}var e=this.sourceBlock_.RTL?-t.width/2:t.width/2;this.textElement_=Blockly.utils.dom.createSvgElement("text",{class:"blocklyText",x:e,dy:"0.6ex",y:t.height/2},this.fieldGroup_),this.updateEditable(),this.sourceBlock_.getSvgRoot().appendChild(this.fieldGroup_),this.switchToggle(this.state_),this.setValue(this.getValue()),this.render_(),this.size_.width=0,this.mouseDownWrapper_=Blockly.bindEventWithChecks_(this.getClickTarget_(),"mousedown",this,this.onMouseDown_)}},t.prototype.getDisplayText_=function(){return this.state_?this.getTrueText():this.getFalseText()},t.prototype.getTrueText=function(){return lf("True")},t.prototype.getFalseText=function(){return lf("False")},t.prototype.updateSize_=function(){this.getInnerWidth();switch(this.getOutputShape()){case Blockly.OUTPUT_SHAPE_ROUND:this.size_.width=2*this.getInnerWidth()-7;break;case Blockly.OUTPUT_SHAPE_HEXAGONAL:this.size_.width=2*this.getInnerWidth()+8-Math.floor(this.getInnerWidth()/2);break;case Blockly.OUTPUT_SHAPE_SQUARE:this.size_.width=9+2*this.getInnerWidth()}this.arrowWidth_=0},t.prototype.getInnerWidth=function(){return 10*this.getMaxLength()},t.prototype.getMaxLength=function(){return Math.max(this.getTrueText().length,this.getFalseText().length)},t.prototype.getOutputShape=function(){return this.sourceBlock_.isShadow()?this.sourceBlock_.getOutputShape():Blockly.OUTPUT_SHAPE_SQUARE},t.prototype.getValue=function(){return this.toVal(this.state_)},t.prototype.setValue=function(t){var e=this.fromVal(t);this.state_!==e&&(this.sourceBlock_&&Blockly.Events.isEnabled()&&Blockly.Events.fire(new Blockly.Events.BlockChange(this.sourceBlock_,"field",this.name,this.state_,e)),this.state_=e,this.switchToggle(this.state_),this.setText(this.getDisplayText_()))},t.prototype.switchToggle=function(t){if(this.checkElement_){this.updateSize_();var e=this.getSize(),i=this.getInnerWidth();t?(pxt.BrowserUtils.addClass(this.checkElement_,"blocklyToggleOn"),pxt.BrowserUtils.removeClass(this.checkElement_,"blocklyToggleOff")):(pxt.BrowserUtils.removeClass(this.checkElement_,"blocklyToggleOn"),pxt.BrowserUtils.addClass(this.checkElement_,"blocklyToggleOff"));var o=this.getOutputShape(),r=0,n=0,l=0,a=0;switch(o){case Blockly.OUTPUT_SHAPE_HEXAGONAL:var s=(n=(r=i)/2)/2;l=3<this.getMaxLength()?-4:1;var c=a=-s,u=s;this.toggleThumb_.setAttribute("points",c+",-14 "+(c-14)+",0 "+c+",14 "+u+",14 "+(u+14)+",0 "+u+",-14");break;case Blockly.OUTPUT_SHAPE_ROUND:case Blockly.OUTPUT_SHAPE_SQUARE:n=(r=5+i)/2,this.toggleThumb_.setAttribute("width",""+r),this.toggleThumb_.setAttribute("x","-"+n),l=a=o==Blockly.OUTPUT_SHAPE_SQUARE?2:-6}this.checkElement_.setAttribute("transform","translate("+(t?a+i+n:n+l)+", "+e.height/2+")")}},t.prototype.updateTextNode_=function(){r.prototype.updateTextNode_.call(this),this.textElement_&&pxt.BrowserUtils.addClass(this.textElement_,"blocklyToggleText")},t.prototype.render_=function(){if(this.visible_&&this.textElement_){goog.dom.removeChildren(this.textElement_);var t=document.createTextNode(this.getDisplayText_());this.textElement_.appendChild(t),pxt.BrowserUtils.addClass(this.textElement_,"blocklyToggleText"),this.updateSize_();var e=this.size_.width/2,i=(this.state_?e+e/2:e/2)-Blockly.Field.getCachedWidth(this.textElement_)/2;this.textElement_.setAttribute("x",""+i)}this.box_&&(this.box_.setAttribute("width",""+this.size_.width),this.box_.setAttribute("height",""+this.size_.height))},t.prototype.showEditor_=function(){var t=!this.state_;null!==t&&this.setValue(this.toVal(t))},t.prototype.toVal=function(t){return"number"==this.type_?String(t?"1":"0"):String(t?"true":"false")},t.prototype.fromVal=function(t){return"string"==typeof t?"1"==t||"TRUE"==t.toUpperCase():!!t},t}(Blockly.FieldNumber);t.FieldToggle=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,e,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t.prototype.getTrueText=function(){return lf("HIGH")},t.prototype.getFalseText=function(){return lf("LOW")},t}(t.FieldToggle);t.FieldToggleHighLow=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,e,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t.prototype.getTrueText=function(){return lf("ON")},t.prototype.getFalseText=function(){return lf("OFF")},t}(t.FieldToggle);t.FieldToggleOnOff=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,e,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t.prototype.getTrueText=function(){return lf("UP")},t.prototype.getFalseText=function(){return lf("DOWN")},t}(t.FieldToggle);t.FieldToggleUpDown=e;var i=function(r){function t(t,e,i){var o=r.call(this,t,e,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t.prototype.getTrueText=function(){return lf("DOWN")},t.prototype.getFalseText=function(){return lf("UP")},t}(t.FieldToggle);t.FieldToggleDownUp=i}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,e,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t.prototype.getTrueText=function(){return lf("WIN")},t.prototype.getFalseText=function(){return lf("LOSE")},t}(t.FieldToggle);t.FieldToggleWinLose=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function t(t,e,i){var o=r.call(this,t,e,i)||this;return o.isFieldCustom_=!0,o}return __extends(t,r),t.prototype.getTrueText=function(){return lf("Yes")},t.prototype.getFalseText=function(){return lf("No")},t}(t.FieldToggle);t.FieldToggleYesNo=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.isFieldCustom_=!0,t}return __extends(t,e),t.prototype.updateEditable=function(){var t=this.fieldGroup_;this.EDITABLE&&t&&(this.sourceBlock_.isEditable()?(pxt.BrowserUtils.addClass(t,"blocklyEditableText"),pxt.BrowserUtils.removeClass(t,"blocklyGreyExpressionBlockText"),this.fieldGroup_.style.cursor=this.CURSOR):(pxt.BrowserUtils.addClass(t,"blocklyGreyExpressionBlockText"),pxt.BrowserUtils.removeClass(t,"blocklyEditableText"),this.fieldGroup_.style.cursor=""))},t}(Blockly.FieldTextInput);t.FieldTsExpression=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(r){function h(t,e,i){var o=r.call(this,String(t),"-200","200","1","10","TurnRatio",i)||this;return o.isFieldCustom_=!0,o.params=e,o.sliderColor_="#a8aaa8",o}return __extends(h,r),h.prototype.createLabelDom_=function(t){var e=document.createElement("div"),i=Blockly.utils.dom.createSvgElement("svg",{xmlns:"http://www.w3.org/2000/svg","xmlns:html":"http://www.w3.org/1999/xhtml","xmlns:xlink":"http://www.w3.org/1999/xlink",version:"1.1",height:h.HALF+h.HANDLE_RADIUS+10+"px",width:2*h.HALF+"px"},e),o=Blockly.utils.dom.createSvgElement("defs",{},i),r=Blockly.utils.dom.createSvgElement("marker",{id:"head",orient:"auto",markerWidth:"2",markerHeight:"4",refX:"0.1",refY:"1.5"},o);Blockly.utils.dom.createSvgElement("path",{d:"M0,0 V3 L1.5,1.5 Z",fill:"#f12a21"},r);this.reporter_=pxsim.svg.child(i,"text",{x:h.HALF,y:96,"text-anchor":"middle","dominant-baseline":"middle",style:"font-size: 50px",class:"sim-text inverted number"}),this.path_=Blockly.utils.dom.createSvgElement("path",{x1:h.HALF,y1:h.HALF,"marker-end":"url(#head)",style:"fill: none; stroke: #f12a21; stroke-width: 10"},i),this.updateGraph_();var n=document.createElement("span");return n.setAttribute("class","blocklyFieldSliderReadout"),[e,n]},h.prototype.updateGraph_=function(){if(this.path_){var t=goog.math.clamp(this.getValue()||0,-200,200),e=t/100,i=Math.max(-1,Math.min(1,e)),o=Math.max(i)*Math.PI/2,r=h.RADIUS-6,n=h.HALF,l=h.HALF-22;1<Math.abs(e)&&(n-=(e-(0<e?1:-1))*r/2);var a=.2+.5*Math.abs(i),s=r*a,c=r*Math.sin(Math.PI/2-o),u=r*Math.cos(Math.PI/2-o),p=c-r*a*Math.cos(2*o),d="M "+n+" "+l+" C "+n+" "+(l-s)+" "+(n+(u-r*a*Math.sin(2*o)))+" "+(l-p)+" "+(n+u)+" "+(l-c);this.path_.setAttribute("d",d),this.reporter_.textContent=""+t}},h.prototype.setReadout_=function(t,e){this.updateGraph_()},h.RADIUS=(h.HALF=80)-(h.HANDLE_RADIUS=30)-1,h}(Blockly.FieldSlider);t.FieldTurnRatio=e}(pxtblockly||(pxtblockly={})),function(t){var e=function(o){function t(t){var e,i=o.call(this,(e=t,function(){var i=[];if(this.sourceBlock_&&this.sourceBlock_.workspace){var t=this.sourceBlock_.workspace.getVariablesOfType(e.name);t.forEach(function(t){var e=t.name.replace(/^\d+/,"");i.push([e,t.name])})}return i.push([lf("Add a new {0}...",e.memberName),"CREATE"]),i}))||this;return i.opts=t,i}return __extends(t,o),t.prototype.init=function(){o.prototype.init.call(this),this.initVariables()},t.prototype.onItemSelected=function(t,e){var i=this;"CREATE"===e.getValue()?function l(a,s,c,u){Blockly.prompt(c,s.promptHint,function(t){if(t){var e=!1;if(pxtc.isIdentifierStart(t.charCodeAt(0),2)){e=!0;for(var i=1;i<t.length;i++)pxtc.isIdentifierPart(t.charCodeAt(i),2)||(e=!1)}if(!e)return void Blockly.alert(lf("Names must start with a letter and can only contain letters, numbers, '$', and '_'."),function(){return l(a,s,c,u)});for(var o=p(a,s.name),i=0;i<o.length;i++){var r=o[i],n=r[0];r[1];if(n===t)return void Blockly.alert(lf("A {0} named '{1}' already exists.",s.memberName,t),function(){return l(a,s,c,u)})}u(d(a,s,t))}})}(this.sourceBlock_.workspace,this.opts,lf("New {0}:",this.opts.memberName),function(t){return t&&i.setValue(t)}):o.prototype.onItemSelected.call(this,t,e)},t.prototype.initVariables=function(){var t=this;if(this.sourceBlock_&&this.sourceBlock_.workspace)if(this.sourceBlock_.isInFlyout)this.setText(this.opts.initialMembers[0]);else{var e=this.sourceBlock_.workspace,o=p(e,this.opts.name);if(this.opts.initialMembers.forEach(function(i){o.some(function(t){var e=t[0];t[1];return e===i})||d(e,t.opts,i)}),"CREATE"===this.getValue()){var i=function(t,e,i){var o=t.getVariablesOfType(e);if(o&&o.length)for(var r=0;r<o.length;r++){var n=l(o[r])[0];if(n===i)return o[r].name}return}(e,this.opts.name,this.opts.initialMembers[0]);i&&this.setValue(i)}}},t}(Blockly.FieldDropdown);function l(t){var e=/^(\d+)([^0-9].*)$/.exec(t.name);return e?[e[2],parseInt(e[1])]:[t.name,-1]}function p(t,e){var i=t.getVariablesOfType(e);return i&&i.length?i.map(l):[]}function r(t,e){var i=t.map(function(t){t[0];return t[1]});if(e.isBitMask){for(var o=0;o<i.length;o++){var r=1<<o;if(i.indexOf(r)<0)return r}return 1<<i.length}if(e.isHash)return 0;var n=e.firstValue||0;for(o=0;o<i.length;o++)if(i.indexOf(n+o)<0)return n+o;return n+i.length}function d(t,e,i){var o=r(p(t,e.name),e)+i;return Blockly.Variables.getOrCreateVariablePackage(t,null,o,e.name),o}t.FieldUserEnum=e,t.getNextValue=r}(pxtblockly||(pxtblockly={})),function(e){var t;function i(t,e){for(var i=0,o=t.getVariablesOfType(pxt.sprite.BLOCKLY_TILESET_TYPE);i<o.length;i++){var r=o[i];if(parseInt(r.name.substr(0,r.name.indexOf(";")))===e.projectId){t.deleteVariableById(r.getId());break}}}function o(t,s){var c=[];return t.getTopBlocks(!1).forEach(function(t){return function t(e){for(var i=0,o=e.inputList;i<o.length;i++){for(var r=o[i],n=0,l=r.fieldRow;n<l.length;n++){var a=l[n];s(a)&&c.push({block:e,field:a.name,ref:a})}r.connection&&r.connection.targetBlock()&&t(r.connection.targetBlock())}e.nextConnection&&e.nextConnection.targetBlock()&&t(e.nextConnection.targetBlock())}(t)}),c}(t=e.svg||(e.svg={})).hasClass=function(t,e){return pxt.BrowserUtils.containsClass(t,e)},t.addClass=function(t,e){pxt.BrowserUtils.addClass(t,e)},t.removeClass=function(t,e){pxt.BrowserUtils.removeClass(t,e)},e.parseColour=function(t){var e=Number(t);return isNaN(e)?goog.isString(t)&&t.match(/^#[0-9a-fA-F]{6}$/)?t:"#000":Blockly.hueToRgb(e)},e.bitmapToImageURI=function(t,e,i){var o=pxt.appTarget.runtime.palette.slice(1),r=document.createElement("canvas");r.width=e,r.height=e;var n,l=Math.min(e/t.width,e/t.height),a=Math.max(Math.floor(e*(1-t.width/t.height)/2),0),s=Math.max(Math.floor(e*(1-t.height/t.width)/2),0);i?((n=r.getContext("2d",{alpha:!1})).fillStyle="#dedede",n.fillRect(0,0,e,e)):n=r.getContext("2d");for(var c=0;c<t.width;c++)for(var u=0;u<t.height;u++){var p=t.get(c,u);p?(n.fillStyle=o[p-1],n.fillRect(a+c*l,s+u*l,l,l)):i&&(n.fillStyle="#dedede",n.fillRect(a+c*l,s+u*l,l,l))}return r.toDataURL()},e.tilemapToImageURI=function(t,e,i,o){var r=pxt.appTarget.runtime.palette.slice(),n=document.createElement("canvas");n.width=e,n.height=e;var l,a=Math.min(e/t.tilemap.width,e/t.tilemap.height),s=Math.max(Math.floor(e*(1-t.tilemap.width/t.tilemap.height)/2),0),c=Math.max(Math.floor(e*(1-t.tilemap.height/t.tilemap.width)/2),0);i?((l=n.getContext("2d",{alpha:!1})).fillStyle="#dedede",l.fillRect(0,0,e,e)):l=n.getContext("2d");for(var u=[],p=0;p<t.tilemap.width;p++)for(var d=0;d<t.tilemap.height;d++){var h=t.tilemap.get(p,d);if(h){if(!u[h]){var m=t.tileset.tiles[h];if(m.data)u[h]=pxt.sprite.computeAverageColor(pxt.sprite.Bitmap.fromData(m.data),r);else{var f=pxt.sprite.getBitmap(o,m.qualifiedName);u[h]=f?pxt.sprite.computeAverageColor(f,r):"#ffffff"}}l.fillStyle=u[h],l.fillRect(s+p*a,c+d*a,a,a)}else i&&(l.fillStyle="#dedede",l.fillRect(s+p*a,c+d*a,a,a))}return n.toDataURL()},e.saveTilesetTile=function(t,e){i(t,e),t.createVariable(pxt.sprite.tileToBlocklyVariable(e),pxt.sprite.BLOCKLY_TILESET_TYPE)},e.deleteTilesetTileIfExists=i,e.getAllTilesetTiles=function(t){return t.getVariablesOfType(pxt.sprite.BLOCKLY_TILESET_TYPE).map(function(t){return pxt.sprite.blocklyVariableToTile(t.name)})},e.getAllBlocksWithTilemaps=function(t){return o(t,function(t){return t instanceof e.FieldTilemap&&!t.isGreyBlock})},e.getAllBlocksWithTilesets=function(t){return o(t,function(t){return t instanceof e.FieldTileset})}}(pxtblockly||(pxtblockly={}));